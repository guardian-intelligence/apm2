# Fast GitHub-hosted trust gate for FAC projection.
# This workflow is the first required branch-protection context and must
# fail closed before any privileged self-hosted execution path is considered.

name: Guardian Intelligence - Barrier

on:
  pull_request_target:
    branches: [main]
    types: [opened, reopened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to validate"
        required: true
        type: string

concurrency:
  group: guardian-intelligence-barrier-${{ github.event_name == 'pull_request_target' && github.event.pull_request.number || github.event.inputs.pr_number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read
  statuses: write

env:
  CARGO_TERM_COLOR: always

jobs:
  barrier-preflight:
    name: Barrier Preflight
    runs-on: ubuntu-24.04
    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      head_sha: ${{ steps.pr.outputs.head_sha }}
      base_ref: ${{ steps.pr.outputs.base_ref }}
      default_branch: ${{ steps.pr.outputs.default_branch }}
      author_login: ${{ steps.pr.outputs.author_login }}
      author_assoc: ${{ steps.pr.outputs.author_assoc }}

    steps:
      - name: Resolve PR context
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
            echo "head_sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            echo "base_ref=${{ github.event.pull_request.base.ref }}" >> "$GITHUB_OUTPUT"
            echo "default_branch=${{ github.event.repository.default_branch }}" >> "$GITHUB_OUTPUT"
            echo "author_login=${{ github.event.pull_request.user.login }}" >> "$GITHUB_OUTPUT"
            echo "author_assoc=${{ github.event.pull_request.author_association }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PR_NUMBER='${{ github.event.inputs.pr_number }}'
          if [[ -z "${PR_NUMBER}" ]] || ! [[ "${PR_NUMBER}" =~ ^[0-9]+$ ]]; then
            echo "::error::workflow_dispatch requires numeric input `pr_number`"
            exit 1
          fi

          PR_JSON=$(gh api "/repos/${{ github.repository }}/pulls/${PR_NUMBER}")
          DEFAULT_BRANCH=$(gh api "/repos/${{ github.repository }}" --jq '.default_branch')

          echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "head_sha=$(jq -r '.head.sha' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"
          echo "base_ref=$(jq -r '.base.ref' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"
          echo "default_branch=${DEFAULT_BRANCH}" >> "$GITHUB_OUTPUT"
          echo "author_login=$(jq -r '.user.login' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"
          echo "author_assoc=$(jq -r '.author_association' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"

      - name: Authorize PR author identity (fail closed)
        run: |
          set -euo pipefail

          AUTHOR_LOGIN='${{ steps.pr.outputs.author_login }}'
          AUTHOR_ASSOC='${{ steps.pr.outputs.author_assoc }}'
          case "${AUTHOR_ASSOC}" in
            OWNER|MEMBER|COLLABORATOR)
              echo "Authorized PR author: ${AUTHOR_LOGIN} (${AUTHOR_ASSOC})"
              ;;
            *)
              echo "::error::Unauthorized PR author identity: ${AUTHOR_LOGIN} (${AUTHOR_ASSOC})"
              exit 1
              ;;
          esac

      - name: Authorize manual dispatch actor (write+ required)
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          ACTOR='${{ github.actor }}'
          PERMISSION=$(gh api "/repos/${{ github.repository }}/collaborators/${ACTOR}/permission" --jq '.permission' 2>/dev/null || true)
          case "${PERMISSION}" in
            admin|maintain|write)
              echo "Authorized dispatch actor: ${ACTOR} (${PERMISSION})"
              ;;
            *)
              echo "::error::workflow_dispatch actor '${ACTOR}' lacks required repository permission (need write|maintain|admin)."
              exit 1
              ;;
          esac

      - name: Guard trusted dispatch ref
        if: github.event_name == 'workflow_dispatch'
        run: |
          set -euo pipefail

          DISPATCH_REF='${{ github.ref_name }}'
          BASE_REF='${{ steps.pr.outputs.base_ref }}'
          DEFAULT_BRANCH='${{ steps.pr.outputs.default_branch }}'

          if [[ "${DISPATCH_REF}" != "${BASE_REF}" && "${DISPATCH_REF}" != "${DEFAULT_BRANCH}" ]]; then
            echo "::error::workflow_dispatch ref '${DISPATCH_REF}' is not trusted for PR base '${BASE_REF}' (default '${DEFAULT_BRANCH}')."
            exit 1
          fi

  barrier-status:
    name: Guardian Intelligence - Barrier
    needs: [barrier-preflight]
    if: always()
    runs-on: ubuntu-24.04

    steps:
      - name: Resolve PR head SHA for status projection
        id: head
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            echo "sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PR_NUMBER='${{ needs.barrier-preflight.outputs.pr_number || github.event.inputs.pr_number }}'
          if [[ -z "${PR_NUMBER}" ]] || ! [[ "${PR_NUMBER}" =~ ^[0-9]+$ ]]; then
            echo "::error::Cannot resolve PR head SHA: missing numeric PR number"
            exit 1
          fi

          HEAD_SHA=$(gh api "/repos/${{ github.repository }}/pulls/${PR_NUMBER}" --jq '.head.sha')
          if [[ -z "${HEAD_SHA}" ]]; then
            echo "::error::Cannot resolve PR head SHA for PR #${PR_NUMBER}"
            exit 1
          fi
          echo "sha=${HEAD_SHA}" >> "$GITHUB_OUTPUT"

      - name: Determine projected status
        id: status
        run: |
          set -euo pipefail

          if [[ "${{ needs.barrier-preflight.result }}" == "success" ]]; then
            echo "state=success" >> "$GITHUB_OUTPUT"
            echo "description=Barrier checks passed" >> "$GITHUB_OUTPUT"
          else
            echo "state=failure" >> "$GITHUB_OUTPUT"
            echo "description=Barrier checks failed" >> "$GITHUB_OUTPUT"
          fi

      - name: Post barrier status to PR head
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          gh api --method POST "/repos/${{ github.repository }}/statuses/${{ steps.head.outputs.sha }}" \
            -f state="${{ steps.status.outputs.state }}" \
            -f context="Guardian Intelligence - Barrier" \
            -f description="${{ steps.status.outputs.description }}"

      - name: Fail workflow when barrier is not success
        if: steps.status.outputs.state != 'success'
        run: |
          set -euo pipefail
          echo "::error::${{ steps.status.outputs.description }}"
          exit 1

name: Forge Admission Cycle

on:
  workflow_run:
    workflows: ["Forge Admission Barrier"]
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to process"
        required: true
        type: string

concurrency:
  group: forge-admission-cycle-${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.event.inputs.pr_number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: -D warnings
  RUST_BACKTRACE: 1

jobs:
  dispatch-auth:
    name: Guardian Intelligence / Dispatch Auth
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
      - name: Validate workflow_dispatch trust boundary (fast path)
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          fail() {
            echo "dispatch-auth: $1" >&2
            exit 1
          }

          repo="$GITHUB_REPOSITORY"
          actor="$GITHUB_ACTOR"
          pr_number="$(jq -r '.inputs.pr_number // .client_payload.pr_number // empty' "$GITHUB_EVENT_PATH")"
          [[ -n "$pr_number" ]] || fail "workflow_dispatch requires inputs.pr_number"

          pr_json="$(gh api "repos/$repo/pulls/$pr_number")" || fail "failed to load PR #$pr_number"
          base_ref="$(jq -r '.base.ref // empty' <<<"$pr_json")"
          [[ -n "$base_ref" ]] || fail "PR #$pr_number missing base.ref"

          default_branch="$(gh api "repos/$repo" --jq '.default_branch')"
          dispatch_ref="${GITHUB_REF_NAME:-}"
          [[ -n "$dispatch_ref" ]] || fail "missing GITHUB_REF_NAME for workflow_dispatch"
          if [[ "$dispatch_ref" != "$base_ref" && "$dispatch_ref" != "$default_branch" ]]; then
            fail "workflow_dispatch ref=$dispatch_ref is not trusted (base=$base_ref default=$default_branch)"
          fi

          permission="$(gh api "repos/$repo/collaborators/$actor/permission" --jq '.permission // empty' 2>/dev/null || true)"
          case "$permission" in
            admin|maintain|write) ;;
            *)
              fail "workflow_dispatch actor=$actor lacks permission (need write|maintain|admin, got ${permission:-none})"
              ;;
          esac
          echo "dispatch-auth: authorized workflow_dispatch pr=$pr_number ref=$dispatch_ref actor_permission=$permission"

  forge-admission-cycle:
    name: apm2 / Forge Admission Cycle
    needs: [dispatch-auth]
    if: >
      ${{
        always() &&
        (
          (github.event_name == 'workflow_run' &&
           github.event.workflow_run.conclusion == 'success' &&
           github.event.workflow_run.event == 'pull_request_target') ||
          (github.event_name == 'workflow_dispatch' &&
           needs.dispatch-auth.result == 'success')
        )
      }}
    runs-on: [self-hosted, linux, x64, fac-ovh]
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          toolchain: stable

      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2

      - name: Resolve PR context
        id: pr-context
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            head_sha="${{ github.event.workflow_run.head_sha }}"
            pr_number="$(gh api "repos/${{ github.repository }}/commits/${head_sha}/pulls" --jq '.[0].number' 2>/dev/null || echo '')"
            if [[ -z "$pr_number" || "$pr_number" == "null" ]]; then
              echo "ERROR: could not resolve PR number from commit ${head_sha}" >&2
              exit 1
            fi
            event_name="pull_request_target"
          else
            pr_number="${{ github.event.inputs.pr_number }}"
            head_sha="${{ github.sha }}"
            event_name="workflow_dispatch"
          fi
          echo "pr_number=${pr_number}" >> "$GITHUB_OUTPUT"
          echo "head_sha=${head_sha}" >> "$GITHUB_OUTPUT"
          echo "event_name=${event_name}" >> "$GITHUB_OUTPUT"
          echo "fac-context: pr=${pr_number} sha=${head_sha} event=${event_name}"

      - name: Synthesize event payload
        id: event-payload
        run: |
          set -euo pipefail
          event_file="$(mktemp)"
          if [[ "${{ steps.pr-context.outputs.event_name }}" == "pull_request_target" ]]; then
            # Build a minimal pull_request_target event payload for fac kickoff
            gh api "repos/${{ github.repository }}/pulls/${{ steps.pr-context.outputs.pr_number }}" \
              | jq '{pull_request: .}' > "${event_file}"
          else
            # Use the original event payload for workflow_dispatch
            cp "${{ github.event_path }}" "${event_file}"
          fi
          echo "path=${event_file}" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Kick off FAC and project health
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          # SECURITY-CRITICAL LOGGING BOUNDARY:
          # GitHub Actions logs are a public projection surface. Treat stdout as
          # untrusted egress and fail closed if any non-health line appears.
          private_log_dir="${HOME}/.apm2/private/fac"
          mkdir -p "${private_log_dir}"
          chmod 700 "${private_log_dir}"
          private_log="${private_log_dir}/github-run-${GITHUB_RUN_ID:-unknown}-${GITHUB_RUN_ATTEMPT:-0}.log"
          : >"${private_log}"
          chmod 600 "${private_log}"

          health_line_re='^ts=[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z sha=[^[:space:]]+ current_head_sha=[^[:space:]]+ security=[^[:space:]]+ quality=[^[:space:]]+ events=.*$'
          evidence_line_re='^ts=[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z sha=[^[:space:]]+ gate=[^[:space:]]+ status=(PASS|FAIL) duration_secs=[0-9]+ log=[^[:space:]]+.*$'
          terminal_line_re='^ts=[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z sha=[^[:space:]]+ terminal=(success|failure).*$'

          set +e
          cargo run --locked --quiet -p apm2-cli -- fac kickoff \
            --repo "${{ github.repository }}" \
            --event "${{ steps.event-payload.outputs.path }}" \
            --event-name "${{ steps.pr-context.outputs.event_name }}" \
            --max-wait-seconds 3600 \
            --public-projection-only \
            2>>"${private_log}" | \
            awk -v health_line_re="${health_line_re}" \
                -v evidence_line_re="${evidence_line_re}" \
                -v terminal_line_re="${terminal_line_re}" '
              $0 ~ terminal_line_re {
                print $0
                fflush(stdout)
                if ($0 ~ /terminal=success/) exit 0
                exit 1
              }
              $0 ~ health_line_re {
                print $0
                fflush(stdout)
                next
              }
              $0 ~ evidence_line_re {
                print $0
                fflush(stdout)
                next
              }
              {
                # SECURITY-CRITICAL: never echo rejected lines (possible secret egress).
                print "ERROR: FAC output boundary violation (non-health line blocked)." > "/dev/stderr"
                exit 42
              }
            '
          pipe_status=("${PIPESTATUS[@]}")
          fac_rc="${pipe_status[0]:-1}"
          filter_rc="${pipe_status[1]:-1}"
          set -e

          if [[ "${filter_rc}" -ne 0 ]]; then
            echo "ERROR: FAC projection boundary violation. See private runner log: ${private_log}" >&2
            exit 1
          fi
          if [[ "${fac_rc}" -ne 0 ]]; then
            echo "ERROR: FAC failed. See private runner log: ${private_log}" >&2
            exit "${fac_rc}"
          fi

      - name: Clean up build artifacts
        if: always()
        run: |
          cargo clean 2>/dev/null || true
          rm -rf target/ci target/fac_check_receipts 2>/dev/null || true
          # Rotate old projection logs (keep last 7 days)
          find "${HOME}/.apm2/projection/" -name "*.log" -mtime +7 -delete 2>/dev/null || true

# Unified FAC-first AI review projection workflow.
# Runs trusted base-branch workflow logic (`pull_request_target`) and treats
# GitHub as a projection surface over VPS-executed FAC review agents.

name: AI Review

on:
  pull_request_target:
    branches: [main]
    types: [opened, reopened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to dispatch/project"
        required: true
        type: string
      review_type:
        description: "Review stream to dispatch"
        required: true
        type: choice
        default: all
        options:
          - all
          - security
          - quality
      projection_seconds:
        description: "Seconds to stream 1Hz projection logs"
        required: true
        type: string
        default: "30"

concurrency:
  group: ai-review-${{ github.event_name == 'pull_request_target' && github.event.pull_request.number || github.event.inputs.pr_number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: -D warnings
  RUST_BACKTRACE: 1

jobs:
  auth-preflight:
    name: FAC Auth Preflight
    runs-on: ubuntu-24.04
    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      pr_url: ${{ steps.pr.outputs.pr_url }}
      head_sha: ${{ steps.pr.outputs.head_sha }}
      base_ref: ${{ steps.pr.outputs.base_ref }}
      checkout_ref: ${{ steps.pr.outputs.checkout_ref }}
      review_type: ${{ steps.pr.outputs.review_type }}
      projection_seconds: ${{ steps.pr.outputs.projection_seconds }}

    steps:
      - name: Resolve PR context
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
            echo "pr_url=${{ github.event.pull_request.html_url }}" >> "$GITHUB_OUTPUT"
            echo "head_sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            echo "base_ref=${{ github.event.pull_request.base.ref }}" >> "$GITHUB_OUTPUT"
            echo "checkout_ref=${{ github.event.pull_request.base.ref }}" >> "$GITHUB_OUTPUT"
            echo "author_login=${{ github.event.pull_request.user.login }}" >> "$GITHUB_OUTPUT"
            echo "author_assoc=${{ github.event.pull_request.author_association }}" >> "$GITHUB_OUTPUT"
            echo "review_type=all" >> "$GITHUB_OUTPUT"
            echo "projection_seconds=30" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PR_NUMBER='${{ github.event.inputs.pr_number }}'
          if [[ -z "${PR_NUMBER}" ]] || ! [[ "${PR_NUMBER}" =~ ^[0-9]+$ ]]; then
            echo "::error::workflow_dispatch requires numeric input `pr_number`"
            exit 1
          fi
          PR_JSON=$(gh api "/repos/${{ github.repository }}/pulls/${PR_NUMBER}")
          echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "pr_url=$(jq -r '.html_url' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"
          echo "head_sha=$(jq -r '.head.sha' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"
          echo "base_ref=$(jq -r '.base.ref' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"
          echo "checkout_ref=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          echo "author_login=$(jq -r '.user.login' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"
          echo "author_assoc=$(jq -r '.author_association' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"

          REVIEW_TYPE='${{ github.event.inputs.review_type }}'
          if [[ -z "${REVIEW_TYPE}" ]]; then
            REVIEW_TYPE="all"
          fi
          case "${REVIEW_TYPE}" in
            all|security|quality)
              ;;
            *)
              echo "::error::Invalid review_type=${REVIEW_TYPE}. Expected one of: all, security, quality."
              exit 1
              ;;
          esac
          echo "review_type=${REVIEW_TYPE}" >> "$GITHUB_OUTPUT"

          PROJECTION_SECONDS='${{ github.event.inputs.projection_seconds }}'
          if [[ -z "${PROJECTION_SECONDS}" ]]; then
            PROJECTION_SECONDS="30"
          fi
          if ! [[ "${PROJECTION_SECONDS}" =~ ^[0-9]+$ ]]; then
            echo "::error::projection_seconds must be numeric."
            exit 1
          fi
          if [[ "${PROJECTION_SECONDS}" -lt 5 || "${PROJECTION_SECONDS}" -gt 600 ]]; then
            echo "::error::projection_seconds must be between 5 and 600."
            exit 1
          fi
          echo "projection_seconds=${PROJECTION_SECONDS}" >> "$GITHUB_OUTPUT"

      - name: Authorize PR author identity (fail closed)
        run: |
          set -euo pipefail
          AUTHOR_LOGIN='${{ steps.pr.outputs.author_login }}'
          AUTHOR_ASSOC='${{ steps.pr.outputs.author_assoc }}'
          case "${AUTHOR_ASSOC}" in
            OWNER|MEMBER|COLLABORATOR)
              echo "Authorized PR author: ${AUTHOR_LOGIN} (${AUTHOR_ASSOC})"
              ;;
            *)
              echo "::error::Unauthorized PR author identity: ${AUTHOR_LOGIN} (${AUTHOR_ASSOC})"
              exit 1
              ;;
          esac

      - name: Checkout trusted base-branch policy
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ steps.pr.outputs.base_ref }}

      - name: Validate reviewer identity is allowlisted
        env:
          REVIEW_BOT_TOKEN: ${{ secrets.AUTO_APPROVE_PAT }}
        run: |
          set -euo pipefail

          if [[ -z "${REVIEW_BOT_TOKEN:-}" ]]; then
            echo "::error::Missing required secret AUTO_APPROVE_PAT."
            exit 1
          fi

          BOT_LOGIN=$(GH_TOKEN="${REVIEW_BOT_TOKEN}" gh api user --jq '.login')
          echo "Using reviewer login: ${BOT_LOGIN}"

          jq -e --arg login "$BOT_LOGIN" \
            '[.reviewers.security[].github_logins[] | ascii_downcase] | index($login|ascii_downcase) != null' \
            .github/review-gate/trusted-reviewers.json >/dev/null

          jq -e --arg login "$BOT_LOGIN" \
            '[.reviewers.code_quality[].github_logins[] | ascii_downcase] | index($login|ascii_downcase) != null' \
            .github/review-gate/trusted-reviewers.json >/dev/null

      - name: Emit manual recovery commands
        run: |
          set -euo pipefail
          PR_NUMBER='${{ steps.pr.outputs.pr_number }}'
          echo "Manual retrigger (all):      gh workflow run ai-review.yml --repo ${{ github.repository }} -f pr_number=${PR_NUMBER} -f review_type=all -f projection_seconds=30"
          echo "Manual retrigger (security): gh workflow run ai-review.yml --repo ${{ github.repository }} -f pr_number=${PR_NUMBER} -f review_type=security -f projection_seconds=30"
          echo "Manual retrigger (quality):  gh workflow run ai-review.yml --repo ${{ github.repository }} -f pr_number=${PR_NUMBER} -f review_type=quality -f projection_seconds=30"
          echo "Manual gate re-eval:         gh workflow run review-gate.yml --repo ${{ github.repository }} -f pr_number=${PR_NUMBER}"

  fac-review:
    name: FAC Review Projection
    needs: [auth-preflight]
    if: needs.auth-preflight.result == 'success'
    runs-on: [self-hosted, linux, x64, fac-ovh]
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      # pull_request_target executes workflow code from base-branch context.
      - name: Checkout trusted base branch code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ needs.auth-preflight.outputs.checkout_ref }}

      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          toolchain: stable

      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2

      - name: Add Cargo bin to PATH
        run: |
          if [[ -n "${CARGO_HOME:-}" ]]; then
            echo "${CARGO_HOME}/bin" >> "$GITHUB_PATH"
          else
            echo "${HOME}/.cargo/bin" >> "$GITHUB_PATH"
          fi

      - name: Build apm2 CLI
        run: cargo build --locked -p apm2-cli

      - name: Dispatch FAC reviewers (idempotent start-or-join)
        id: dispatch
        env:
          GH_TOKEN: ${{ secrets.AUTO_APPROVE_PAT }}
        run: |
          set -euo pipefail

          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "::error::Missing required secret AUTO_APPROVE_PAT (authoritative reviewer identity token)."
            exit 1
          fi

          if ! gh auth status >/dev/null 2>&1; then
            echo "::error::No gh authentication available on runner; detached reviewers cannot access GitHub APIs."
            exit 1
          fi

          FAC_BIN="${PWD}/target/debug/apm2"
          PR_URL='${{ needs.auth-preflight.outputs.pr_url }}'
          HEAD_SHA='${{ needs.auth-preflight.outputs.head_sha }}'
          REVIEW_TYPE='${{ needs.auth-preflight.outputs.review_type }}'

          DISPATCH_JSON=$("${FAC_BIN}" fac --json review dispatch "${PR_URL}" --type "${REVIEW_TYPE}" --expected-head-sha "${HEAD_SHA}")
          echo "dispatch_json<<EOF" >> "$GITHUB_OUTPUT"
          echo "$DISPATCH_JSON" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          DISPATCH_EPOCH=$(jq -r '.dispatch_epoch // 0' <<<"${DISPATCH_JSON}")
          if [[ "${DISPATCH_EPOCH}" == "0" ]]; then
            echo "::error::FAC dispatch did not return a valid dispatch_epoch"
            exit 1
          fi
          echo "dispatch_epoch=${DISPATCH_EPOCH}" >> "$GITHUB_OUTPUT"

          jq -r '.results[] | "dispatch review_type=\(.review_type) mode=\(.mode)" +
            (if .unit then " unit=\(.unit)" else "" end) +
            (if .pid then " pid=\(.pid|tostring)" else "" end)' <<<"${DISPATCH_JSON}"

      - name: Project 1Hz reviewer health window
        run: |
          set -euo pipefail

          FAC_BIN="${PWD}/target/debug/apm2"
          PR_NUMBER='${{ needs.auth-preflight.outputs.pr_number }}'
          HEAD_SHA='${{ needs.auth-preflight.outputs.head_sha }}'
          DISPATCH_EPOCH='${{ steps.dispatch.outputs.dispatch_epoch }}'
          PROJECTION_SECONDS='${{ needs.auth-preflight.outputs.projection_seconds }}'

          terminal_failure=0
          after_seq=0

          for _ in $(seq 1 "${PROJECTION_SECONDS}"); do
            PROJECT_JSON=$("${FAC_BIN}" fac --json review project \
              --pr "${PR_NUMBER}" \
              --head-sha "${HEAD_SHA}" \
              --since-epoch "${DISPATCH_EPOCH}" \
              --after-seq "${after_seq}")

            if [[ -z "${PROJECT_JSON}" ]] || ! jq -e . >/dev/null 2>&1 <<<"${PROJECT_JSON}"; then
              NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              echo "ts=${NOW} security=unknown quality=unknown events=-"
              sleep 1
              continue
            fi

            NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            jq -r --arg now "${NOW}" '.line // ("ts=" + $now + " security=unknown quality=unknown events=-")' <<<"${PROJECT_JSON}"
            jq -r '.errors[]? | "ERROR ts=\(.ts) event=\(.event) review=\(.review_type) seq=\(.seq) detail=\(.detail)"' <<<"${PROJECT_JSON}"

            next_seq=$(jq -r '.last_seq // 0' <<<"${PROJECT_JSON}")
            if [[ "${next_seq}" =~ ^[0-9]+$ ]]; then
              after_seq="${next_seq}"
            fi

            if jq -e '.terminal_failure == true' >/dev/null 2>&1 <<<"${PROJECT_JSON}"; then
              terminal_failure=1
              break
            fi

            sleep 1
          done

          if [[ "${terminal_failure}" -ne 0 ]]; then
            echo "::error::Terminal FAC reviewer failure detected in projection window."
            exit 1
          fi

      # Forge Admission Cycle status is posted exclusively by
      # .github/workflows/review-gate.yml (trusted base-branch evaluator).
      # This workflow only projects FAC execution state and review comments.

name: Forge Admission Barrier

on:
  pull_request_target:
    branches: [main]
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read

jobs:
  barrier:
    name: Guardian Intelligence / Barrier
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
      - name: Validate trigger trust boundary (fast path)
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          fail() {
            echo "barrier: $1" >&2
            exit 1
          }

          event_name="$GITHUB_EVENT_NAME"
          [[ "$event_name" == "pull_request_target" ]] || fail "barrier only supports pull_request_target"

          pr_number="$(jq -r '.pull_request.number // 0' "$GITHUB_EVENT_PATH")"
          association="$(jq -r '.pull_request.author_association // ""' "$GITHUB_EVENT_PATH")"
          [[ "$pr_number" != "0" ]] || fail "missing pull_request.number in event payload"
          case "$association" in
            OWNER|MEMBER|COLLABORATOR) ;;
            *)
              fail "unauthorized pull_request_target author_association=$association for PR #$pr_number"
              ;;
          esac
          echo "barrier: authorized pull_request_target pr=$pr_number association=$association"

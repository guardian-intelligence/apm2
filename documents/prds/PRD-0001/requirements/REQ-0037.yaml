prd_requirement:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  id: REQ-0037
  type: FUNCTIONAL
  title: Deterministic reconciliation and conflict resolution
  statement: 'The system MUST resolve lease conflicts post-partition using a deterministic
    reducer rule based on Canonical Root selection and Registrar Authority.'
  acceptance_criteria:
  - Post-merge, the system determines the authoritative registrar for the work scope
    based on the Canonical Root (determined by closed membership).
  - Any lease not issued by the authoritative registrar is identified as a conflict
    (LEASE.CONFLICT_DETECTED).
  - Conflicts are resolved deterministically (LEASE.CONFLICT_RESOLVED), with the losing
    attempt transitioning to ABORTED_CONFLICT.
  - All evidence produced by the losing attempt is preserved for audit and potential
    manual integration.
  - 'Startup reconciliation consults authoritative token-ledger nonce state for orphaned
    claimed work carrying single-use actuation authority (for example, channel-context
    tokens): consumed/revoked or unverifiable nonce state MUST route to deterministic
    terminal denied outcome; fresh nonce state MAY requeue.'
  - Runtime claimed-queue reconcile is claimed-only, bounded, and single-flight; it MUST
    not mutate lane state and MUST fail closed on ambiguous ownership.
  - 'PR-scoped doctor repair (`apm2 fac doctor --pr <N> --fix`) is bounded and idempotent:
    follow-up reviewer repair executes at most once per pass and refreshes identity only
    when missing or stale.'
  - Deterministic simulated tests validate enqueue-to-dispatch wake latency and repair
    signal coalescing without depending on fixed polling delays.
  evidence:
    evidence_ids:
    - EVID-0006

prd_requirement:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  id: "REQ-0005"
  type: "SECURITY"
  source_id: "FAC-REQ-0104"
  title: "Gate outcome determinism envelope"
  statement: |
    When determinism_class > 0, gate outcomes MUST be proven stable under a coordinator-
    managed determinism envelope. PASS verdicts require N runs with matching
    terminal_evidence_digest, terminal_verifier_outputs_digest, and verdict.
    Observational evidence MAY vary across runs and MUST NOT be used for determinism equality.
    Nondeterminism MUST emit defects and
    fail-closed via quarantine or abort.
  acceptance_criteria:
    - "Determinism envelope is enforced by HOLON-COORDINATOR or a Determinism Proxy, not by gate executors. Verified by: Test that coordinator triggers N-run stability check before PASS acceptance."
    - "Default N-run count is policy-defined (>=3) and recorded in GateReceipt payload. Verified by: Test that run_count reflects policy and matches run_receipt_hashes length."
    - "PASS requires identical terminal_evidence_digest, terminal_verifier_outputs_digest, and verdict across all runs. Verified by: Test that mismatched terminal evidence triggers rejection."
    - "Observational evidence digest differences do not trigger nondeterminism. Verified by: Test that only observational changes do not reject."
    - "stability_digest is computed over (verdict, terminal_evidence_digest, terminal_verifier_outputs_digest). Verified by: Test that stability_digest changes on any terminal evidence change."
    - "Nondeterminism emits DefectRecord(GATE_NONDETERMINISTIC). Verified by: Test defect emission on mismatch."
    - "Repeated nondeterminism transitions work to BLOCKED with rationale=QUARANTINED_CHANGESET and ultimately aborts with WorkAborted abort_reason=POLICY_DENY. Verified by: Test quarantine then abort after threshold."
  evidence:
    evidence_ids:
      - EVID-0019
      - EVID-0021
  law_alignment:
    - law_id: "LAW-04"
      enforcement: "Stochastic stability requires contract + receipt + evidence under determinism envelope."
      applies_to:
        - "Determinism envelope"
        - "GateReceipt payload"
    - law_id: "LAW-12"
      enforcement: "Bounded retries and termination discipline for non-convergent runs."
      applies_to:
        - "Coordinator"
    - law_id: "LAW-15"
      enforcement: "Measurement integrity and fail-closed behavior on uncertainty."
      applies_to:
        - "Admission"
  defect_codes:
    - code: "GATE_NONDETERMINISTIC"
      severity: "S1"
      description: "Gate outcomes diverged under determinism envelope"

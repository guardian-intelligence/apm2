schema_version: "2026-01-26"
template_version: "2026-01-26"

ticket:
  id: TCK-00114
  title: "Implement Impact Map generation"
  status: READY
  rfc_id: RFC-0010
  requirement_ids:
    - REQ-0003
  depends_on:
    - TCK-00113

implementation:
  summary: |
    Create the impact_map module in apm2-core that parses PRD requirements,
    maps them to CCP components, identifies duplication risks when multiple
    extension points are viable, and classifies net-new substrate. Output
    is deterministic YAML suitable for downstream RFC framing.

  files_to_create:
    - path: "crates/apm2-core/src/impact_map/mod.rs"
      purpose: "Module root exposing public API for impact map generation"
    - path: "crates/apm2-core/src/impact_map/mapper.rs"
      purpose: "Core mapping logic from PRD requirements to CCP components"
    - path: "crates/apm2-core/src/impact_map/adjudication.rs"
      purpose: "Duplication risk detection and extension point adjudication"
    - path: "crates/apm2-core/src/impact_map/output.rs"
      purpose: "Deterministic YAML output generation for impact maps"
    - path: "crates/apm2-cli/src/commands/factory/impact_map.rs"
      purpose: "CLI command implementation for 'factory impact-map build'"

  files_to_modify:
    - path: "crates/apm2-core/src/lib.rs"
      changes: "Add 'pub mod impact_map;' to expose the new module"
    - path: "crates/apm2-cli/src/main.rs"
      changes: "Register the impact-map subcommand under factory"

  implementation_steps:
    - step: 1
      action: "Create impact_map module structure"
      details: |
        Create crates/apm2-core/src/impact_map/mod.rs with:
        - pub mod mapper;
        - pub mod adjudication;
        - pub mod output;
        - Re-export key types (ImpactMap, MappedRequirement, DuplicationRisk)

    - step: 2
      action: "Implement requirement parser in mapper.rs"
      details: |
        Parse PRD requirements from documents/prds/<PRD-ID>/requirements/*.yaml.
        Extract requirement IDs, descriptions, and any existing component hints.
        Use serde_yaml for deserialization.

    - step: 3
      action: "Implement CCP component matching in mapper.rs"
      details: |
        Load CCP index from evidence/prd/<PRD-ID>/ccp/ccp_index.json.
        Match requirements to components based on:
        - Explicit component references in requirement (highest priority)
        - Keyword matching against component descriptions (see algorithm below)
        - Extension point compatibility (check if requirement needs extension vs new module)

        **Keyword matching algorithm (in order of preference):**
        1. Exact substring match on component description or module names
        2. Word-level Jaccard similarity (threshold >= 0.3 for candidate inclusion)
        3. LLM-assisted matching for ambiguous cases (see rules below)

        **LLM fallback rules:**
        - Invoke LLM only when: (a) no exact match found AND (b) all Jaccard scores < 0.3
        - Use routing profile stage "impact_map" for model selection
        - Record LLM-assisted mappings in impact_map.yaml under `llm_assisted_mappings`:
          ```yaml
          llm_assisted_mappings:
            - requirement_id: REQ-0003
              matched_component: COMP-CORE
              confidence: 0.85
              rationale: "Requirement mentions 'impact analysis' which aligns with core library capabilities"
          ```
        - LLM confidence threshold: mappings with confidence < 0.6 are flagged as "needs_human_review"

        For each requirement, return ranked list of candidate components with
        fit_score (high/medium/low) and rationale string.

    - step: 4
      action: "Implement adjudication logic"
      details: |
        In adjudication.rs, detect when multiple extension points could satisfy
        a requirement. Flag these as DuplicationRisk with severity levels.
        Classify unmapped requirements as "net-new substrate".

    - step: 5
      action: "Implement deterministic output"
      details: |
        In output.rs, generate impact_map.yaml with:
        - Sorted keys for determinism
        - 2-space indentation
        - Content hash of the output
        Write to evidence/prd/<PRD-ID>/impact_map/impact_map.yaml

    - step: 6
      action: "Implement CLI command"
      details: |
        In impact_map.rs CLI, implement:
        - Parse --prd argument
        - Load CCP index (error if missing)
        - Call mapper with requirements
        - Write output atomically

    - step: 7
      action: "Register CLI command and export module"
      details: |
        Update lib.rs to export impact_map module.
        Update main.rs to add impact-map subcommand under factory.

  code_examples: []

acceptance_criteria:
  - criterion: "All requirements mapped or classified as net-new"
    verification: "Run on PRD-0005 and verify every requirement has a mapping or net-new classification"
  - criterion: "Duplication risks flagged"
    verification: "Verify output contains duplication_risks array when multiple extension points viable"
  - criterion: "Deterministic YAML output"
    verification: "Run twice and diff output files - must be identical"

test_requirements:
  - test_id: UT-114-01
    description: "Test requirement parsing from PRD requirements directory"
    verification_command: "cargo test -p apm2-core impact_map::mapper::tests"
  - test_id: UT-114-02
    description: "Test CCP component matching algorithm"
    verification_command: "cargo test -p apm2-core impact_map::mapper::tests::component_matching"
  - test_id: UT-114-03
    description: "Test duplication risk detection"
    verification_command: "cargo test -p apm2-core impact_map::adjudication::tests"
  - test_id: UT-114-04
    description: "Test deterministic YAML output"
    verification_command: "cargo test -p apm2-core impact_map::output::tests::determinism"
  - test_id: IT-114-01
    description: "Integration test: full impact map generation"
    verification_command: "cargo run --bin apm2 -- factory impact-map build --prd PRD-0005"

notes: |
  This ticket implements Phase 2 of RFC-0010. The impact map is a critical
  artifact that bridges PRD requirements to the codebase structure via CCP.

  Key design decisions:
  - Use CCP index hash for cache invalidation
  - Adjudication produces warnings, not errors (human review expected)
  - Net-new classification triggers downstream RFC sections for new modules

  Depends on TCK-00113 (CCP index) being complete.

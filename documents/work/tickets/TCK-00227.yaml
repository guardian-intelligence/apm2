ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00227"
    title: "FAC: Flake classification types and routing"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0015"
    requirements:
      - requirement_id: "FAC-REQ-0008"
        requirement_ref: "documents/rfcs/RFC-0015/01_problem_and_imports.yaml#rfc_imported_requirements"
    evidence_artifacts:
      - evidence_id: "EVID-FAC-0011"
        artifact_ref: "documents/rfcs/RFC-0015/07_test_and_evidence.yaml#evidence_requirements"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_CORE"
  dependencies:
    tickets:
      - "TCK-00226"
  scope:
    in_scope:
      - "Define FlakeClass enum with 6 variants"
      - "Define FlakeRouting enum for routing actions"
      - "Implement routing_action() method"
    out_of_scope:
      - "Flake detection logic"
      - "Quarantine implementation"
  plan:
    steps:
      - "Create crates/apm2-core/src/fac/flake_class.rs"
      - "Define FlakeClass enum with 6 variants"
      - "Define FlakeRouting enum (Fail, QuarantineRunnerPool, InvalidateAttestation, QuarantineSpec, NeedsInput)"
      - "Implement routing_action() on FlakeClass"
      - "Write unit tests for routing actions"
  definition_of_done:
    evidence_ids:
      - "EVID-FAC-0011"
    criteria:
      - "FlakeClass has 6 canonical enum values"
      - "UNKNOWN cannot convert to PASS via retries"
      - "HARNESS_FLAKE routes to runner pool quarantine"
      - "cargo test -p apm2-core fac::flake_class::tests passes"
  notes:
    security: |
      Flake classification determines the appropriate response to
      nondeterministic test outcomes. Unknown failures cannot be
      retried to PASS.
    implementation_details: |
      FlakeClass variants:
      - DeterministicFail: stable FAIL (not a mismatch)
      - HarnessFlake: runner/infra nondeterminism -> QuarantineRunnerPool
      - EnvironmentDrift: toolchain/env drift -> InvalidateAttestation
      - TestNonsemantic: format differences -> QuarantineSpec
      - CodeNonsemantic: tooling diff -> QuarantineSpec
      - Unknown: unclassified -> NeedsInput (cannot retry to PASS)
    affected_files: |
      Created: crates/apm2-core/src/fac/flake_class.rs

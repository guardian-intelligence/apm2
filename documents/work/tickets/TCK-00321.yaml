ticket_meta:
  schema_version: "2026-01-24"
  template_version: "2026-01-24"
  ticket:
    id: "TCK-00321"
    title: "Episode event sink to ledger"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0019"
    requirements:
      - requirement_id: "REQ-0005"
        requirement_ref: "documents/rfcs/RFC-0019/requirements/REQ-0005.yaml#requirement"
    evidence_artifacts:
      - evidence_id: "EVID-0005"
        artifact_ref: "documents/rfcs/RFC-0019/evidence_artifacts/EVID-0005.yaml#evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_DAEMON"
      - "DOMAIN_KERNEL"
  dependencies:
    tickets:
      - ticket_id: "TCK-00288"
        reason: "EpisodeRuntime exists and emits events; this ticket makes those events durable"
      - ticket_id: "TCK-00289"
        reason: "SqliteLedgerEventEmitter infrastructure required for durable append"
      - ticket_id: "TCK-00316"
        reason: "Session viability requires durable event emission for tool/episode lifecycle signals"
      - ticket_id: "TCK-00320"
        reason: "Tool lifecycle events should include CAS hashes (result_hash) when streamed to ledger"
  scope:
    in_scope:
      - "Replace EpisodeRuntime in-memory event buffering with a ledger-backed event sink"
      - "Stream episode lifecycle and tool lifecycle events as they occur (HEF-ready)"
      - "Ensure CAS-before-ledger ordering for any event referencing a CAS hash"
      - "Ensure receipt emission occurs atomically at episode completion (final commit after CAS artifacts stored)"
      - "Add tests proving events survive daemon restart and ordering invariants hold"
    out_of_scope:
      - "Projection worker wiring (TCK-00322)"
      - "ToolExecutionReceipt + ToolLogIndexV1 generation (TCK-00327)"
  plan:
    steps:
      - "Audit EpisodeRuntime::emit_event and drain_events usage (crates/apm2-daemon/src/episode/runtime.rs)"
      - "Define an EpisodeEventSink interface that can be backed by LedgerEventEmitter"
      - "Inject the sink into EpisodeRuntime construction (state.rs wiring) and remove production reliance on drain_events"
      - "Map EpisodeEvent variants to canonical kernel events and append to ledger with HTF time envelopes"
      - "Enforce CAS-before-ledger ordering at the call sites that produce CAS artifacts (tool results, receipts)"
      - "Add integration test: run episode, restart daemon, verify ledger contains the streamed events in correct order"
  definition_of_done:
    evidence_ids:
      - "EVID-0005"
    criteria:
      - "Episode lifecycle + tool lifecycle events are persisted to ledger as they occur."
      - "Receipt is emitted after all referenced CAS artifacts exist (CAS-before-ledger)."
      - "Event stream survives daemon restart and is queryable from the ledger."
  notes:
    security: "Durability is part of the security boundary: no 'successful' episodes without durable truth-plane events."
    verification: "Include negative tests for missing ledger; behavior must fail closed (blocked/terminated), not best-effort."
    general: "Required for reducer-driven automation (projection worker, audit, and HEF pulses)."


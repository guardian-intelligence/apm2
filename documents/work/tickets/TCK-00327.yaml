ticket_meta:
  schema_version: "2026-01-24"
  template_version: "2026-01-24"
  ticket:
    id: "TCK-00327"
    title: "ToolExecutionReceipt + ToolLogIndexV1 + SummaryReceipt integration"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0019"
    requirements:
      - requirement_id: "REQ-0010"
        requirement_ref: "documents/rfcs/RFC-0019/requirements/REQ-0010.yaml#requirement"
    evidence_artifacts:
      - evidence_id: "EVID-0010"
        artifact_ref: "documents/rfcs/RFC-0019/evidence_artifacts/EVID-0010.yaml#evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_DAEMON"
      - "DOMAIN_KERNEL"
  dependencies:
    tickets:
      - ticket_id: "TCK-00320"
        reason: "Tool execution must surface CAS result_hash values to bind into receipts"
      - ticket_id: "TCK-00321"
        reason: "Tool lifecycle events must be durable and ordered for replay/audit"
  scope:
    in_scope:
      - "Emit a signed ToolExecutionReceipt (use ToolReceipt kind=ToolExecution) per tool actuation"
      - "ToolExecutionReceipt binds episode envelope, policy_hash, request_id/capability_id, args_hash/result_hash, time envelope, and duration"
      - "Store ToolExecutionReceipt in CAS and reference it by hash from tool/episode logs"
      - "Define ToolLogIndexV1 CAS artifact indexing ToolExecutionReceipt hashes with canonical ordering + chunking support"
      - "Generate SummaryReceipt (loss profile + selectors) for review outcomes and store in CAS"
      - "Update review artifacts to reference tool_log_index_hash and summary_receipt_hash (single-pointer scaling)"
    out_of_scope:
      - "Exabyte-scale compaction pipelines and multi-part evidence container formats beyond ToolLogIndex chunking"
  plan:
    steps:
      - "Map RFC ToolExecutionReceipt to existing receipt primitives (crates/apm2-daemon/src/evidence/receipt.rs ToolReceipt)"
      - "Implement ToolExecutionReceipt creation + signing in the tool execution path (executor/broker/runtime) and store in CAS"
      - "Define ToolLogIndexV1 schema (canonical bytes/JSON) and implement CAS storage with deterministic ordering over receipt hashes"
      - "Integrate ToolLogIndexV1 creation at episode completion and bind tool_log_index_hash into review artifact bundle"
      - "Generate SummaryReceipt per schema (schemas/apm2/summary_receipt.schema.json), store to CAS, and bind summary_receipt_hash into review artifacts"
      - "Add unit/integration tests verifying: every ToolLogIndex entry resolves; every ToolExecutionReceipt resolves; receipts bind to args/result hashes that resolve in CAS"
  definition_of_done:
    evidence_ids:
      - "EVID-0010"
    criteria:
      - "ToolExecutionReceipts are stored in CAS for every tool actuation."
      - "ToolLogIndexV1 stored in CAS references only resolvable ToolExecutionReceipt hashes."
      - "Review artifacts include tool_log_index_hash and summary_receipt_hash."
      - "Offline audit can verify ToolExecutionReceipt -> args_hash/result_hash -> CAS artifacts without reading daemon filesystem state."
  notes:
    security: "Proof-carrying tool use is required for audit and replay; unsigned or unbound tool logs are insufficient."
    verification: "Verify canonical ordering + stable hashing; ensure deny-by-default when any required receipt/index material is missing."
    general: "This ticket upgrades tool evidence from 'hashes exist' to 'receipts prove actuation under policy/time envelopes'."


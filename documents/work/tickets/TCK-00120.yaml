schema_version: "2026-01-26"
template_version: "2026-01-26"

ticket:
  id: TCK-00120
  title: "Implement end-to-end compile command"
  status: READY
  rfc_id: RFC-0010
  requirement_ids:
    - REQ-0001
  depends_on:
    - TCK-00119

implementation:
  summary: |
    Implement the apm2 factory compile command that orchestrates the complete
    idea-to-tickets pipeline. This command chains all stages (CCP build, Impact Map,
    RFC frame, Ticket emit) in order, supports dry-run mode, configurable routing
    profiles, and emits NDJSON observability events throughout execution.

  files_to_create:
    - path: "crates/apm2-cli/src/commands/factory/compile.rs"
      purpose: "Compile command implementation with stage orchestration"

  files_to_modify:
    - path: "crates/apm2-cli/src/main.rs"
      changes: "Register compile subcommand under factory"

    - path: "crates/apm2-cli/src/commands/factory.rs"
      changes: "Add compile module and wire up command"

  implementation_steps:
    - step: 1
      action: "Define command arguments"
      details: |
        In compile.rs using clap:
        - --prd <PRD-ID>: Required, identifies the PRD to compile
        - --rfc <RFC-ID>: Optional, target RFC ID (auto-generated if omitted)
        - --profile <PROFILE>: Optional, routing profile name (default: local)
        - --dry-run: Flag to report intended writes without modifying files
        - --output-dir <PATH>: Optional, override default output directory
        - --sign: Flag to sign the run manifest

    - step: 2
      action: "Implement stage orchestration"
      details: |
        In compile.rs:
        - CompilePipeline struct holding stage dependencies
        - Stages execute in order:
          1. CCP build (ccp module)
          2. Impact Map generation (impact_map module)
          3. RFC frame (rfc_framer module)
          4. Ticket emit (ticket_emitter module)
        - Each stage receives output from previous stage
        - Errors halt pipeline with context

    - step: 3
      action: "Implement dry-run mode"
      details: |
        In compile.rs:
        - DryRunContext tracks intended writes
        - Each stage reports what it would write
        - At end, print summary of all intended writes
        - No filesystem modifications in dry-run

    - step: 4
      action: "Implement NDJSON observability"
      details: |
        In compile.rs:
        - Define event types: StageStart, StageComplete, StageError, PipelineComplete
        - Each event includes timestamp, stage name, duration, status
        - Events written to stdout as newline-delimited JSON
        - Human-readable summary also printed to stderr

    - step: 5
      action: "Wire up routing profile"
      details: |
        In compile.rs:
        - Load routing profile from model_router module
        - Pass router to stages that require model invocation
        - Record routing decisions in run manifest

    - step: 6
      action: "Generate and sign run manifest"
      details: |
        In compile.rs:
        - Build manifest with all inputs, outputs, timings
        - If --sign flag, sign manifest with configured key
        - Write manifest to evidence/prd/<PRD-ID>/manifests/

    - step: 7
      action: "Register command"
      details: |
        In factory.rs and main.rs:
        - Add compile to factory subcommands
        - Wire up command handler

  code_examples:
    - description: "Command usage"
      code: |
        # Full compilation
        apm2 factory compile --prd PRD-0005 --rfc RFC-0011

        # Dry-run to preview changes
        apm2 factory compile --prd PRD-0005 --dry-run

        # With custom routing profile
        apm2 factory compile --prd PRD-0005 --profile production --sign

    - description: "NDJSON event example"
      code: |
        {"event":"stage_start","stage":"ccp_build","timestamp":"2026-01-26T14:30:00Z"}
        {"event":"stage_complete","stage":"ccp_build","duration_ms":2340,"outputs":["evidence/prd/PRD-0005/ccp/ccp_index.json"]}
        {"event":"stage_start","stage":"impact_map","timestamp":"2026-01-26T14:30:02Z"}
        ...

acceptance_criteria:
  - criterion: "End-to-end compilation works"
    verification: "Integration test runs full pipeline on test PRD and produces expected outputs"

  - criterion: "Dry-run reports intended writes"
    verification: "Dry-run mode prints all intended file writes without creating files"

  - criterion: "NDJSON events emitted"
    verification: "Test captures stdout and validates NDJSON event format for each stage"

test_requirements:
  - test_id: IT-120-01
    description: "Integration test for full compile pipeline"
    verification_command: "cargo run --bin apm2 -- factory compile --prd PRD-0005 --dry-run"

  - test_id: UT-120-02
    description: "Test dry-run mode produces no side effects"
    verification_command: "cargo test -p apm2-cli compile::dry_run"

  - test_id: UT-120-03
    description: "Test NDJSON event emission format"
    verification_command: "cargo test -p apm2-cli compile::ndjson"

  - test_id: UT-120-04
    description: "Test pipeline halts on stage error"
    verification_command: "cargo test -p apm2-cli compile::error_handling"

notes: |
  This ticket implements REQ-0001 (end-to-end compilation) from RFC-0010.

  Key design decisions:
  - Sequential stage execution ensures deterministic ordering.
  - Dry-run mode is essential for CI integration and validation before writes.
  - NDJSON format enables machine-parseable observability while human summary
    goes to stderr for interactive use.
  - Run manifests provide full audit trail of compilation.

  CCP grounding: COMP-CLI module, extension point EXT-CLI-001.

  This is the capstone ticket for the compile pipeline, bringing together all
  previous stages (CCP, Impact Map, RFC Framer, Ticket Emitter, Model Router,
  Run Manifest).

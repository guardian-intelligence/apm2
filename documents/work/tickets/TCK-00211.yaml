ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00211"
    title: "FAC: Context firewall integration with PolicyEngine"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0015"
    requirements:
      - requirement_id: "FAC-REQ-0001"
        requirement_ref: "documents/rfcs/RFC-0015/01_problem_and_imports.yaml#rfc_imported_requirements"
    evidence_artifacts:
      - evidence_id: "EVID-FAC-0003"
        artifact_ref: "documents/rfcs/RFC-0015/07_test_and_evidence.yaml#evidence_requirements"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_SECURITY"
      - "DOMAIN_DAEMON"
  dependencies:
    tickets:
      - "TCK-00210"
  scope:
    in_scope:
      - "Add manifest-aware rule evaluation to PolicyEngine"
      - "Wire context firewall into CONSUME mode session handling"
      - "Implement CONTEXT_MISS session termination"
      - "Trigger ContextRefinementRequest after CONTEXT_MISS"
    out_of_scope:
      - "Pack compiler updates"
      - "Refinement loop implementation"
  plan:
    steps:
      - "Modify crates/apm2-core/src/policy/engine.rs with manifest-aware rules"
      - "Add default-deny rule for CONSUME mode sessions"
      - "Modify crates/apm2-daemon/src/session/consume.rs"
      - "Load manifest from RCP at session start"
      - "Pass manifest to ContextAwareValidator on each read"
      - "On DENY in HARD_FAIL mode, emit SessionTerminated with CONTEXT_MISS"
      - "Emit ContextRefinementRequest to coordinator"
      - "Write integration tests for CONSUME mode context firewall"
      - "Write integration tests for CONTEXT_MISS termination"
  definition_of_done:
    evidence_ids:
      - "EVID-FAC-0003"
    criteria:
      - "CONSUME mode sessions use manifest allowlist"
      - "Context miss terminates session with CONTEXT_MISS rationale"
      - "ContextRefinementRequest is triggered after CONTEXT_MISS"
      - "cargo test -p apm2-daemon session::consume::tests passes"
  notes:
    security: |
      Context firewall integration ensures all CONSUME mode sessions
      are constrained to the manifest allowlist. This prevents
      information leakage outside the declared context.
    implementation_details: |
      CONTEXT_MISS flow:
      1. Read request outside manifest
      2. ContextAwareValidator returns Err(NotInAllowlist)
      3. Session emits SessionTerminated(rationale=CONTEXT_MISS)
      4. Coordinator receives ContextRefinementRequest
      5. Coordinator reissues with refined pack
    affected_files: |
      Modified: crates/apm2-core/src/policy/engine.rs
      Modified: crates/apm2-daemon/src/session/consume.rs

ticket_meta:
  schema_version: '2026-01-27'
  template_version: '2026-01-27'
  ticket:
    id: TCK-00167
    title: Implement receipt signing and verification
    status: READY
  binds:
    rfc_id: RFC-0013
    requirements:
    - requirement_id: REQ-RECEIPT-001
dependencies:
  tickets:
  - ticket_id: TCK-00166
acceptance_criteria:
- criterion: Ed25519 signing of receipt canonical bytes
  verification: Signed receipts verify successfully
- criterion: Verification predicate implementation
  verification: Tampered receipts fail verification
- criterion: Signing key management in OS keychain
  verification: Keys stored/retrieved from keychain
implementation:
  code_examples:
  - description: Receipt signing
    code: "pub struct ReceiptSigner {\n    signing_key: SigningKey,\n    key_id: KeyId,\n\
      \    key_version: u32,\n}\n\nimpl ReceiptSigner {\n    pub fn sign(&self, receipt:\
      \ &mut Receipt) -> Result<()> {\n        let unsigned_bytes = receipt.unsigned_bytes();\n\
      \        let signature = self.signing_key.sign(&unsigned_bytes);\n        receipt.signature\
      \ = Some(signature);\n        receipt.signer_identity = Some(SignerIdentity\
      \ {\n            key_id: self.key_id.clone(),\n            key_version: self.key_version,\n\
      \        });\n        Ok(())\n    }\n}\n\npub fn verify_receipt(receipt: &Receipt,\
      \ public_key: &PublicKey) -> Result<bool> {\n    let unsigned_bytes = receipt.unsigned_bytes();\n\
      \    let signature = receipt.signature.as_ref()?;\n    Ok(public_key.verify(&unsigned_bytes,\
      \ signature).is_ok())\n}\n"
  files_to_create:
  - path: crates/apm2-daemon/src/evidence/signer.rs
    purpose: ReceiptSigner and signing logic
  - path: crates/apm2-daemon/src/evidence/verifier.rs
    purpose: Receipt verification predicate
  - path: crates/apm2-daemon/src/evidence/keychain.rs
    purpose: OS keychain integration for key storage
  files_to_modify:
  - changes: Export signer, verifier, keychain modules
    path: crates/apm2-daemon/src/evidence/mod.rs
  implementation_steps:
  - step: 1
    action: Implement ReceiptSigner
    details: 'Create signer using ed25519-dalek:

      - Load signing key from keychain

      - Sign unsigned_bytes

      - Attach signature and identity to receipt

      '
  - step: 2
    action: Implement verification predicate
    details: 'Implement doctrine predicate per AD-RECEIPT-001:

      - VerifyReceipt(receipt): signature valid

      - EvidenceSatisfies(contract, evidence): refs exist

      - DigestBindingsHold(output, evidence): hashes match

      '
  - step: 3
    action: Implement keychain integration
    details: 'Use Secret Service API (Linux) or Keychain (macOS):

      - store_key(key_id, signing_key)

      - load_key(key_id) -> SigningKey

      - delete_key(key_id)

      - list_keys() -> Vec<KeyId>

      '
  - step: 4
    action: Implement key lifecycle
    details: 'Per AD-KEY-001:

      - Key generation with version tracking

      - 90-day rotation schedule

      - Old keys preserved for verification (1 year)

      - Compromise recovery: revoke and rotate

      '
  - step: 5
    action: Create verification tests
    details: 'Test cases:

      - Valid signature verifies

      - Tampered payload fails

      - Wrong key fails

      - Expired key handling

      '
  summary: 'Implement receipt signing and verification per AD-RECEIPT-001 and AD-KEY-001.

    Uses Ed25519 signatures with keys stored in OS keychain.

    Includes verification predicate implementation per doctrine.

    '
notes: 'Phase: PHASE-2B (Tool Execution and Receipts)

  Generated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.

  Maps to TCK-PEND-010.

  '
test_requirements:
- description: Sign and verify round-trip
  test_id: UT-00167-01
  verification_command: cargo test -p apm2-daemon sign_verify
- description: Tampered receipt rejection
  test_id: UT-00167-02
  verification_command: cargo test -p apm2-daemon tampered_receipt
- description: Keychain integration
  test_id: IT-00167-01
  verification_command: cargo test -p apm2-daemon --test integration keychain

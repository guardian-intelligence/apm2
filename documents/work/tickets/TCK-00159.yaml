ticket_meta:
  schema_version: '2026-01-27'
  template_version: '2026-01-27'
  ticket:
    id: TCK-00159
    title: Implement EpisodeEnvelope type with canonicalization
    status: READY
  binds:
    rfc_id: RFC-0013
    requirements:
    - requirement_id: REQ-EPISODE-001
dependencies:
  tickets:
  - ticket_id: TCK-00158
acceptance_criteria:
- criterion: EpisodeEnvelope struct with all fields per AD-EPISODE-001
  verification: Unit test verifies field presence and types
- criterion: canonical_bytes() produces deterministic serialization
  verification: Golden vectors match expected digests
- criterion: Envelope hash stable across serialization cycles
  verification: Property test verifies hash stability
implementation:
  code_examples:
  - description: EpisodeEnvelope structure
    code: "#[derive(Clone, Serialize, Deserialize)]\npub struct EpisodeEnvelope {\n\
      \    pub episode_id: EpisodeId,\n    pub actor_id: ActorId,\n    pub work_id:\
      \ Option<WorkId>,\n    pub lease_id: LeaseId,\n    pub budget: EpisodeBudget,\n\
      \    pub stop_conditions: StopConditions,\n    pub pinned_snapshot: PinnedSnapshot,\n\
      \    pub capability_manifest_hash: Hash,\n    pub risk_tier: RiskTier,\n   \
      \ pub determinism_class: DeterminismClass,\n    pub context_refs: Option<ContextRefs>,\n\
      }\n\nimpl EpisodeEnvelope {\n    pub fn canonical_bytes(&self) -> Vec<u8> {\n\
      \        // Deterministic protobuf encoding\n    }\n\n    pub fn digest(&self)\
      \ -> Hash {\n        blake3::hash(&self.canonical_bytes())\n    }\n}\n"
  files_to_create:
  - path: crates/apm2-daemon/src/episode/envelope.rs
    purpose: EpisodeEnvelope type and canonicalization
  - path: crates/apm2-daemon/src/episode/budget.rs
    purpose: EpisodeBudget and resource limit types
  - path: crates/apm2-daemon/src/episode/snapshot.rs
    purpose: PinnedSnapshot for reproducibility
  - path: crates/apm2-daemon/src/episode/golden_vectors.rs
    purpose: Golden vectors for envelope hashing
  files_to_modify:
  - changes: Export envelope, budget, snapshot modules
    path: crates/apm2-daemon/src/episode/mod.rs
  implementation_steps:
  - step: 1
    action: Define EpisodeEnvelope struct
    details: 'Create EpisodeEnvelope with all fields from AD-EPISODE-001:

      - episode_id, actor_id, work_id, lease_id

      - budget (EpisodeBudget)

      - stop_conditions (StopConditions)

      - pinned_snapshot (PinnedSnapshot)

      - capability_manifest_hash, risk_tier, determinism_class

      - context_refs (optional)

      '
  - step: 2
    action: Implement EpisodeBudget
    details: 'Create EpisodeBudget struct with fields:

      - tokens: u64

      - tool_calls: u32

      - wall_ms: u64

      - cpu_ms: u64

      - bytes_io: u64

      - evidence_bytes: u64

      '
  - step: 3
    action: Implement PinnedSnapshot
    details: 'Create PinnedSnapshot struct with optional hashes:

      - repo_hash, lockfile_hash, policy_hash

      - toolchain_hash, model_profile_hash

      '
  - step: 4
    action: Implement canonical_bytes()
    details: 'Implement deterministic serialization per AD-VERIFY-001:

      - Fields serialized in tag number order

      - No maps in signed messages

      - Unknown fields dropped

      - Explicit default serialization

      '
  - step: 5
    action: Create golden vectors
    details: 'Create 10+ golden vectors testing:

      - Minimal envelope (required fields only)

      - Full envelope (all optional fields)

      - Various budget combinations

      - Hash stability across cycles

      '
  summary: 'Implement EpisodeEnvelope type with canonicalization per AD-EPISODE-001.

    Defines immutable envelope object referenced by digest in all receipts.

    Includes canonical_bytes() for deterministic serialization.

    '
notes: 'Phase: PHASE-1B (Episode Envelope and Lifecycle)

  Generated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.

  Maps to TCK-PEND-003.

  '
test_requirements:
- description: Envelope serialization round-trip
  test_id: UT-00159-01
  verification_command: cargo test -p apm2-daemon envelope_roundtrip
- description: Golden vectors pass
  test_id: UT-00159-02
  verification_command: cargo test -p apm2-daemon envelope_golden_vectors
- description: Hash stability property test
  test_id: UT-00159-03
  verification_command: cargo test -p apm2-daemon envelope_hash_stability

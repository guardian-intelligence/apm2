schema_version: "2026-01-26"
template_version: "2026-01-26"

ticket:
  id: TCK-00118
  title: "Implement model router with routing profiles"
  status: READY
  rfc_id: RFC-0010
  requirement_ids:
    - REQ-0007
  depends_on:
    - TCK-00117

implementation:
  summary: |
    Create the model router module to handle multi-model orchestration with
    configurable routing profiles. The router parses routing profile YAML files,
    routes pipeline stages to appropriate providers based on profile configuration,
    and supports canary comparison between two routing configurations.

  files_to_create:
    - path: "crates/apm2-core/src/model_router/mod.rs"
      purpose: "Module entry point exposing router, profile, and canary submodules"

    - path: "crates/apm2-core/src/model_router/router.rs"
      purpose: "Core routing logic that dispatches stages to providers"

    - path: "crates/apm2-core/src/model_router/profile.rs"
      purpose: "Routing profile parsing and validation from YAML"

    - path: "crates/apm2-core/src/model_router/canary.rs"
      purpose: "Canary mode implementation comparing two routes and emitting diff"

    - path: "documents/standards/schemas/routing_profile.schema.yaml"
      purpose: "JSON Schema defining routing profile structure"

    - path: "documents/standards/routing_profiles/local.yaml"
      purpose: "Default local routing profile for development"

  files_to_modify:
    - path: "crates/apm2-core/src/lib.rs"
      changes: "Add pub mod model_router declaration"

  implementation_steps:
    - step: 1
      action: "Create routing profile schema"
      details: |
        Define the routing_profile.schema.yaml with:
        - profile_id: unique identifier
        - stages: map of stage name to provider configuration
        - provider configuration: model, endpoint, timeout, retry policy
        - fallback: optional fallback provider

    - step: 2
      action: "Implement profile parser"
      details: |
        In profile.rs:
        - Parse routing profile YAML files
        - Validate against schema
        - Provide RoutingProfile struct with stage-to-provider mapping

    - step: 3
      action: "Implement core router"
      details: |
        In router.rs:
        - Router struct that holds loaded profile
        - route_stage(stage_name) -> ProviderConfig method
        - Provider availability check with fail-closed semantics
        - Error handling for unavailable providers

    - step: 4
      action: "Implement canary comparison"
      details: |
        In canary.rs:
        - CanaryRunner that executes same input through two routes
        - Diff generation between outputs
        - Structured canary report with timing and differences

    - step: 5
      action: "Create local routing profile"
      details: |
        In local.yaml:
        - Default profile for local development
        - Map all stages to local/mock providers
        - Include example configuration comments

    - step: 6
      action: "Wire up module"
      details: |
        In mod.rs and lib.rs:
        - Export public types
        - Add module declaration to crate root

  code_examples:
    - description: "Routing profile structure"
      code: |
        # documents/standards/routing_profiles/local.yaml
        profile_id: local
        description: Local development routing profile
        stages:
          ccp_build:
            provider: local
            timeout_ms: 30000
          impact_map:
            provider: anthropic
            model: claude-3-5-sonnet
            timeout_ms: 60000
          rfc_frame:
            provider: anthropic
            model: claude-3-5-sonnet
            timeout_ms: 120000
        fallback:
          provider: local
          reason: "Use local fallback when providers unavailable"

acceptance_criteria:
  - criterion: "Routing profiles parsed correctly"
    verification: "Unit tests validate profile loading from YAML and field extraction"

  - criterion: "Canary mode produces diff"
    verification: "Canary tests show diff output when two routes produce different results"

  - criterion: "Unavailable provider fails closed"
    verification: "Tests verify router returns error (not fallback) when provider unavailable and no explicit fallback configured"

test_requirements:
  - test_id: UT-118-01
    description: "Test routing profile YAML parsing with valid input"
    verification_command: "cargo test -p apm2-core model_router::profile"

  - test_id: UT-118-02
    description: "Test router stage dispatch returns correct provider config"
    verification_command: "cargo test -p apm2-core model_router::router"

  - test_id: UT-118-03
    description: "Test canary comparison generates structured diff"
    verification_command: "cargo test -p apm2-core model_router::canary"

  - test_id: UT-118-04
    description: "Test fail-closed behavior when provider unavailable"
    verification_command: "cargo test -p apm2-core model_router::router::unavailable"

notes: |
  This ticket implements REQ-0007 (multi-model routing) from RFC-0010.

  Key design decisions:
  - Fail-closed semantics: if a provider is unavailable and no fallback is
    explicitly configured, the router returns an error rather than silently
    degrading to a different provider.
  - Canary mode is opt-in and runs both routes sequentially to compare outputs.
  - Routing profiles are version-controlled YAML files to enable reproducibility.

  CCP grounding: COMP-CORE module, extends model orchestration capabilities.

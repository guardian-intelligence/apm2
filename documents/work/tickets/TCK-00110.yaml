ticket_meta:
  schema_version: '2026-01-26'
  template_version: '2026-01-26'
  ticket:
    id: TCK-00110
    title: Implement determinism module with YAML canonicalization
    status: READY
  binds:
    rfc_id: RFC-0010
    requirements:
    - requirement_id: REQ-0008
implementation:
  summary: 'Create the determinism module in apm2-core that provides foundational

    capabilities for all compiler outputs: YAML canonicalization (sorted keys,

    2-space indent), atomic file writes (temp -> fsync -> rename), and diff

    classification (structural vs free-text changes).

    '
  files_to_modify:
  - path: crates/apm2-core/src/lib.rs
    changes: Add pub mod determinism; to export the new module
  files_to_create:
  - path: crates/apm2-core/src/determinism/mod.rs
    purpose: Module root exporting public API for canonicalization, atomic writes,
      and diff classification
  - path: crates/apm2-core/src/determinism/canonicalize.rs
    purpose: 'YAML canonicalization: sorted keys at all nesting levels, 2-space indentation,
      no trailing whitespace'
  - path: crates/apm2-core/src/determinism/atomic_write.rs
    purpose: 'Atomic file write implementation: write to temp file, fsync, fsync parent
      directory, atomic rename'
  - path: crates/apm2-core/src/determinism/diff_classify.rs
    purpose: Diff classification logic to distinguish structural changes from free-text
      field changes
  implementation_steps:
  - step: 1
    action: Create module structure
    details: 'Create crates/apm2-core/src/determinism/mod.rs with public exports for:

      - canonicalize_yaml function

      - write_atomic function

      - classify_diff function

      - DiffClassification enum (Structural, FreeText)

      - AtomicWriteError error type

      '
  - step: 2
    action: Implement YAML canonicalization
    details: 'In canonicalize.rs, implement canonicalize_yaml(value: &serde_yaml::Value)
      -> String:

      - Recursively sort all object/mapping keys lexicographically

      - Use 2-space indentation consistently

      - Remove trailing whitespace from all lines

      - Use consistent quoting (prefer unquoted for simple strings)

      - Ensure idempotent: canonicalize(canonicalize(x)) == canonicalize(x)

      '
  - step: 3
    action: Implement atomic file writes
    details: 'In atomic_write.rs, implement write_atomic(path: &Path, content: &[u8])
      -> Result<(), AtomicWriteError>:

      - Create temp file in same directory as target (for same-filesystem rename)

      - Write content to temp file

      - fsync the temp file to ensure data durability

      - fsync the parent directory (required on some filesystems)

      - Atomic rename temp file to target path

      - On any error, clean up temp file if it exists

      '
  - step: 4
    action: Implement diff classification
    details: 'In diff_classify.rs, implement classify_diff(old: &str, new: &str) ->
      DiffClassification:

      - Parse both strings as YAML

      - Compare structure: keys present, array lengths, value types

      - Define "free-text fields" as fields like description, summary, rationale (configurable
      list)

      - If only free-text fields differ, return DiffClassification::FreeText

      - If any structural field differs, return DiffClassification::Structural

      - Handle parse errors gracefully (treat as Structural change)

      '
  - step: 5
    action: Add module to lib.rs
    details: 'In crates/apm2-core/src/lib.rs, add:

      pub mod determinism;

      '
  code_examples:
  - description: Canonicalization usage
    code: 'use apm2_core::determinism::canonicalize_yaml;

      use serde_yaml::Value;


      let yaml: Value = serde_yaml::from_str(input)?;

      let canonical = canonicalize_yaml(&yaml);

      // canonical has sorted keys, 2-space indent, no trailing whitespace

      '
  - description: Atomic write usage
    code: 'use apm2_core::determinism::write_atomic;

      use std::path::Path;


      write_atomic(Path::new("output.yaml"), content.as_bytes())?;

      // File is either fully written or not modified at all

      '
acceptance_criteria:
- criterion: canonicalize_yaml produces identical output for semantically identical
    input
  verification: Unit test with YAML inputs that differ only in key order, whitespace,
    or quoting style - outputs must match exactly
- criterion: write_atomic never produces partial files on interruption
  verification: Unit test simulating write failures at various stages - target file
    either contains complete new content or remains unchanged
- criterion: diff_classify correctly categorizes structural vs free-text changes
  verification: 'Unit tests covering: key additions (Structural), key removals (Structural),
    type changes (Structural), description-only changes (FreeText), mixed changes
    (Structural)'
test_requirements:
- test_id: UT-110-01
  description: Test YAML canonicalization is idempotent
  verification_command: cargo test -p apm2-core determinism::canonicalize::tests::test_canonicalize_idempotent
- test_id: UT-110-02
  description: Test YAML canonicalization sorts nested keys
  verification_command: cargo test -p apm2-core determinism::canonicalize::tests::test_nested_key_sorting
- test_id: UT-110-03
  description: Test atomic write creates complete file
  verification_command: cargo test -p apm2-core determinism::atomic_write::tests::test_atomic_write_complete
- test_id: UT-110-04
  description: Test atomic write cleans up on error
  verification_command: cargo test -p apm2-core determinism::atomic_write::tests::test_atomic_write_cleanup_on_error
- test_id: UT-110-05
  description: Test diff classification for structural changes
  verification_command: cargo test -p apm2-core determinism::diff_classify::tests::test_structural_diff
- test_id: UT-110-06
  description: Test diff classification for free-text changes
  verification_command: cargo test -p apm2-core determinism::diff_classify::tests::test_freetext_diff
- test_id: IT-110-01
  description: 'Integration test: full determinism module'
  verification_command: cargo test -p apm2-core determinism
- test_id: LT-110-01
  description: Lint check passes
  verification_command: cargo clippy -p apm2-core -- -D warnings
notes: 'This ticket establishes the foundational determinism guarantees required by
  all

  subsequent compiler stages. The atomicity and canonicalization properties are

  critical for reproducible builds and safe concurrent writes.


  Key dependencies:

  - serde_yaml: YAML parsing and serialization

  - tempfile: Safe temporary file creation

  - blake3 (optional): Content hashing if needed for verification


  This module has no dependencies on other RFC-0010 tickets and should be

  implemented first as all other CCP-related tickets depend on it.

  '

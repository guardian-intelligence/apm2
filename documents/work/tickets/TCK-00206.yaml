ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00206"
    title: "FAC: PolicyResolvedForChangeSet event"
    status: "CLOSED"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0015"
    requirements:
      - requirement_id: "FAC-REQ-0116"
        requirement_ref: "documents/rfcs/RFC-0015/01_problem_and_imports.yaml#rfc_imported_requirements"
    evidence_artifacts:
      - evidence_id: "EVID-FAC-0024"
        artifact_ref: "documents/rfcs/RFC-0015/07_test_and_evidence.yaml#evidence_requirements"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_SECURITY"
      - "DOMAIN_CORE"
  dependencies:
    tickets:
      - "TCK-00202"
  scope:
    in_scope:
      - "Add PolicyResolvedForChangeSet proto message"
      - "Create PolicyResolvedForChangeSet Rust type"
      - "Implement verify_lease_match() for policy binding"
      - "Implement verify_receipt_match() for anti-downgrade"
    out_of_scope:
      - "Policy resolution logic (separate component)"
      - "Full anti-downgrade checks (TCK-00224)"
  plan:
    steps:
      - "Add PolicyResolvedForChangeSet message to proto/kernel_events.proto"
      - "Create crates/apm2-core/src/fac/policy_resolution.rs"
      - "Define PolicyResolvedForChangeSet struct with all 11 fields"
      - "Implement verify_lease_match() for policy_hash binding"
      - "Implement verify_receipt_match() for basic anti-downgrade"
      - "Write unit tests for lease policy matching"
  definition_of_done:
    evidence_ids:
      - "EVID-FAC-0024"
    criteria:
      - "PolicyResolvedForChangeSet binds resolved policy tuple"
      - "PolicyResolvedForChangeSet exists before any GateLeaseIssued"
      - "Lease policy_hash mismatch is detected"
      - "cargo test -p apm2-core fac::policy_resolution::tests passes"
  notes:
    security: |
      PolicyResolvedForChangeSet is the anchor event that locks policy
      decisions for a changeset. All subsequent lease issuance and receipt
      validation must reference this anchor.
    implementation_details: |
      PolicyResolvedForChangeSet fields:
      - work_id, changeset_digest, resolved_policy_hash
      - resolved_risk_tier, resolved_determinism_class
      - resolved_rcp_profile_ids, resolved_rcp_manifest_hashes
      - resolved_verifier_policy_hashes
      - resolver_actor_id, resolver_version, resolver_signature
    affected_files: |
      Modified: proto/kernel_events.proto
      Created: crates/apm2-core/src/fac/policy_resolution.rs

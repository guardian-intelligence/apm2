title: Review SLA Enforcement

decision_tree:
  entrypoint: ENFORCE
  nodes[1]:
    - id: ENFORCE
      purpose: "Ensure AI reviews update status within 15m."
      steps[12]:
        - id: NOTE_VARIABLE_SUBSTITUTION
          action: "Replace <TICKET_ID>, <BRANCH_NAME>, <PR_URL>, <SEC_PID>, <QUAL_PID>, <SEC_LOG>, <QUAL_LOG>, <headRefOid>."
        - id: GET_PR_METADATA
          action: command
          run: "gh pr view <BRANCH_NAME> --json url,headRefOid"
          capture_as: pr_meta
        - id: CHECK_AI_STATUS
          action: command
          run: "gh api repos/:owner/:repo/commits/<headRefOid>/status --jq '.statuses[] | select(.context | startswith(\"ai-review/")) | \"\(.context): \(.state)\"''"
          capture_as: ai_status
        - id: LOAD_REVIEWER_STATE
          action: command
          run: "python3 - <<'PY'\nimport json, os, time\nfrom pathlib import Path\np = Path.home()/.apm2/reviewer_state.json'\nif p.exists():\n    data = json.loads(p.read_text())\n    for k,v in (data.get('reviewers') or {}).items():\n        print(f\"{k}\tpid={v.get('pid')}\tstarted_at={v.get('started_at')}\tlog_file={v.get('log_file')}\tpr_url={v.get('pr_url')}\")\nPY"
          capture_as: reviewer_state_summary
        - id: IDENTIFY_PIDS_AND_LOGS
          action: "Set <SEC_PID>, <SEC_LOG>, <QUAL_PID>, <QUAL_LOG> from summary."
        - id: INSPECT_REVIEWER_PROCESSES
          action: command
          run: "bash -lc 'set -euo pipefail; ps -p <SEC_PID> -o pid=,etime=,cmd= || true; ps -p <QUAL_PID> -o pid=,etime=,cmd= || true'"
          capture_as: reviewer_ps
        - id: CHECK_LOG_ACTIVITY
          action: command
          run: "bash -lc 'set -euo pipefail; stat -c \"%y %n\" <SEC_LOG> || true; stat -c \"%y %n\" <QUAL_LOG> || true'"
          capture_as: reviewer_log_mtime
        - id: TAIL_LOGS
          action: command
          run: "bash -lc 'set -euo pipefail; tail -n 80 <SEC_LOG> || true; tail -n 80 <QUAL_LOG> || true'"
          capture_as: reviewer_log_tail
        - id: ENFORCE_15M_DEADLINE
          action: "Verify `now - started_at < 900s`. If breach (per `ai_status`), restart reviews."
        - id: RESTART_IF_UNHEALTHY
          action: "If STALE/DEAD, trigger `cargo xtask review <TYPE> <PR_URL>`."
        - id: ESCALATE_IF_REVIEWS_NOT_RUNNING
          action: "If state empty AND pending, escalate to implementer. `cargo xtask push --force-review`."
        - id: LOOP_UNTIL_RESOLVED
          action: "Remediate until reviews finish."
      decisions[2]:
        - id: BACK_TO_MONITOR
          if: "reviews finished OR remediation attempted"
          then:
            next_reference: references/dispatch-and-monitor-ticket.md
        - id: STOP_ON_FAILURE
          if: "SLA breached AND remediation failed"
          then:
            next_reference: references/stop-blocked-review-sla.md
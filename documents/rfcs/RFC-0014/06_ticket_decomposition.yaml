rfc_ticket_decomposition:
  schema_version: "2026-01-28"

  decomposition_strategy:
    overview: |
      The implementation is decomposed into 11 tickets across 4 phases. Each ticket
      is scoped to be completable in 1-3 days by a single engineer. Dependencies
      are explicit and form a partial order that maximizes parallelism.

    phases:
      - id: P0
        name: "Foundation"
        description: "Abstractions and schema extensions without behavioral change"
        tickets: [DCS-001, DCS-002, DCS-003]
        estimated_duration: "2 weeks"

      - id: P1
        name: "Replication"
        description: "Multi-node communication and leader-based replication"
        tickets: [DCS-004, DCS-005, DCS-006]
        estimated_duration: "3 weeks"
        depends_on: [P0]

      - id: P2
        name: "Consensus"
        description: "Full BFT consensus and anti-entropy with CRDT merge"
        tickets: [DCS-007, DCS-008, DCS-009]
        estimated_duration: "4 weeks"
        depends_on: [P1]

      - id: P3
        name: "Production"
        description: "HSM integration and operational tooling"
        tickets: [DCS-010, DCS-011]
        estimated_duration: "2 weeks"
        depends_on: [P2]

  tickets:
    - id: DCS-001
      phase: P0
      title: "Extract LedgerBackend Trait from Existing Ledger"
      complexity: MEDIUM
      estimated_effort: "3 days"
      requirements_covered:
        - DCS-REQ-0005
      description: |
        Refactor the existing Ledger struct in crates/apm2-core/src/ledger/storage.rs
        to implement a new LedgerBackend trait. The existing behavior becomes
        SqliteLedgerBackend. All existing callers continue to work unchanged.
      acceptance_criteria:
        - "LedgerBackend trait defined with append, read_from, head, verify_chain methods"
        - "SqliteLedgerBackend wraps existing Ledger implementation"
        - "All existing ledger tests pass"
        - "No behavioral changes to existing code"
      files_to_modify:
        - path: "crates/apm2-core/src/ledger/storage.rs"
          changes: "Extract trait, rename struct"
        - path: "crates/apm2-core/src/ledger/mod.rs"
          changes: "Export new types"
      files_to_create:
        - path: "crates/apm2-core/src/ledger/backend.rs"
          purpose: "LedgerBackend trait definition"
      dependencies: []
      blocked_by: []

    - id: DCS-002
      phase: P0
      title: "Define SchemaRegistry Trait and InMemory Implementation"
      complexity: MEDIUM
      estimated_effort: "3 days"
      requirements_covered:
        - DCS-REQ-0003
      description: |
        Define the SchemaRegistry trait and provide a non-persistent in-memory
        implementation. Register initial schemas during kernel bootstrap.
      acceptance_criteria:
        - "SchemaRegistry trait defined"
        - "InMemorySchemaRegistry passes unit tests"
        - "Core kernel schemas registered on startup"
      files_to_create:
        - path: "crates/apm2-core/src/schema_registry/mod.rs"
        - path: "crates/apm2-core/src/schema_registry/traits.rs"
        - path: "crates/apm2-core/src/schema_registry/memory.rs"

    - id: DCS-012
      phase: P0
      title: "Integrate Schema Validation into Append Path"
      complexity: MEDIUM
      estimated_effort: "2 days"
      requirements_covered:
        - DCS-REQ-0003
      description: |
        Add schema_digest validation to LedgerBackend::append. Verify that
        incoming events match a registered schema. Fail-closed on unknown schemas.
      acceptance_criteria:
        - "Event append validates schema_digest"
        - "Unknown digest returns SchemaMismatch error"
      dependencies:
        - DCS-002

    - id: DCS-003
      phase: P0
      title: "Schema Extension for Consensus Columns"
      complexity: LOW
      estimated_effort: "1 day"
      requirements_covered:
        - DCS-REQ-0001
        - DCS-REQ-0006
      description: |
        Add nullable consensus columns to the SQLite schema. Create migration
        script that adds columns without breaking existing databases. Update
        EventRecord struct with new optional fields.
      acceptance_criteria:
        - "New columns: consensus_epoch, consensus_round, quorum_cert, schema_digest"
        - "Migration script runs on existing databases"
        - "Existing events remain readable"
        - "New fields default to NULL/None"
      files_to_modify:
        - path: "crates/apm2-core/src/ledger/schema.sql"
          changes: "Add new columns via ALTER TABLE"
        - path: "crates/apm2-core/src/ledger/storage.rs"
          changes: "Add fields to EventRecord"
      dependencies: []
      blocked_by: []

    - id: DCS-004
      phase: P1
      title: "Peer Discovery and Mutual TLS"
      complexity: MEDIUM
      estimated_effort: "4 days"
      requirements_covered:
        - TB-0004
      description: |
        Implement peer discovery via bootstrap nodes and optional gossip.
        Establish mutual TLS connections between nodes using rustls.
        Create network CA and node certificate infrastructure.
      acceptance_criteria:
        - "Nodes connect to bootstrap nodes on startup"
        - "TLS 1.3 mutual authentication"
        - "Certificate validation against network CA"
        - "Peer list maintained and refreshed"
        - "Connection pooling for reuse"
      files_to_create:
        - path: "crates/apm2-core/src/consensus/network.rs"
          purpose: "Network transport and TLS"
        - path: "crates/apm2-core/src/consensus/discovery.rs"
          purpose: "Peer discovery protocol"
      dependencies:
        - DCS-001
      blocked_by:
        - DCS-001

    - id: DCS-005
      phase: P1
      title: "Relay Holon and Reverse-TLS Tunneling"
      complexity: HIGH
      estimated_effort: "3 days"
      requirements_covered:
        - TB-0006
      description: |
        Implement the Relay Holon worker and the reverse-TLS management tunnel
        protocol. Allow workers behind NAT to maintain persistent outbound
        connections to a Relay.
      acceptance_criteria:
        - "Reverse-TLS tunnel established worker -> relay"
        - "mTLS authentication on tunnel"
        - "Relay routes messages to worker over tunnel"
      files_to_create:
        - path: "crates/apm2-core/src/consensus/relay.rs"
        - path: "crates/apm2-core/src/consensus/tunnel.rs"

    - id: DCS-013
      phase: P1
      title: "Leader-Based Replication (Basic)"
      complexity: MEDIUM
      estimated_effort: "2 days"
      requirements_covered:
        - DCS-REQ-0001
      description: |
        Implement simple event replication from leader to followers. Leader
        receives proposals and broadcasts to connected peers.
      acceptance_criteria:
        - "Proposals replicated to followers"
        - "Followers append replicated events to local log"
      dependencies:
        - DCS-004
        - DCS-005

    - id: DCS-007
      phase: P2
      title: "HotStuff/PBFT Consensus State Machine"
      complexity: HIGH
      estimated_effort: "3 days"
      requirements_covered:
        - DCS-REQ-0001
        - DCS-REQ-0007
      description: |
        Implement the core BFT consensus state machine (HotStuff or PBFT).
        Handle three-phase commit (pre-prepare, prepare, commit) logic.
      acceptance_criteria:
        - "State machine transitions correctly through 3 phases"
        - "Safety preserved under asynchronous network assumptions"
      files_to_create:
        - path: "crates/apm2-core/src/consensus/bft_machine.rs"

    - id: DCS-014
      phase: P2
      title: "Byzantine Equivocation Detection"
      complexity: MEDIUM
      estimated_effort: "2 days"
      requirements_covered:
        - DCS-REQ-0007
      description: |
        Implement detection for double-signing and conflicting proposals.
        Generate cryptographic evidence of Byzantine behavior.
      acceptance_criteria:
        - "Equivocation detected and evidence generated"
        - "Byzantine node identity included in evidence"
      dependencies:
        - DCS-007

    - id: DCS-009
      phase: P2
      title: "Anti-Entropy Gossip with Merkle Trees"
      complexity: MEDIUM
      estimated_effort: "3 days"
      requirements_covered:
        - DCS-REQ-0008
      description: |
        Implement Merkle tree-based digest exchange for identifying log
        divergence. Pull missing events from peers.
      acceptance_criteria:
        - "Merkle tree digests identify divergent ranges"
        - "Missing events transferred and verified"
      files_to_create:
        - path: "crates/apm2-core/src/consensus/anti_entropy.rs"
        - path: "crates/apm2-core/src/consensus/merkle.rs"

    - id: DCS-015
      phase: P2
      title: "HLC-Based CRDT Merge Operators"
      complexity: MEDIUM
      estimated_effort: "2 days"
      requirements_covered:
        - DCS-REQ-0004
      description: |
        Implement CRDT merge operators using Hybrid Logical Clocks (HLC) for
        LWW determinism. Record conflicts as MergeConflict events.
      acceptance_criteria:
        - "HLC-based LWW merge produces deterministic result"
        - "Conflicts recorded correctly"
      dependencies:
        - DCS-009

    - id: DCS-010
      phase: P3
      title: "HSM Integration for T1 Validator Keys"
      complexity: MEDIUM
      estimated_effort: "4 days"
      requirements_covered:
        - TB-0002
      description: |
        Integrate with HSM (e.g., YubiHSM, AWS CloudHSM) for T1 validator key
        storage. Keys never leave HSM; signing operations performed via HSM API.
        Fallback to software keys for development.
      acceptance_criteria:
        - "HSM interface trait abstraction"
        - "YubiHSM implementation (reference)"
        - "Software fallback for development"
        - "Key rotation via HSM"
        - "Configuration for HSM connection"
      files_to_create:
        - path: "crates/apm2-core/src/crypto/hsm.rs"
          purpose: "HSM interface trait"
        - path: "crates/apm2-core/src/crypto/yubihsm.rs"
          purpose: "YubiHSM implementation"
      dependencies:
        - DCS-007
      blocked_by:
        - DCS-007

    - id: DCS-011
      phase: P3
      title: "Operational Monitoring and Alerting"
      complexity: MEDIUM
      estimated_effort: "4 days"
      requirements_covered: []
      description: |
        Implement Prometheus metrics export for consensus health. Create Grafana
        dashboards. Add CLI commands for cluster status and diagnostics. Define
        alerting rules for critical conditions.
      acceptance_criteria:
        - "Prometheus metrics per 05_rollout_and_ops.yaml"
        - "Grafana dashboard JSON"
        - "apm2-cli consensus status command"
        - "Alert rules for quorum loss, Byzantine faults"
        - "Runbook for incident response"
      files_to_create:
        - path: "crates/apm2-core/src/consensus/metrics.rs"
          purpose: "Prometheus metrics"
        - path: "deploy/grafana/consensus-dashboard.json"
          purpose: "Grafana dashboard"
        - path: "docs/operations/consensus-runbook.md"
          purpose: "Operational runbook"
      files_to_modify:
        - path: "crates/apm2-cli/src/commands/consensus.rs"
          changes: "Add status and diagnostic commands"
      dependencies:
        - DCS-007
      blocked_by:
        - DCS-007

  dependency_graph: |
    Phase 0 (Foundation):
      DCS-001 ─┬─> DCS-004 ─┬─> DCS-005 ─┬─> DCS-007 ─┬─> DCS-008
               │            │            │            │
               └─> DCS-006 ─┘            │            ├─> DCS-010
                                         │            │
      DCS-002 ────────────────────────> DCS-009 ──────┘
                                         │
      DCS-003 ───────────────────────────┘            └─> DCS-011

    Parallel Opportunities:
      - DCS-001, DCS-002, DCS-003 can be done in parallel
      - DCS-006 can proceed after DCS-001 (parallel with DCS-004, DCS-005)
      - DCS-009 can proceed after DCS-002 and DCS-004 (parallel with DCS-007)
      - DCS-010, DCS-011 can be done in parallel after DCS-007

rfc_design_decisions:
  schema_version: "2026-02-01"
  template_version: "2026-01-23"

  phase_1_topic_taxonomy:
    required_minimum:
      - category: "system"
        pattern: "ledger.head"
      - category: "work"
        pattern: "work.<work_id>.events"
      - category: "gate"
        pattern: "gate.<work_id>.<changeset_digest>.<gate_id>"
      - category: "episode"
        pattern: "episode.<episode_id>.{lifecycle,tool,io}"
      - category: "defect"
        pattern: "defect.new"
    rules:
      - "defect id appears in payload; not in the topic string"
      - "gate topics MUST include changeset_digest and gate_id"
      - "topics are ASCII, dot-delimited, length-bounded; wildcard grammar is tightly constrained (no regex)"

  truth_plane_preconditions:
    description: |
      Truth-Plane Preconditions define the minimal ledger/CAS artifacts that must
      exist before a pulse topic is meaningful. If a trigger or artifact is
      missing from the truth-plane, it is labeled NEW WORK REQUIRED and must be
      tracked as a dependency.
    table:
      - category: "system"
        topic_pattern: "ledger.head"
        trigger_events:
          - "Any committed KernelEvent append (ledger seq advances)"
        required_pointers:
          - "ledger_cursor (seq_id)"
          - "event_hash (EventRecord.event_hash)"
          - "event_type"
        preconditions_status: "PARTIAL"
        evidence:
          - "crates/apm2-core/src/ledger/storage.rs:412-518"
          - "crates/apm2-core/src/ledger/storage.rs:719-736"
          - "proto/kernel_events.proto:52-93"
        new_work_required:
          - "Daemon outbox that emits pulses only after ledger commit"

      - category: "work"
        topic_pattern: "work.<work_id>.events"
        trigger_events:
          - "WorkOpened"
          - "WorkTransitioned"
          - "WorkCompleted"
          - "WorkAborted"
          - "WorkPrAssociated"
        required_pointers:
          - "ledger_cursor (seq_id)"
          - "event_hash"
          - "work_id"
          - "time_envelope_ref (if present)"
        preconditions_status: "SCHEMA_DEFINED"
        evidence:
          - "proto/kernel_events.proto:187-239"
        new_work_required:
          - "Pulse publisher mapping from WorkEvent -> topic"

      - category: "gate"
        topic_pattern: "gate.<work_id>.<changeset_digest>.<gate_id>"
        trigger_events:
          - "GateReceipt"
        required_pointers:
          - "ledger_cursor (seq_id)"
          - "event_hash"
          - "gate_id"
          - "changeset_digest"
          - "lease_id"
          - "work_id (derived via PolicyResolvedForChangeSet changeset_digest mapping)"
          - "payload_hash"
          - "evidence_bundle_hash"
        preconditions_status: "PARTIAL"
        evidence:
          - "proto/kernel_events.proto:723-791"
        new_work_required:
          - "Mapping of changeset_digest -> work_id for GateReceipt pulses"
          - "Pulse publisher mapping from GateReceipt -> topic"

      - category: "episode"
        topic_pattern: "episode.<episode_id>.lifecycle"
        trigger_events:
          - "EpisodeCreated"
          - "EpisodeStarted"
          - "EpisodeStopped"
          - "EpisodeQuarantined"
        required_pointers:
          - "episode_id"
          - "session_id"
          - "ledger_cursor (seq_id)"
          - "time_envelope_ref"
        preconditions_status: "NEW_WORK_REQUIRED"
        evidence:
          - "proto/apm2d_runtime_v1.proto:29-55"
          - "proto/kernel_events.proto:52-93"
        new_work_required:
          - "Add episode lifecycle events to kernel_events.proto OR add episode_id to existing session events"
          - "Ledger emission path for episode lifecycle events"

      - category: "episode"
        topic_pattern: "episode.<episode_id>.tool"
        trigger_events:
          - "ToolRequested"
          - "ToolDecided"
          - "ToolExecuted"
        required_pointers:
          - "episode_id"
          - "session_id"
          - "request_id"
          - "tool_name"
          - "tool_args_hash/result_hash"
          - "ledger_cursor (seq_id)"
          - "time_envelope_ref (if present)"
        preconditions_status: "NEW_WORK_REQUIRED"
        evidence:
          - "proto/kernel_events.proto:243-282"
        new_work_required:
          - "Add episode_id to tool events OR add mapping event (episode_id <-> session_id)"

      - category: "episode"
        topic_pattern: "episode.<episode_id>.io"
        trigger_events:
          - "StreamOutput (IPC only)"
        required_pointers:
          - "episode_id"
          - "stream_kind"
          - "seq"
          - "chunk_hash or cas_ref"
        preconditions_status: "NEW_WORK_REQUIRED"
        evidence:
          - "proto/apm2d_runtime_v1.proto:92-109"
        new_work_required:
          - "Define ledger event or CAS artifact for IO with hashes"

      - category: "defect"
        topic_pattern: "defect.new"
        trigger_events:
          - "DefectRecord (ledger event)"
        required_pointers:
          - "defect_id"
          - "defect_class"
          - "work_id"
          - "evidence_hashes"
          - "ledger_cursor (seq_id)"
        preconditions_status: "NEW_WORK_REQUIRED"
        evidence:
          - "crates/apm2-holon/src/defect.rs:382-437"
          - "proto/kernel_events.proto:52-93"
        new_work_required:
          - "Add defect event type to kernel_events.proto"
          - "Ledger emission path for DefectRecord"

  resource_governance:
    limits:
      max_subscriptions_per_connection: 16
      max_patterns_per_subscription: 16
      max_total_patterns_per_connection: 64
      max_pulses_per_sec_per_subscriber: 100
      max_burst_pulses_per_subscriber: 200
      max_queue_depth_per_subscriber: 256
      max_bytes_in_flight_per_subscriber: 1048576
      max_pulse_payload_bytes: 2048
    drop_policy:
      order:
        - "episode.<episode_id>.io"
        - "episode.<episode_id>.tool"
        - "episode.<episode_id>.lifecycle"
        - "work.<work_id>.events"
        - "gate.<work_id>.<changeset_digest>.<gate_id>"
        - "ledger.head"
      notes:
        - "No topic is guaranteed; drop policy is best-effort under backpressure."

  failure_modes_and_recovery:
    - mode: "loss"
      behavior: "Expected; pulses are lossy hints."
      recovery: "Consumer reconciles via ledger cursor catch-up."
    - mode: "reorder"
      behavior: "Allowed; authoritative ordering is ledger cursor."
      recovery: "Consumer replays ledger in order."
    - mode: "duplication"
      behavior: "Allowed; pulses may repeat."
      recovery: "Consumer dedupes by pulse_id + ledger_cursor."
    - mode: "daemon_restart"
      behavior: "Subscriptions are dropped; in-flight pulses lost."
      recovery: "Client reconnects and resubscribes with since_ledger_cursor."
    - mode: "consumer_reconnect"
      behavior: "Pulse replay buffer optional and non-authoritative."
      recovery: "Ledger catch-up remains the source of truth."

  htf_semantics:
    ordering_authority: "LedgerTime (ledger cursor/seq)"
    expiry_and_windows_authority: "MonotonicTicks"
    advisory_only: "CausalTime/HLC"
    observational_only: "Wall time"
  decisions:
    - id: "DD-HEF-0001"
      title: "Pulse plane is non-authoritative and lossy"
      statement: |
        The Pulse Plane is a lossy hint layer derived strictly from committed
        ledger+CAS artifacts. Pulses are never admissive or authoritative; every
        consumer MUST verify by reading the ledger and CAS.
      context: |
        FAC authority is ledger+CAS only. Pulses exist to reduce polling and
        accelerate UX, not to replace proofs or receipts.
      alternatives:
        - id: "ALT-HEF-0001-A"
          name: "Authoritative pulse messages"
          pros:
            - "Lower latency"
          cons:
            - "Violates FAC truth model; enables spoofed admission"
          security_tradeoffs:
            - "High risk: pulse forgery becomes admission bypass"
          operability_tradeoffs:
            - "Higher coupling to delivery guarantees"
      chosen_rationale: "Maintains FAC truth invariants and fail-closed posture."
      impacted_requirement_ids:
        - "REQ-HEF-0001"
      evidence_ids:
        - "EVID-HEF-0001"

    - id: "DD-HEF-0002"
      title: "PulseEnvelope v1 schema with strict bounds"
      statement: |
        Define PulseEnvelopeV1 with bounded fields, explicit dedupe identifiers,
        and references to ledger cursor and CAS hashes. Unknown fields are
        rejected (fail-closed).
      context: |
        Pulses must be small and safe to parse under adversarial input.
      alternatives:
        - id: "ALT-HEF-0002-A"
          name: "Free-form JSON payloads"
          pros: ["Fast to prototype"]
          cons: ["Unbounded size, weak schema guarantees"]
          security_tradeoffs: ["Higher injection/DoS risk"]
          operability_tradeoffs: ["Harder versioning"]
      chosen_rationale: "Bounded protobuf with strict decode enables safe IPC."
      impacted_requirement_ids:
        - "REQ-HEF-0002"
      evidence_ids:
        - "EVID-HEF-0004"

    - id: "DD-HEF-0003"
      title: "Topic taxonomy + constrained wildcard grammar"
      statement: |
        Topics are ASCII, dot-delimited, length-bounded. Wildcards are limited to
        per-segment '*' and an optional terminal '>' (matches remaining segments),
        with a maximum of 2 wildcards per pattern. Regex and empty segments are
        forbidden.
      context: |
        Unbounded wildcard matching is a DoS vector and complicates ACL checks.
      alternatives:
        - id: "ALT-HEF-0003-A"
          name: "Regex matching"
          pros: ["Flexible filtering"]
          cons: ["High CPU cost, hard to secure"]
          security_tradeoffs: ["Regex DoS risk"]
          operability_tradeoffs: ["Harder to reason about ACLs"]
      chosen_rationale: "Simple bounded grammar keeps matching predictable."
      impacted_requirement_ids:
        - "REQ-HEF-0007"
      evidence_ids:
        - "EVID-HEF-0007"

    - id: "DD-HEF-0004"
      title: "Default-deny subscription ACLs and daemon-only publish"
      statement: |
        Operator connections may subscribe broadly; session connections are
        restricted to their own episode.<episode_id>.* and work.<work_id>.events
        topics by default. Capability manifests may further restrict (never
        broaden) session subscriptions. Sessions never publish pulse topics;
        daemon-only publish from outbox after ledger commit.
      context: |
        Pulse traffic crosses the IPC boundary and must preserve RFC-0017 trust
        boundaries and SoD. Enforcement points: SubscribePulse handling in
        session_dispatch.rs (after session_token validation) and in
        dispatch.rs for operator.sock; pulse publisher applies ACL filtering
        per-connection before enqueue.
      alternatives:
        - id: "ALT-HEF-0004-A"
          name: "Allow sessions to publish pulses"
          pros: ["Simpler integration"]
          cons: ["Authority confusion, spoofing risk"]
          security_tradeoffs: ["Untrusted sessions could emit fake pulses"]
          operability_tradeoffs: ["Hard to audit"]
      chosen_rationale: "Preserves daemon authority and trust boundary."
      impacted_requirement_ids:
        - "REQ-HEF-0003"
      evidence_ids:
        - "EVID-HEF-0002"

    - id: "DD-HEF-0005"
      title: "Resource governance and drop policy"
      statement: |
        Enforce caps at the daemon boundary: max subscriptions per connection,
        max patterns, max pulses/sec per subscriber, max queue depth, and max
        bytes in-flight. Concrete Phase-1 limits are listed in
        resource_governance.limits. Backpressure triggers bounded drops with
        defined priority (episode.<id>.io drops first).
      context: |
        Pulses are optional hints; availability must never degrade daemon
        correctness.
      alternatives:
        - id: "ALT-HEF-0005-A"
          name: "Unlimited queues"
          pros: ["No drops"]
          cons: ["DoS risk, memory exhaustion"]
          security_tradeoffs: ["High availability risk"]
          operability_tradeoffs: ["Unbounded memory"]
      chosen_rationale: "Fail-closed and bounded resource use."
      impacted_requirement_ids:
        - "REQ-HEF-0004"
      evidence_ids:
        - "EVID-HEF-0007"

    - id: "DD-HEF-0006"
      title: "Information disclosure minimization"
      statement: |
        Pulse payloads carry only opaque IDs, hashes, and bounded metadata.
        File paths, tool arguments, diffs, or secrets are forbidden. No
        human-facing note field exists in Phase 1. CAS access remains policy
        gated; pulses do not grant read access.
      context: |
        Pulse traffic is cross-boundary and must be safe by default.
      alternatives:
        - id: "ALT-HEF-0006-A"
          name: "Include human-readable notes"
          pros: ["Convenient UX"]
          cons: ["Leakage risk"]
          security_tradeoffs: ["Sensitive data exposure"]
          operability_tradeoffs: ["Redaction complexity"]
      chosen_rationale: "Minimize disclosure and keep CAS as the only data plane."
      impacted_requirement_ids:
        - "REQ-HEF-0005"
      evidence_ids:
        - "EVID-HEF-0001"

    - id: "DD-HEF-0007"
      title: "Outbox invariant + HTF semantics"
      statement: |
        Pulse emission order is: CAS persist -> ledger commit -> outbox enqueue
        -> pulse publish. Ordering is authoritative by LedgerTime (cursor/seq);
        expiry and backoff windows use MonotonicTicks; HLC is advisory only; wall
        time is observational.
      context: |
        Pulses must never outrun authoritative truth and must respect HTF.
      alternatives:
        - id: "ALT-HEF-0007-A"
          name: "Emit pulses before ledger commit"
          pros: ["Lower latency"]
          cons: ["False positives; violates truth-plane"]
          security_tradeoffs: ["Admission bypass risk"]
          operability_tradeoffs: ["Harder reconciliation"]
      chosen_rationale: "Preserves authoritative ordering and auditability."
      impacted_requirement_ids:
        - "REQ-HEF-0006"
      evidence_ids:
        - "EVID-HEF-0006"

    - id: "DD-HEF-0008"
      title: "Subscribe/resume semantics over ProtocolServer"
      statement: |
        Add SubscribePulse/Unsubscribe messages to ProtocolServer. Subscriptions
        include since_ledger_cursor. Consumers reconcile via ledger catch-up; any
        pulse replay buffer is optional and non-authoritative. JSON framing is
        never accepted on ProtocolServer sockets.
      context: |
        Reconnect/resume must be ledger-driven and must respect DD-009.
      alternatives:
        - id: "ALT-HEF-0008-A"
          name: "Durable broker replay"
          pros: ["Higher delivery probability"]
          cons: ["Out of Phase 1 scope; adds authority ambiguity"]
          security_tradeoffs: ["New infra attack surface"]
          operability_tradeoffs: ["Operational complexity"]
      chosen_rationale: "Keeps Phase 1 minimal and authority clear."
      impacted_requirement_ids:
        - "REQ-HEF-0008"
      evidence_ids:
        - "EVID-HEF-0003"

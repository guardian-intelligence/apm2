rfc_problem_and_imports:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"

  problem_statement:
    summary: "Slow Rust builds across multiple worktrees waste developer time"
    context: |
      The apm2 project uses a worktree-based development model where developers
      maintain multiple git worktrees for parallel work. This creates several
      build performance challenges:

      1. **Redundant Compilation**: Each worktree has its own target/ directory,
         causing dependencies to be recompiled for each worktree even though they
         produce identical artifacts.

      2. **Slow Linking**: Rust's default linker (ld) is a significant bottleneck,
         especially for debug builds with many dependencies. The mold linker is
         already installed (/usr/bin/mold) but not configured.

      3. **CI Misconfiguration for Local Dev**: The CI workflow correctly sets
         CARGO_INCREMENTAL=0 for reproducible CI builds, but developers may
         inadvertently copy this setting locally, disabling incremental compilation.

      4. **Sequential Test Execution**: cargo test runs tests sequentially within
         each binary. cargo-nextest provides 2-3x faster execution by running tests
         in parallel at the process level.

      These issues compound across worktrees: a developer with 3 worktrees
      experiences 3x the redundant compilation time.

    observed_symptoms:
      - symptom_id: SYMP-001
        description: |
          Fresh builds in new worktrees take excessive time even when
          dependencies were recently compiled in another worktree.
        evidence: "Manual observation: dependencies recompile in each worktree"

      - symptom_id: SYMP-002
        description: |
          Link phase dominates build time for incremental changes.
        evidence: "cargo build --timings shows linker as bottleneck"

      - symptom_id: SYMP-003
        description: |
          Test runs are slower than necessary despite available parallelism.
        evidence: "CONTRIBUTING.md mentions 30s time budget for unit tests"

    goals:
      - "Reduce fresh worktree build time by leveraging shared compilation cache"
      - "Reduce link time by configuring the mold linker"
      - "Document and configure faster test execution with cargo-nextest"
      - "Ensure local development uses incremental compilation"
      - "Document optimization strategies in CONTRIBUTING.md"
    non_goals:
      - "Modify CI workflows to use sccache (CI has different caching needs)"
      - "Change the project's dependency structure to reduce compilation"
      - "Profile and optimize individual crate compilation times"
      - "Implement build caching at the CI level (GitHub Actions cache handles this)"

  implementation_note: |
    All changes are configuration and documentation only. No Rust code changes
    are required. The optimizations are:
    1. .cargo/config.toml: Configure mold linker
    2. CONTRIBUTING.md: Document sccache, nextest, and local optimization tips
    3. Shell profile examples for RUSTC_WRAPPER and CARGO_INCREMENTAL

  technical_context:
    mold_linker:
      description: |
        mold is a modern linker that is significantly faster than ld or gold.
        It achieves this through aggressive parallelization and efficient
        memory usage.
      installation_check: "which mold returns /usr/bin/mold"
      configuration: |
        # .cargo/config.toml
        [target.x86_64-unknown-linux-gnu]
        linker = "clang"
        rustflags = ["-C", "link-arg=-fuse-ld=mold"]
      expected_speedup: "2-5x faster link times for debug builds"

    sccache:
      description: |
        sccache is a compiler wrapper that caches compilation results.
        When configured with RUSTC_WRAPPER=sccache, it stores compiled
        artifacts in a cache (local disk by default) and reuses them
        across different Cargo target directories.
      installation: "cargo install sccache"
      configuration: |
        # Shell profile (.bashrc or .zshrc)
        export RUSTC_WRAPPER=sccache
      benefits:
        - "Shared cache across git worktrees"
        - "No file locking conflicts (unlike shared CARGO_TARGET_DIR)"
        - "Automatic cache management"
      cache_location: "~/.cache/sccache (default)"

    cargo_nextest:
      description: |
        cargo-nextest is a next-generation test runner for Rust that
        executes tests in parallel at the process level, providing
        significant speedups for test suites.
      installation: "cargo install cargo-nextest"
      usage: "cargo nextest run"
      expected_speedup: "2-3x faster test execution"
      compatibility: "Drop-in replacement for cargo test"

    incremental_compilation:
      description: |
        Incremental compilation allows rustc to reuse work from previous
        compilations. CI disables this (CARGO_INCREMENTAL=0) for reproducibility,
        but local development benefits from having it enabled.
      local_setting: "export CARGO_INCREMENTAL=1  # or simply unset (1 is the default)"
      ci_setting: "CARGO_INCREMENTAL=0 (correct for CI)"
      valid_values:
        - "0: Disable incremental compilation (CI setting)"
        - "1: Enable incremental compilation (local default)"
      note: |
        Developers should NOT copy CI environment settings directly.
        Local development and CI have different optimization goals.
        When CARGO_INCREMENTAL is unset, Cargo defaults to incremental=1
        for debug builds. Explicitly setting it documents intent.

  imports:
    prd_requirements: []
    # NOTE: This is a maintenance RFC for build optimization.
    # Requirements are defined inline as RFC-local requirements.

  rfc_local_requirements:
    rationale: |
      These requirements are specific to this maintenance RFC. Build optimization
      is foundational infrastructure that improves developer productivity across
      all development activities.

    requirements:
      - id: PERF-001
        type: PERFORMANCE
        title: "Configure mold linker for faster link times"
        statement: |
          The project MUST configure mold as the default linker on Linux
          (x86_64-unknown-linux-gnu target) to reduce link times.
        acceptance_criteria:
          - ".cargo/config.toml contains mold linker configuration"
          - "cargo build uses mold linker (verify via cargo build -vv | grep mold)"
          - "Link time reduced compared to default ld linker"
        verification:
          command: "cargo build -vv 2>&1 | grep -q mold && echo 'mold configured'"
          pass_condition: "Output shows 'mold configured'"

      - id: PERF-002
        type: PERFORMANCE
        title: "Document sccache setup for shared compilation cache"
        statement: |
          The project MUST document how to configure sccache for shared
          compilation caching across worktrees. This enables artifact reuse
          without the file locking issues of a shared target directory.
        acceptance_criteria:
          - "CONTRIBUTING.md documents sccache installation"
          - "CONTRIBUTING.md documents RUSTC_WRAPPER=sccache configuration"
          - "Documentation explains benefits for multi-worktree development"
        verification:
          command: "grep -q sccache CONTRIBUTING.md"
          pass_condition: "sccache documentation exists"

      - id: PERF-003
        type: PERFORMANCE
        title: "Document cargo-nextest for faster test execution"
        statement: |
          The project MUST document cargo-nextest as the recommended test
          runner for local development, explaining its performance benefits.
        acceptance_criteria:
          - "CONTRIBUTING.md documents cargo-nextest installation"
          - "CONTRIBUTING.md shows usage: cargo nextest run"
          - "Documentation explains parallel execution benefits"
        verification:
          command: "grep -q nextest CONTRIBUTING.md"
          pass_condition: "nextest documentation exists"

      - id: PERF-004
        type: PERFORMANCE
        title: "Document incremental compilation settings"
        statement: |
          The project MUST document that local development should use
          CARGO_INCREMENTAL=1, explaining the difference from CI settings.
        acceptance_criteria:
          - "CONTRIBUTING.md explains CARGO_INCREMENTAL setting"
          - "Documentation clarifies CI vs local development settings"
          - "Warning against copying CI environment settings blindly"
        verification:
          command: "grep -q CARGO_INCREMENTAL CONTRIBUTING.md"
          pass_condition: "Incremental compilation documentation exists"

      - id: PERF-005
        type: ENHANCEMENT
        title: "Provide recommended shell profile configuration"
        statement: |
          The project SHOULD provide a recommended shell profile snippet
          that developers can source or add to their profile for optimal
          build performance.
        acceptance_criteria:
          - "CONTRIBUTING.md contains shell configuration snippet"
          - "Snippet includes RUSTC_WRAPPER and CARGO_INCREMENTAL"
          - "Snippet is copy-pasteable"
        verification:
          command: "grep -A5 'export RUSTC_WRAPPER' CONTRIBUTING.md"
          pass_condition: "Shell snippet exists"

      - id: PERF-006
        type: PERFORMANCE
        title: "Add release build job to CI workflow"
        statement: |
          The project MUST have a CI job that performs explicit release builds
          to catch optimization-related bugs not visible in debug builds.
        acceptance_criteria:
          - "CI workflow contains 'Release Build' job"
          - "Job runs cargo build --workspace --release"
          - "Job passes on all PRs"
        verification:
          command: "grep -q 'cargo build --workspace --release' .github/workflows/ci.yml"
          pass_condition: "Release build job exists"

rfc_contracts_and_versioning:
  schema_version: "2026-01-24"
  template_version: "2026-01-24"

  contracts:
    - id: CONTRACT-001
      name: "xtask check output contract"
      description: |
        The `cargo xtask check` command outputs status information and returns
        appropriate exit codes.
      interface:
        output_format: "Text status lines with [ok], [!], [X], [..] prefixes"
        exit_codes:
          0: "All checks passed, PR ready to merge"
          1: "CI failed, changes requested, or PR not ready"
          2: "Infrastructure error (gh CLI unavailable, network failure, auth error)"
        error_handling:
          gh_cli_missing: "Exit 2 with message: 'gh CLI not found. Install from https://cli.github.com/'"
          network_failure: "Exit 2 with message: 'Failed to reach GitHub API. Check network connection.'"
          auth_failure: "Exit 2 with message: 'GitHub authentication failed. Run: gh auth login'"
          json_parse_error: "Exit 1 with message: 'Failed to parse CI status. Treating as pending.'"
          malformed_api_response: "Log warning, treat missing fields as defaults, continue"
      backward_compatible: true
      notes: |
        Output format unchanged; only internal parsing logic fixed.
        Exit code 2 is new for infrastructure errors (distinguishes from CI failures).
        Malformed API responses are handled gracefully with defaults.

    - id: CONTRACT-002
      name: "xtask push status creation contract"
      description: |
        The `cargo xtask push` command creates GitHub commit statuses for
        AI review gates.
      interface:
        statuses_created:
          - context: "ai-review/security"
            initial_state: "pending"
          - context: "ai-review/code-quality"
            initial_state: "pending"
      backward_compatible: true
      notes: "Contract unchanged; fix ensures statuses are actually created"

    - id: CONTRACT-003
      name: "xtask review quality invocation contract"
      description: |
        The `cargo xtask review quality <PR_URL>` command invokes Codex for
        code quality review.
      interface:
        input: "PR URL"
        behavior: "Invokes Codex review against main branch"
      backward_compatible: true
      notes: "Contract unchanged; fix corrects Codex CLI arguments"

    - id: CONTRACT-004
      name: "xtask commit pre-check contract (new)"
      description: |
        The `cargo xtask commit` command runs local checks before committing.
      interface:
        checks_run:
          - "cargo fmt --check"
          - "cargo clippy --all-targets -- -D warnings"
          - "cargo semver-checks (if available)"
        flags:
          --skip-checks: "Bypass all pre-commit checks"
      backward_compatible: true
      notes: "New behavior; --skip-checks provides escape hatch"

  versioning:
    strategy: "No version bump required for bug fixes"
    rationale: |
      These are bug fixes that restore intended behavior. The xtask commands
      are internal development tools, not public APIs. Users may notice:
      - check command correctly detecting CI failures
      - push command actually creating statuses
      - review command working with Codex
      - commit command running local checks (opt-out via --skip-checks)

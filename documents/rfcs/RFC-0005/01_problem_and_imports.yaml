rfc_problem_and_imports:
  schema_version: "2026-01-24"
  template_version: "2026-01-24"

  problem_statement:
    summary: "Critical bugs in xtask workflow commands prevent PR auto-merge"
    context: |
      The dev-eng-ticket workflow is broken due to 3 critical bugs in xtask commands
      that prevent the automated development workflow from functioning correctly:

      1. `cargo xtask check` reports "CI running" when CI has actually failed
      2. `cargo xtask push` claims to create AI review statuses but silently fails
      3. `cargo xtask review quality` uses non-existent CLI flags for Codex

      As a result, PRs cannot auto-merge because required status checks are never
      created or correctly reported. This blocks the internally closed-loop software
      factory described in PRD-0004.

    observed_symptoms:
      - bug_id: BUG-001
        command: "cargo xtask check"
        symptom: |
          Reports "[..] CI checks running" when CI has actually failed.
          Output shows "Unknown JSON field: conclusion" warning.
        root_cause: |
          The get_ci_status function uses string matching on JSON output rather
          than proper JSON deserialization. When gh CLI outputs warnings or the
          JSON structure differs from expectations, the status detection fails.
        affected_file: "xtask/src/tasks/check.rs"
        affected_lines: "215-248 (get_ci_status function)"
        reproduction:
          prerequisites:
            - "Be on a ticket branch with an open PR"
            - "PR must have at least one CI check that has failed"
          steps:
            - "Run: cargo xtask check"
            - "Observe output shows '[..] CI checks running' instead of '[X] CI checks failed'"
          expected_output: |
            Status:
            -------
              [ok] Working directory clean
              [ok] PR is open
              [X] CI checks failed
          actual_output: |
            Status:
            -------
              [ok] Working directory clean
              [ok] PR is open
              [..] CI checks running
        verification_after_fix:
          command: "cargo xtask check"
          pass_criteria:
            - "Output shows '[X] CI checks failed' when CI has failed"
            - "Exit code is non-zero (echo $? returns 1)"
        code_location: |
          xtask/src/tasks/check.rs:233-238 - String matching checks for state
          xtask/src/tasks/check.rs:240-245 - String matching checks for conclusion
          The issue: string matching is fragile; if JSON includes unexpected
          formatting or fields, the patterns don't match.

      - bug_id: BUG-002
        command: "cargo xtask push"
        symptom: |
          Outputs "Created pending status: ai-review/security" but status is not
          actually created on GitHub. The gh api command fails with "accepts 1 arg(s),
          received 4" but this error is ignored.
        root_cause: |
          The xshell cmd! macro splits the description argument on spaces, causing
          "Waiting for security review" to become 4 separate arguments. Additionally,
          .is_ok() only checks if the command was executed, not if it succeeded.
        affected_file: "xtask/src/tasks/push.rs"
        affected_lines: "366-390 (create_pending_statuses function)"
        reproduction:
          prerequisites:
            - "Be on a ticket branch with commits to push"
            - "Have gh CLI authenticated"
          steps:
            - "Run: cargo xtask push"
            - "Observe output claims 'Created pending status: ai-review/security'"
            - "Run: gh api /repos/OWNER/REPO/commits/$(git rev-parse HEAD)/statuses | jq '.[].context'"
            - "Observe ai-review/security is NOT in the list"
          expected_output: |
            Creating pending status checks...
                Created pending status: ai-review/security
            (Status should exist on GitHub)
          actual_output: |
            Creating pending status checks...
                Created pending status: ai-review/security
            (Status does NOT exist on GitHub - silent failure)
        verification_after_fix:
          command: "gh api /repos/{owner}/{repo}/commits/{sha}/statuses | jq '.[].context'"
          pass_criteria:
            - "Output includes 'ai-review/security'"
            - "Output includes 'ai-review/code-quality'"
        code_location: |
          xtask/src/tasks/push.rs:368-373 - The cmd! macro call:
            cmd!(sh, "gh api --method POST {endpoint} -f state=pending -f context=ai-review/security -f description=Waiting for security review")
          The issue: "-f description=Waiting for security review" splits into
          4 args: "-f", "description=Waiting", "for", "security", "review"

      - bug_id: BUG-003
        command: "cargo xtask review quality"
        symptom: |
          Fails with "error: unexpected argument '--approval-mode' found".
          Codex CLI does not have an --approval-mode flag.
        root_cause: |
          The Codex CLI invocation uses incorrect arguments. The correct syntax
          is `codex review --base main` not `codex -m o3 --approval-mode full-auto`.
        affected_file: "xtask/src/tasks/review.rs"
        affected_lines: "291-293 (run_ai_review function, Quality branch)"
        reproduction:
          prerequisites:
            - "Have codex CLI installed"
            - "Have a valid PR URL"
          steps:
            - "Run: cargo xtask review quality https://github.com/owner/repo/pull/123"
            - "Observe error output"
          expected_output: |
            Running Code Quality review for: https://github.com/owner/repo/pull/123
            ...
            Codex code quality review completed.
          actual_output: |
            Running Code Quality review for: https://github.com/owner/repo/pull/123
            ...
            error: unexpected argument '--approval-mode' found
            Usage: codex [OPTIONS] [PROMPT]
        verification_after_fix:
          command: "cargo xtask review quality <PR_URL>"
          pass_criteria:
            - "No 'unexpected argument' errors"
            - "Codex review executes (or gracefully reports Codex not available)"
        code_location: |
          xtask/src/tasks/review.rs:291-292 - Incorrect invocation:
            .args(["-m", "o3", "--approval-mode", "full-auto", &escaped_prompt])
          Also in push.rs:324-325 (same pattern in trigger_ai_reviews)

    goals:
      - "Fix CI failure detection in check command"
      - "Fix AI review status creation in push command"
      - "Fix Codex CLI invocation in review command"
      - "Add local pre-commit checks to commit command (semver, fmt, clippy)"
    non_goals:
      - "Redesign the xtask command architecture"
      - "Add new xtask commands"
      - "Change branch protection rules"

  implementation_note: |
    All fixes are localized bug fixes within existing xtask command files.
    No architectural changes required. Each bug fix is independent and can
    be implemented and tested in isolation. The commit command enhancement
    is a preventive measure to catch issues locally before push.

  technical_context:
    gh_pr_checks_json_schema:
      description: |
        Output schema for `gh pr checks <branch> --json name,state,conclusion`.
        This is an array of check run objects.
      sample_output: |
        [
          {
            "name": "CI / Build and Test",
            "state": "COMPLETED",
            "conclusion": "SUCCESS"
          },
          {
            "name": "Semver Check",
            "state": "COMPLETED",
            "conclusion": "FAILURE"
          },
          {
            "name": "Security Scan",
            "state": "PENDING",
            "conclusion": null
          }
        ]
      field_values:
        state:
          - "PENDING"      # Check is queued or waiting
          - "IN_PROGRESS"  # Check is currently running
          - "QUEUED"       # Check is queued
          - "COMPLETED"    # Check has finished
        conclusion:
          - "SUCCESS"      # Check passed
          - "FAILURE"      # Check failed
          - "CANCELLED"    # Check was cancelled
          - "TIMED_OUT"    # Check timed out
          - "SKIPPED"      # Check was skipped
          - "NEUTRAL"      # Check completed with neutral status
          - "ACTION_REQUIRED"  # Check requires action
          - null           # No conclusion yet (check not completed)
      edge_cases:
        - "Empty array [] when no checks are configured"
        - "conclusion is null when state is PENDING/IN_PROGRESS"
        - "gh CLI may output warnings before JSON (handle gracefully)"
        - "conclusion field missing entirely (treat as Success for COMPLETED state)"
        - "state field missing (treat entire check as Pending)"
      malformed_response_handling:
        strategy: "Fail-open with defaults"
        rationale: |
          When GitHub API returns unexpected data, we use safe defaults rather
          than blocking the workflow. This is appropriate because:
          1. CI will catch real failures eventually
          2. Blocking on data issues creates friction without benefit
          3. Users can manually investigate if status seems wrong
        defaults:
          missing_conclusion_on_completed: "Assume Success (fail-open)"
          missing_state: "Assume Pending (safe default)"
          unparseable_json: "Assume Pending (trigger manual check)"
          empty_checks_array: "Assume Pending (checks may not be configured yet)"

    gh_api_status_creation:
      description: |
        GitHub API for creating commit statuses.
        POST /repos/{owner}/{repo}/statuses/{sha}
      request_format: |
        gh api --method POST /repos/{owner}/{repo}/statuses/{sha} \
          -f state=pending \
          -f context=ai-review/security \
          -f description="Waiting for security review"
      note: |
        The -f flag requires key=value format. Multi-word values must be
        quoted or the command splits them into separate positional arguments.
        With xshell cmd! macro, use interpolated variables for safety:
          let description = "Waiting for security review";
          cmd!(sh, "gh api --method POST {endpoint} -f state=pending -f context={context} -f description={description}")

    codex_cli_syntax:
      description: |
        Codex CLI syntax for code review operations.
      correct_invocation: |
        codex review --base main
      incorrect_invocation: |
        codex -m o3 --approval-mode full-auto <prompt>
      note: |
        The --approval-mode flag does not exist in Codex CLI.
        The `codex review` subcommand handles code review against a base branch.

  imports:
    prd_requirements: []
    # NOTE: This is a maintenance RFC for bug fixes to existing xtask tooling.
    # The xtask workflow predates the formal PRD system and has no associated PRD.
    # Requirements are defined inline below as RFC-local requirements.

  rfc_local_requirements:
    rationale: |
      These requirements are specific to this maintenance RFC. The xtask workflow
      is internal developer tooling that predates the formal PRD/RFC system.
      Bug fixes to this tooling do not map to product requirements but are
      essential for developer productivity and CI/CD reliability.

    requirements:
      - id: MAINT-001
        type: RELIABILITY
        title: "CI status detection must reflect actual CI state"
        statement: |
          The `cargo xtask check` command MUST correctly report CI check status.
          When CI checks have failed, the command MUST report failure (not "running").
          The command MUST parse GitHub API JSON responses robustly.
        acceptance_criteria:
          - "When CI has conclusion=FAILURE, output shows '[X] CI checks failed'"
          - "Exit code is non-zero when CI has failed"
          - "JSON parsing handles missing/optional fields gracefully"
        verification:
          command: "cargo xtask check"
          pass_condition: "Output matches actual CI state; exit code reflects status"

      - id: MAINT-002
        type: RELIABILITY
        title: "GitHub status creation must succeed or report failure"
        statement: |
          The `cargo xtask push` command MUST create GitHub commit statuses for
          AI review gates. If status creation fails, the command MUST report the
          error visibly (not silently claim success).
        acceptance_criteria:
          - "ai-review/security status is created on GitHub"
          - "ai-review/code-quality status is created on GitHub"
          - "Status creation failures are reported to the user"
          - "gh api arguments are correctly escaped for multi-word values"
        verification:
          command: "gh api /repos/{owner}/{repo}/commits/{sha}/statuses | jq '.[].context'"
          pass_condition: "Output includes ai-review/security and ai-review/code-quality"

      - id: MAINT-003
        type: RELIABILITY
        title: "Codex CLI invocation must use valid arguments"
        statement: |
          The `cargo xtask review quality` command MUST invoke Codex with valid
          CLI arguments. The command MUST not use non-existent flags.
        acceptance_criteria:
          - "Codex is invoked without argument errors"
          - "Review executes successfully when Codex CLI is available"
        verification:
          command: "cargo xtask review quality <PR_URL>"
          pass_condition: "No 'unexpected argument' errors"

      - id: MAINT-004
        type: ENHANCEMENT
        title: "Pre-commit checks catch issues before CI"
        statement: |
          The `cargo xtask commit` command SHOULD run local validation checks
          (fmt, clippy, semver-checks) before creating a commit. This catches
          common issues locally, reducing CI failures and iteration time.
          A --skip-checks flag MUST be available for emergency bypasses.
        acceptance_criteria:
          - "cargo fmt --check runs before commit"
          - "cargo clippy --all-targets -- -D warnings runs before commit"
          - "cargo semver-checks runs if available (warn if not installed)"
          - "--skip-checks flag bypasses all pre-commit checks"
          - "Clear error messages indicate which check failed"
        verification:
          command: "cargo xtask commit 'test message'"
          pass_condition: "Checks run before commit; failures block commit unless --skip-checks"
        rationale: |
          This is a preventive enhancement rather than a bug fix. It is included
          in this RFC because it directly addresses the root cause of workflow
          failures: issues caught late in CI rather than early locally. The
          fail-fast principle improves developer productivity.

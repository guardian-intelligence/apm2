rfc_contracts_and_versioning:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  contracts:
    - id: "CTR-0001"
      name: "Episode CapabilityManifest Schema"
      type: "ARTIFACT_SCHEMA"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Adding new capability types is backward compatible"
          - "Removing capability types requires major version bump"
      schemas:
        - id: "SCH-0001"
          path: "crates/apm2-daemon/src/episode/capability.rs"
          format: "RUST_STRUCT"
          description: "Capability manifest used for episode tool mediation (allowlists + CAS hash allowlist); serialized as CAS artifact and referenced by hash"
      evidence_ids: []

    - id: "CTR-0002"
      name: "ToolLogIndexV1 Schema"
      type: "ARTIFACT_SCHEMA"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Adding metadata fields is backward compatible"
      schemas:
        - id: "SCH-0002"
          format: "INLINE_SPEC"
          description: "CAS artifact schema for tool log indices (hash-first audit); NET_NEW for RFC-0019"
          required_fields:
            - "schema (apm2.tool_log_index.v1)"
            - "schema_version (semver)"
            - "episode_id"
            - "tool_execution_receipt_hashes (canonical order; chunkable)"
            - "counts + budget consumption (bounded metadata)"
      evidence_ids: []

    - id: "CTR-0003"
      name: "ProjectionReceiptRecorded Event"
      type: "KERNEL_EVENT"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Event fields are append-only"
          - "Removing fields requires major version bump"
      schemas:
        - id: "SCH-0003"
          path: "proto/kernel_events.proto"
          format: "PROTOBUF"
          description: "NET_NEW: kernel event for anchoring projection receipts after external writes; will be defined in kernel_events.proto"
      evidence_ids: []

    - id: "CTR-0004"
      name: "WorkspaceManager Interface"
      type: "INTERNAL_API"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Method signatures stable within major version"
      schemas:
        - id: "SCH-0004"
          path: "crates/apm2-daemon/src/episode/workspace.rs"
          format: "RUST_TRAIT"
          description: "Interface for workspace lifecycle management"
      evidence_ids: []

    - id: "CTR-0005"
      name: "ViewCommitment Schema"
      type: "ARTIFACT_SCHEMA"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Fields are append-only"
          - "Removing fields requires major version bump"
      schemas:
        - id: "SCH-0005"
          path: "schemas/apm2/view_commitment.schema.json"
          format: "JSON_SCHEMA"
          description: "Glossary-aligned schema for apm2.view_commitment.v1"
      evidence_ids: []

    - id: "CTR-0006"
      name: "SummaryReceipt Schema"
      type: "ARTIFACT_SCHEMA"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Fields are append-only"
          - "Removing fields requires major version bump"
      schemas:
        - id: "SCH-0006"
          path: "schemas/apm2/summary_receipt.schema.json"
          format: "JSON_SCHEMA"
          description: "Lossy-but-verifiable summary receipt with loss profile + selectors"
      evidence_ids: []

    - id: "CTR-0007"
      name: "ChangeSetBundleV1 Schema"
      type: "ARTIFACT_SCHEMA"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Fields are append-only"
          - "Removing fields requires major version bump"
      schemas:
        - id: "SCH-0007"
          path: "schemas/apm2/changeset_bundle_v1.yaml"
          format: "YAML_SCHEMA"
          description: "Canonical bundle describing a changeset/diff stored in CAS"
      evidence_ids: []

    - id: "CTR-0008"
      name: "ReviewArtifactBundleV1 Schema"
      type: "ARTIFACT_SCHEMA"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Fields are append-only"
          - "Removing fields requires major version bump"
      schemas:
        - id: "SCH-0008"
          path: "schemas/apm2/review_artifact_bundle_v1.yaml"
          format: "YAML_SCHEMA"
          description: "CAS bundle containing review output + tool log refs (v1)"
      evidence_ids: []

    - id: "CTR-0009"
      name: "PermeabilityReceiptV1 Delegation Artifact"
      type: "ARTIFACT_SCHEMA"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Fields are append-only"
          - "Removing fields requires major version bump"
      schemas:
        - id: "SCH-0009"
          format: "INLINE_SPEC"
          description: "Normative delegation receipt introducing capability/context/budget handles without discovery"
          required_fields:
            binds: ["delegator_holon_id", "delegatee_holon_id", "work_id", "lease_id"]
            delegates: ["capability_manifest_hash", "context_pack_hash"]
            bounds: ["budgets", "stop_condition_hash", "expiry_time_envelope_ref"]
            commits: ["view_commitment_hash (or selector to derive it)"]
          storage_requirements:
            - "MUST be stored in CAS"
            - "MUST be referenced by hash from any episode/receipt that uses delegated authority"
      evidence_ids: []

    - id: "CTR-0010"
      name: "ToolExecutionReceipt (proof-carrying tool actuation)"
      type: "ARTIFACT_SCHEMA"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Fields are append-only"
          - "Removing fields requires major version bump"
      schemas:
        - id: "SCH-0010"
          format: "INLINE_SPEC"
          description: "Signed receipt proving a tool call occurred; binds args/result hashes under episode + policy envelopes"
          required_fields:
            bindings:
              - "episode_envelope_hash (or equivalent episode digest)"
              - "policy_hash"
              - "request_id"
              - "capability_id"
              - "args_hash"
              - "result_hash"
              - "time_envelope_ref"
              - "duration"
            signature:
              - "signer_identity"
              - "signature_over_canonical_bytes"
          storage_requirements:
            - "Stored in CAS; referenced by hash from episode tool logs"
      evidence_ids: []

    - id: "CTR-0011"
      name: "AgentAdapterProfileV1 (external CLI integration contract)"
      type: "ARTIFACT_SCHEMA"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Fields are append-only"
          - "Removing fields requires major version bump"
      schemas:
        - id: "SCH-0011"
          format: "INLINE_SPEC"
          description: "CAS-addressed profile used to select and run a specific agent adapter deterministically by hash"
          required_fields:
            - "profile_id"
            - "adapter_mode (black_box | structured_output | mcp_bridge | hooked_vendor)"
            - "command"
            - "args_template"
            - "env_template"
            - "cwd"
            - "requires_pty"
            - "input_mode (arg | stdin | file | stream-json)"
            - "output_mode (raw | json | jsonl | stream-json)"
            - "permission_mode_map (policy tiers -> CLI flags)"
            - "tool_bridge (bridge configuration)"
            - "capability_map (external intents -> kernel tool classes)"
            - "version_probe (command + regex)"
            - "health_checks (timeouts, stall thresholds)"
            - "budget_defaults (tool_calls, tokens, wall_clock, evidence)"
            - "evidence_policy (recorded vs discarded)"
          invariants:
            - "Profile selection is explicit and hash-addressed; ambient defaults forbidden"
            - "Kernel-side tool execution is mandatory for every profile; agent output treated as untrusted hints"
      evidence_ids: []

    - id: "CTR-0012"
      name: "FAC Admission Kernel Events (state machine substrate)"
      type: "KERNEL_EVENT"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Event fields are append-only"
          - "Removing fields requires major version bump"
      schemas:
        - id: "SCH-0012"
          path: "proto/kernel_events.proto"
          format: "PROTOBUF"
          description: "ChangeSetPublished, PolicyResolvedForChangeSet, LeaseIssued, WorkPrAssociated, ReviewBlockedRecorded, ReviewReceiptRecorded (and related events)"
      evidence_ids: []

    - id: "CTR-0013"
      name: "ContextPack Manifest/Spec Schemas"
      type: "ARTIFACT_SCHEMA"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Fields are append-only"
          - "Removing fields requires major version bump"
      schemas:
        - id: "SCH-0013A"
          path: "documents/standards/cac/schemas/cac.context_pack_manifest.v1.schema.json"
          format: "JSON_SCHEMA"
          description: "CAC ContextPackManifest schema used for broker-side context firewalling"
        - id: "SCH-0013B"
          path: "documents/standards/cac/schemas/cac.context_pack_spec.v1.schema.json"
          format: "JSON_SCHEMA"
          description: "CAC ContextPackSpec schema describing bounded context contents/selectors"
      evidence_ids: []

    - id: "CTR-0014"
      name: "ReviewArtifactBundleV2 (holon-ready bindings)"
      type: "ARTIFACT_SCHEMA"
      versioning:
        scheme: "SEMVER"
        current_version: "2.0.0"
        compatibility_rules:
          - "Fields are append-only within major version"
          - "Removing/renaming fields requires major version bump"
      schemas:
        - id: "SCH-0014"
          format: "INLINE_SPEC"
          description: |
            NET_NEW (RFC-0019): review artifacts bundle with explicit view/policy/delegation bindings required
            for cross-holon replay without ambient filesystem truth. V1 (schemas/apm2/review_artifact_bundle_v1.yaml)
            does not include these bindings.
          required_fields:
            - "schema (apm2.review_artifact_bundle.v2)"
            - "schema_version (semver)"
            - "review_id"
            - "changeset_digest"
            - "review_text_hash"
            - "time_envelope_ref"
            - "view_commitment_hash"
            - "capability_manifest_hash"
            - "context_pack_hash"
            - "policy_resolved_ref (stable binding to PolicyResolvedForChangeSet)"
            - "tool_log_index_hash (preferred) OR tool_log_hashes (v0 compatibility; migration required)"
            - "summary_receipt_hash"
          invariants:
            - "Must be sufficient to verify/replay from CAS+ledger without trusting local disk state or process memory"
            - "Missing required bindings MUST fail closed (ReviewBlockedRecorded) rather than emitting a successful ReviewReceiptRecorded"
      evidence_ids: []

  outputs:
    artifacts_produced:
      - id: "OUT-0001"
        name: "CapabilityManifest CAS artifact"
        format: "Canonical JSON in CAS"
        produced_by: "Policy resolution during SpawnEpisode"
      - id: "OUT-0004"
        name: "ChangeSetBundleV1 CAS artifact"
        format: "Canonical bytes in CAS"
        produced_by: "FAC ingress adapter during ingestion"
      - id: "OUT-0002"
        name: "ToolLogIndex CAS artifact"
        format: "Canonical JSON in CAS"
        produced_by: "EpisodeRuntime on episode completion"
      - id: "OUT-0011"
        name: "ToolExecutionReceipt CAS artifact"
        format: "Canonical signed bytes in CAS (inline spec; optional addendum in v4 minimum)"
        produced_by: "ToolBroker/ToolExecutor at each tool actuation (proof-carrying addendum)"
      - id: "OUT-0005"
        name: "ViewCommitment CAS artifact"
        format: "Canonical JSON per schema apm2.view_commitment.v1"
        produced_by: "WorkspaceManager / pinned-view compiler"
      - id: "OUT-0006"
        name: "ReviewArtifactBundle CAS artifact"
        format: "Canonical YAML/JSON per ReviewArtifactBundle schema"
        produced_by: "Review receipt builder at episode completion"
      - id: "OUT-0012"
        name: "ReviewArtifactBundleV2 CAS artifact"
        format: "Canonical JSON per CTR-0014 (holon-ready bindings; NET_NEW)"
        produced_by: "Review receipt builder at episode completion (when holon-ready bindings required)"
      - id: "OUT-0007"
        name: "SummaryReceipt CAS artifact"
        format: "Canonical JSON per summary_receipt.schema.json"
        produced_by: "Review receipt builder (lossy but verifiable front page)"
      - id: "OUT-0008"
        name: "PermeabilityReceiptV1 CAS artifact"
        format: "Canonical JSON (inline spec; future schema)"
        produced_by: "Supervisory holon / governance layer issuing delegation"
      - id: "OUT-0003"
        name: "ProjectionReceiptRecorded event"
        format: "Canonical event bytes in ledger"
        produced_by: "ProjectionWorker after GitHub write"
      - id: "OUT-0009"
        name: "AgentAdapterProfileV1 CAS artifact"
        format: "Canonical JSON (inline spec; future schema)"
        produced_by: "Ops/configuration: explicit profile selection by hash"
      - id: "OUT-0010"
        name: "ContextPack CAS artifacts"
        format: "Canonical JSON per CAC context pack schemas"
        produced_by: "Context compiler/sealer; consumed by broker context firewall"
    failure_modes:
      - id: "FAIL-0001"
        condition: "CAS unavailable during tool execution"
        behavior: "Fail closed: deny tool execution that cannot be durably evidenced; terminate/Block the episode if evidence cannot be stored (no kernel-produced result without CAS anchor)"
        recovery: "Retry when CAS recovers; if budgets exhausted, record defect and re-run under new lease/budgets"
      - id: "FAIL-0002"
        condition: "Ledger unavailable during event emission"
        behavior: "Episode blocks until ledger recovers or budget exhausted"
        recovery: "Automatic retry with exponential backoff"
      - id: "FAIL-0003"
        condition: "GitHub API unavailable during projection"
        behavior: "Projection deferred; receipt not recorded"
        recovery: "Projection worker retries on ledger tail catch-up"
      - id: "FAIL-0004"
        condition: "Missing pins/view commitment material"
        behavior: "Fail closed; emit ReviewBlockedRecorded(reason=PIN_MISSING, ...)"
        recovery: "Re-run with corrected pins; record defect for missing pin source"
      - id: "FAIL-0005"
        condition: "Stop-state missing or unverifiable at actuation boundary"
        behavior: "Fail closed; deny actuation; emit ReviewBlockedRecorded(reason=STOP_STATE_MISSING, ...)"
        recovery: "Provide/repair stop-state binding; retry under new lease/delegation"
      - id: "FAIL-0006"
        condition: "Tool escape attempt (path traversal/symlink escape/outside-root access)"
        behavior: "Fail closed; emit ReviewBlockedRecorded(reason=ESCAPE_ATTEMPT|TOOL_ESCAPE_ATTEMPT, ...); quarantine workspace and record defect"
        recovery: "Investigate; tighten handlers/firewall policy; retry under new lease after remediation"
      - id: "FAIL-0007"
        condition: "ContextPack miss / out-of-pack read intent"
        behavior: "Fail closed: deny out-of-pack reads; record ContextPackMiss evidence and defect or Blocked outcome per policy"
        recovery: "Refine/reseal ContextPack and retry under new delegation"
      - id: "FAIL-0008"
        condition: "Non-determinism detected (verifier disagreement / drift envelope puncture)"
        behavior: "Fail closed at required verification tier: block promotion; record defect and pins required to restore replayability"
        recovery: "Pin toolchain/model/policy inputs in ViewCommitment; re-run under deterministic configuration"

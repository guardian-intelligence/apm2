requirement:
  schema_version: "2026-02-09"
  id: "REQ-0034"
  title: "Signed, content-addressed dependency closure as authoritative gate supply"
  category: "FUNCTIONAL"
  priority: "P0"
  status: "PROPOSED"
  statement: |
    A dependency closure artifact MUST be defined that captures all inputs
    required for reproducible gate execution:
      - Cargo registry index snapshot (content-addressed)
      - Crate source archives (content-addressed)
      - Git dependency snapshots (content-addressed, pinned to commit)
      - Toolchain components (rustc, cargo, std; content-addressed by version + target)

    The closure MUST have a stable, deterministic hash (closure_hash) that is:
      - Bound into gate attestation receipts as a supply input field.
      - Used as a cache key dimension for gate result reuse (per REQ-0037).

    Closure drift (any change to the closure_hash vs. the cached value) MUST
    invalidate all gate cache entries for the affected SHA, deterministically.

    The PREP phase MUST auto-hydrate or auto-repair the closure when entries
    are missing or corrupted. If network is available, PREP fetches missing
    entries. If network is unavailable and entries are missing, PREP emits
    `PREP_SUPPLY_UNAVAILABLE` (per REQ-0033).

    The closure artifact MUST be signed by the daemon before use in EXECUTE.
    Gates MUST verify the closure signature before consuming any supply entry.

    Primary delivery ticket: TCK-00623.
  rationale: |
    Without a defined, signed closure, gate execution is implicitly coupled to
    ambient network state (registry availability, cache.crates.io uptime, git
    remote availability). This produces non-deterministic results and makes
    cache reuse impossible to reason about. A content-addressed, signed closure
    makes supply an explicit, auditable input and closes the ambient-fetch
    attack surface during EXECUTE.
  acceptance_criteria:
    - "Closure artifact has a defined schema with all four input categories."
    - "closure_hash is bound in gate attestation receipts."
    - "Cache miss is triggered deterministically when closure_hash changes."
    - "PREP auto-hydrates missing closure entries when network is available."
    - "Closure is signed by daemon; gates reject unsigned or signature-mismatched supply."
    - "Gate execution with pre-seeded closure and network denied: succeeds."
  evidence_ids:
    - "EVID-0034"
  source_refs:
    - "documents/rfcs/RFC-0019/20_fac_execution_substrate_build_farm_revision.md"

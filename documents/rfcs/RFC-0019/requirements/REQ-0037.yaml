requirement:
  schema_version: "2026-02-09"
  id: "REQ-0037"
  title: "Cache reuse explainability: hit/miss with first mismatch dimension"
  category: "NON_FUNCTIONAL"
  priority: "P1"
  status: "PROPOSED"
  statement: |
    For each gate evaluated, a cache_decision record MUST be emitted (inlined
    in gate_finished or as a separate cache_decision event per REQ-0036).

    The cache_decision record MUST include:
      - `hit`:                   boolean
      - `reason_code`:           string; one of a stable set:
          cache_hit              — entry found and all dimensions match
          sha_miss               — no entry for this commit SHA
          gate_miss              — no entry for this gate name
          policy_drift           — policy_hash changed
          toolchain_drift        — toolchain version/target changed
          closure_drift          — closure_hash changed (per REQ-0034)
          input_drift            — gate input files changed
          network_policy_drift   — network isolation policy hash changed
          sandbox_drift          — sandbox/cgroup profile changed
          receipt_binding_missing — entry lacks RFC-0028/0029 receipt bindings
          signature_invalid      — entry signature verification failed
          ttl_expired            — entry exceeded TTL
      - `first_mismatch_dimension`: the first reason_code that caused a miss
        (null on hit), enabling fast triage without enumerating all dimensions
      - `cached_sha`:            the SHA of the cached entry (null on miss)

    Miss diagnosis MUST be available from the stdout event stream alone,
    without reading gate_cache_v2 files or any internal log.

    Primary delivery ticket: TCK-00626.
  rationale: |
    Cache misses are the primary latency driver on repeated runs. Without
    structured miss attribution, operators and orchestrators cannot distinguish
    an expected miss (toolchain upgrade) from an unexpected one (policy hash
    instability). The first_mismatch_dimension field directs attention to the
    root cause in O(1) without requiring a diff of cache entries.
  acceptance_criteria:
    - "Every gate evaluation emits a cache_decision record with hit, reason_code, and first_mismatch_dimension."
    - "All reason_code values in the stable set are reachable from existing cache check paths."
    - "first_mismatch_dimension is null on cache hit and set to the first failing dimension on miss."
    - "Given a cache miss event, the operator can identify the cause without reading gate_cache_v2 files."
    - "CI tests cover all reason_code values and verify correct first_mismatch_dimension assignment."
  evidence_ids:
    - "EVID-0037"
  source_refs:
    - "documents/rfcs/RFC-0019/20_fac_execution_substrate_build_farm_revision.md"

requirement:
  schema_version: "2026-02-09"
  id: "REQ-0038"
  title: "Warm-path performance SLO for repeated identical gate runs"
  category: "NON_FUNCTIONAL"
  priority: "P1"
  status: "PROPOSED"
  statement: |
    The daemon SHOULD maintain a warmed substrate for `apm2 fac gates` runs
    (lane target reuse + dependency closure readiness). When the substrate is
    warm, repeated identical gate runs (same HEAD SHA, same closure_hash, same
    policy_hash) MUST demonstrate measurable latency reduction.

    The following SLO MUST hold for the warm path:
      - run2 total_duration_ms <= run1 total_duration_ms × 0.20
        (i.e., warm run is at most 20% of the cold run duration)
      - run2 cache_hit_count == total_gate_count
        (all gates are cache hits on the warm path)
      - run2 prep_duration_ms <= 500 ms
        (readiness controller is a no-op; closure is already hydrated)

    The run_summary event (per REQ-0036) MUST include the following fields
    to enable SLO verification:
      - `total_duration_ms`
      - `prep_duration_ms`
      - `execute_duration_ms`
      - `cache_hit_count`
      - `cache_miss_count`
      - `is_warm_run`: boolean (true if all cache hits and prep < 500 ms)

    SLO compliance is tracked per run via the run_summary event. Violations
    are surfaced as warnings in the run_summary (not failures).

    Primary delivery ticket: TCK-00627.
  rationale: |
    The most common implementor workflow is iterative: small code changes,
    gates re-run frequently. If every re-run requires full cold compilation
    (minutes), the iteration loop is too slow for effective agent-driven
    development. The warm-path SLO defines a concrete, measurable target that
    the daemon substrate must meet and that CI can regression-test.
  acceptance_criteria:
    - "run_summary event includes total_duration_ms, prep_duration_ms, execute_duration_ms, cache_hit_count, cache_miss_count, is_warm_run."
    - "For an identical second run: cache_hit_count == total_gate_count."
    - "For an identical second run: total_duration_ms <= run1 × 0.20."
    - "For an identical second run: prep_duration_ms <= 500 ms."
    - "SLO violation is reported as a warning field in run_summary, not a failure."
    - "CI benchmark test verifies warm-path SLO against a representative gate set."
  evidence_ids:
    - "EVID-0038"
  source_refs:
    - "documents/rfcs/RFC-0019/20_fac_execution_substrate_build_farm_revision.md"

requirement:
  schema_version: "2026-02-09"
  id: "REQ-0039"
  title: "Fresh-worktree conformance suite: zero-touch, offline, and warm-path coverage"
  category: "FUNCTIONAL"
  priority: "P0"
  status: "PROPOSED"
  statement: |
    A mandatory conformance suite MUST be added to the test workspace that
    covers the following scenarios as promotion-blocking tests:

    SCENARIO A — Zero-touch fresh worktree (network available):
      Given: empty APM2_HOME, valid config file, network access
      Action: `apm2 fac gates`
      Expected: auto-heal succeeds, all gates run, run exits 0

    SCENARIO B — Offline with pre-seeded closure (network denied):
      Given: pre-populated APM2_HOME with valid closure and substrate
      Action: `apm2 fac gates` with network denied in EXECUTE
      Expected: all gates run using pre-seeded closure, run exits 0

    SCENARIO C — Offline without closure (network denied):
      Given: valid APM2_HOME substrate but no closure artifact
      Action: `apm2 fac gates` with network denied
      Expected: PREP fails with exactly PREP_SUPPLY_UNAVAILABLE,
                zero gates run, remediation field is actionable

    SCENARIO D — Warm-path run (identical second run):
      Given: run1 completed successfully with full cache population
      Action: `apm2 fac gates` (same SHA, same closure, same policy)
      Expected: run_summary.is_warm_run=true, all gates are cache hits,
                total_duration_ms <= run1 × 0.20

    Each scenario MUST be a CI-runnable test (not an integration test requiring
    external services). Scenarios A, B, C, D are all promotion-blocking for the
    RFC-0019 quality gate.

    Primary delivery ticket: TCK-00628.
  rationale: |
    Without a formal conformance suite, the usability guarantees in REQ-0031
    through REQ-0038 are aspirational. The four scenarios directly correspond
    to the four user-facing invariants (zero-touch, offline, failure
    normalization, warm-path) and provide concrete, machine-verifiable evidence
    that the system meets the stated requirements. Making them promotion-blocking
    ensures regressions are caught before any RFC-0019 quality gate closes.
  acceptance_criteria:
    - "All four scenarios are implemented as automated CI tests."
    - "Scenario A passes: fresh APM2_HOME + network => auto-heal + success."
    - "Scenario B passes: pre-seeded closure + network denied => success."
    - "Scenario C passes: no closure + network denied => exactly PREP_SUPPLY_UNAVAILABLE, zero gates run."
    - "Scenario D passes: warm run => is_warm_run=true, all cache hits, duration within SLO."
    - "All four scenarios are gated in CI and block RFC-0019 promotion."
  evidence_ids:
    - "EVID-0039"
  source_refs:
    - "documents/rfcs/RFC-0019/20_fac_execution_substrate_build_farm_revision.md"

requirement:
  schema_version: "2026-01-23"
  id: "REQ-0009"
  title: "AgentAdapterProfileV1: deterministic external CLI integration"
  category: "FUNCTIONAL"
  priority: "P1"
  status: "PROPOSED"
  statement: |
    FAC MUST define and use AgentAdapterProfileV1 as a CAS-addressed artifact to integrate heterogeneous
    agent CLIs (claude-code, gemini-cli, codex-cli) and local inference deterministically:
    1. Define AgentAdapterProfileV1 schema + canonicalization and store profiles in CAS by hash.
    2. Adapter selection MUST be explicit and hash-addressed (no ambient defaults).
    3. Kernel-side tool execution MUST be enforced for every profile; agent output is treated as untrusted hints.
    4. Ledger events MUST attribute agent execution by (work_id, episode_id, session_id, adapter_profile_hash).
    5. Provide conformance tests proving each profile can run a non-interactive episode and produce a ReviewReceipt.

    Tool bridging modes supported (per profile; mixing across profiles allowed):
    - "black_box (preferred): kernel-mediated ToolIntent grammar; ledger authoritative"
    - "structured_output: JSON/JSONL/stream-json tool intents parsed from stdout/stderr"
    - "mcp_bridge: agent connects to kernel MCP server (allowed, not preferred)"
    - "hooked_vendor: vendor-specific integration under the same kernel-side execution invariants"

    Minimum profile fields (normative):
    - profile_id, adapter_mode, command, args_template, env_template, cwd, requires_pty
    - input_mode, output_mode
    - permission_mode_map, capability_map, tool_bridge
    - version_probe, health_checks
    - budget_defaults, evidence_policy
  rationale: |
    Without an explicit adapter profile system, FAC cannot be executed out-of-the-box across heterogeneous
    agent runtimes, and the kernel cannot deterministically control tool execution, evidence capture,
    and policy enforcement. The RFC draft requires adapter profiles as a prerequisite for a fully
    autonomous forge admission cycle.
  acceptance_criteria:
    - "Profiles exist for claude-code, gemini-cli, codex-cli, and local-inference (minimum)"
    - "Profile selection is explicit and hash-addressed; missing/misconfigured profiles fail closed with ReviewBlockedRecorded(reason=ADAPTER_MISCONFIGURED)"
    - "No tool execution occurs without kernel-side policy evaluation and ledger events"
    - "Ledger events include adapter_profile_hash attribution"
    - "Conformance tests prove each profile can produce a ReviewReceipt non-interactively"
  evidence_ids:
    - "EVID-0009"
  source_refs:
    - "documents/rfcs/RFC-0019/01_problem_and_imports.yaml#rfc_problem_and_imports.holarchy_protocol_v1"
    - "documents/rfcs/RFC-0019/04_contracts_and_versioning.yaml#rfc_contracts_and_versioning.contracts"

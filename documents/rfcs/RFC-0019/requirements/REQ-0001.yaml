requirement:
  schema_version: "2026-01-23"
  id: "REQ-0001"
  title: "Session dispatcher viability (TCK-00290 closure)"
  category: "FUNCTIONAL"
  priority: "P0"
  status: "PROPOSED"
  statement: |
    SessionDispatcher MUST be viable for FAC automation: session-scoped IPC must drive
    kernel-side tool execution and durable truth-plane commits.

    Construction / wiring:
    - The daemon production path MUST construct `SessionDispatcher` with:
      - CAS access (`ContentAddressedStore`) for `PublishEvidence` and tool result storage
      - ledger append (`LedgerEventEmitter`) for `EmitEvent` and tool/episode lifecycle events
      - `HolonicClock` for monotonic timestamps (no `SystemTime` authority fallback)
      - `ToolBroker` for capability + policy + context-firewall evaluation
      - a tool execution path (EpisodeRuntime/ToolExecutor) so `RequestTool` can produce results

    Fail-closed requirements:
    - The legacy allow path (manifest-store-only allow decision when broker is absent) MUST NOT be
      reachable in production mode. Production mode MUST deny (fail closed) if broker/executor
      is unavailable.
    - `PublishEvidence` MUST fail closed if CAS is unavailable (no stub hash-only success).
    - `EmitEvent` MUST fail closed if ledger is unavailable (no in-memory success).

    RequestTool semantics (kernel-side execution):
    - `RequestTool` MUST cause actual tool execution in the kernel and return a durable reference:
      - at minimum: `result_hash` (CAS) for ToolResultData (REQ-0004)
      - ideally: `tool_execution_receipt_hash` (CAS) for ToolExecutionReceipt (REQ-0010)
    - Session-scoped IPC MUST be upgraded accordingly (current `RequestToolResponse` carries only
      allow/deny; it does not carry a result hash).

    Ordering:
    - Any ledger event that references a CAS artifact MUST only be emitted after the CAS artifact
      exists (CAS-before-ledger invariant).
  rationale: |
    Current state: `DispatcherState::with_persistence` constructs SessionDispatcher with only a manifest
    store (no CAS/ledger/broker/clock) (crates/apm2-daemon/src/state.rs). In addition, the session
    `RequestTool` handler contains a legacy fallback that returns ALLOW based on the manifest when no
    broker is configured (crates/apm2-daemon/src/protocol/session_dispatch.rs:963-1023), and the
    session IPC response type lacks a result hash (proto/apm2d_runtime_v1.proto:408-422). These make
    sessions non-viable for kernel-side, evidence-bearing FAC automation.
  acceptance_criteria:
    - "SessionDispatcher constructed with CAS, ledger, clock, and ToolBroker in production"
    - "RequestTool returns kernel-executed, CAS-backed results (result_hash and/or tool_execution_receipt_hash)"
    - "PublishEvidence stores to CAS and returns content hash"
    - "EmitEvent appends canonical event bytes to ledger"
    - "Legacy allow path returns DENY when broker absent in production mode"
  evidence_ids:
    - "EVID-0001"
  source_refs:
    - "crates/apm2-daemon/src/state.rs"
    - "crates/apm2-daemon/src/protocol/session_dispatch.rs:900-1040"
    - "proto/apm2d_runtime_v1.proto:397-422"

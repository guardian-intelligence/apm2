rfc_ticket_decomposition:
  schema_version: "2026-01-27"
  template_version: "2026-01-27"
  rfc_id: RFC-0011

  decomposition_strategy: |
    CAC v1 is decomposed into 6 implementation phases, each producing independently
    testable artifacts. Tickets are atomic (single PR completable) and follow the
    dependency graph below. This is a v0 Discovery decomposition - detailed ticket
    specs will be generated after v2 Exploration grounds the design in codebase patterns.

  phases:
    - phase_id: CAC-P1
      name: Foundations
      description: CAC-JSON canonicalizer, validator, and bootstrap schema bundle
      estimated_complexity: HIGH
      dependencies: []
      requirements_covered:
        - CAC-REQ-0001
        - CAC-REQ-0009
        - CAC-REQ-0010

    - phase_id: CAC-P2
      name: Admission + Provenance
      description: Patch engine with replay protection, admission receipts, ledger events
      estimated_complexity: HIGH
      dependencies: [CAC-P1]
      requirements_covered:
        - CAC-REQ-0002
        - CAC-REQ-0004

    - phase_id: CAC-P3
      name: Deterministic Fetch
      description: DCP stable-ID resolution index, ArtifactFetch tool protocol
      estimated_complexity: MEDIUM
      dependencies: [CAC-P2]
      requirements_covered:
        - CAC-REQ-0011

    - phase_id: CAC-P4
      name: ContextPack Compiler
      description: Pack spec compilation, deep-pinning, budget enforcement
      estimated_complexity: HIGH
      dependencies: [CAC-P3]
      requirements_covered:
        - CAC-REQ-0003
        - CAC-REQ-0008
        - CAC-REQ-0012
        - CAC-REQ-0015

    - phase_id: CAC-P5
      name: Target Delivery
      description: Target profile schema, deterministic export, conformance tests
      estimated_complexity: MEDIUM
      dependencies: [CAC-P4]
      requirements_covered:
        - CAC-REQ-0005
        - CAC-REQ-0013

    - phase_id: CAC-P6
      name: Capability Truthing
      description: CapabilityManifest generation, AAT/selftest harness, gating
      estimated_complexity: MEDIUM
      dependencies: [CAC-P3]
      requirements_covered:
        - CAC-REQ-0006
        - CAC-REQ-0007
        - CAC-REQ-0014

  preliminary_tickets:
    # Phase 1: Foundations
    - ticket_id: CAC-TCK-0001
      phase: CAC-P1
      title: Implement CAC-JSON canonicalizer
      description: |
        Implement JCS-like canonicalizer for CAC-JSON with:
        - Integer-only numbers (signed 64-bit range)
        - No duplicate keys
        - UTF-8 NFC normalized strings
        - Deterministic key ordering (lexicographic)
        - Idempotent output (canonicalize(canonical) == canonical)
      estimated_complexity: HIGH
      dependencies: []
      discovery_needed: true
      open_questions:
        - "Q-0001: Exact deviations from RFC 8785 JCS?"
        - "Where to integrate with existing crates/apm2-core/src/determinism/canonicalize.rs?"

    - ticket_id: CAC-TCK-0002
      phase: CAC-P1
      title: Implement CAC JSON Schema validator
      description: |
        Implement JSON Schema validator (draft 2020-12) with:
        - unevaluatedProperties=false for strict validation
        - Size/depth limits (max depth 128, max array 100000)
        - Unknown field rejection
        - Error location reporting
      estimated_complexity: MEDIUM
      dependencies: [CAC-TCK-0001]
      discovery_needed: true
      open_questions:
        - "Which jsonschema crate to use? jsonschema-rs vs valico?"

    - ticket_id: CAC-TCK-0003
      phase: CAC-P1
      title: Embed bootstrap schema bundle in binary
      description: |
        Embed minimal schema bundle in apm2 binary with:
        - Hash-pinned manifests via build.rs
        - Startup verification
        - Read-only exposure to validator
        - Rejection of patches targeting bootstrap IDs
      estimated_complexity: HIGH
      dependencies: [CAC-TCK-0002]
      discovery_needed: true
      open_questions:
        - "Build.rs integration approach for embedding?"
        - "Size constraints for embedded bundle?"

    - ticket_id: CAC-TCK-0004
      phase: CAC-P1
      title: Implement canonicalization test vectors
      description: |
        Create governed test vector artifact with:
        - Golden vectors for all edge cases
        - Cross-platform verification
        - Pinned in bootstrap bundle
        - Version tracking
      estimated_complexity: LOW
      dependencies: [CAC-TCK-0001]
      discovery_needed: false

    # Phase 2: Admission + Provenance
    - ticket_id: CAC-TCK-0005
      phase: CAC-P2
      title: Implement patch engine with replay protection
      description: |
        Implement patch application with:
        - JSON Patch (RFC 6902) support
        - Merge Patch (RFC 7396) support
        - expected_base_hash validation
        - Replay violation event emission
      estimated_complexity: HIGH
      dependencies: [CAC-TCK-0001, CAC-TCK-0002]
      discovery_needed: true
      open_questions:
        - "Q-0007: Compaction policy for patch chains?"

    - ticket_id: CAC-TCK-0006
      phase: CAC-P2
      title: Implement admission pipeline and receipts
      description: |
        Implement admission gate with:
        - Validation -> Canonicalization -> CAS store flow
        - AdmissionReceipt emission
        - Ledger event emission with hash references
        - ChangeSetReport generation
      estimated_complexity: MEDIUM
      dependencies: [CAC-TCK-0005]
      discovery_needed: true
      open_questions:
        - "Integration with existing ledger/events module?"

    - ticket_id: CAC-TCK-0007
      phase: CAC-P2
      title: "Add CLI command: apm2 cac apply-patch"
      description: |
        CLI command for patch submission with:
        - --expected-base flag for replay protection
        - --dry-run for validation without commit
        - Receipt output format (JSON/YAML)
      estimated_complexity: LOW
      dependencies: [CAC-TCK-0006]
      discovery_needed: false

    # Phase 3: Deterministic Fetch
    - ticket_id: CAC-TCK-0008
      phase: CAC-P3
      title: Implement DCP stable-ID index
      description: |
        Implement stable-ID resolution index with:
        - Projection from ledger events
        - stable_id -> content_hash resolution
        - Schema ref tracking
        - Dependency graph edges
      estimated_complexity: HIGH
      dependencies: [CAC-TCK-0006]
      discovery_needed: true
      open_questions:
        - "Q-0002: Namespace governance and collision prevention?"
        - "Index storage format and rebuild strategy?"

    - ticket_id: CAC-TCK-0009
      phase: CAC-P3
      title: Implement ArtifactFetch tool protocol
      description: |
        Implement tool protocol extension with:
        - stable_id and content_hash parameters
        - max_bytes and format options
        - Policy enforcement (consumption mode restrictions)
        - Content-hash-only fetch denial
      estimated_complexity: MEDIUM
      dependencies: [CAC-TCK-0008]
      discovery_needed: true
      open_questions:
        - "Integration with existing tool protocol?"

    # Phase 4: ContextPack Compiler
    - ticket_id: CAC-TCK-0010
      phase: CAC-P4
      title: Implement ContextPack spec schema
      description: |
        Define ContextPackSpec schema with:
        - Root stable_id list
        - Budget constraints (typed quantities)
        - Dependency review hashes
        - Target profile reference
      estimated_complexity: LOW
      dependencies: [CAC-TCK-0002]
      discovery_needed: false

    - ticket_id: CAC-TCK-0011
      phase: CAC-P4
      title: Implement ContextPack compiler
      description: |
        Implement pack compilation with:
        - Transitive dependency resolution
        - Deep-pinning of content hashes
        - Budget enforcement
        - Deterministic manifest generation
      estimated_complexity: HIGH
      dependencies: [CAC-TCK-0008, CAC-TCK-0010]
      discovery_needed: true
      open_questions:
        - "Q-0004: Large binary artifact representation?"

    - ticket_id: CAC-TCK-0012
      phase: CAC-P4
      title: Implement RunReceipt emission
      description: |
        Implement consumption run receipts with:
        - context_pack_miss tracking
        - context_pack_sufficiency flag
        - Budget delta quantities
        - DefectRecord emission on miss
      estimated_complexity: MEDIUM
      dependencies: [CAC-TCK-0011]
      discovery_needed: true
      open_questions:
        - "Integration with holon episode controller?"

    - ticket_id: CAC-TCK-0013
      phase: CAC-P4
      title: "Add CLI command: apm2 pack compile"
      description: |
        CLI command for pack compilation with:
        - --spec flag for pack spec path
        - --profile flag for target profile
        - --budget-check for validation only
        - Manifest output format
      estimated_complexity: LOW
      dependencies: [CAC-TCK-0011]
      discovery_needed: false

    # Phase 5: Target Delivery
    - ticket_id: CAC-TCK-0014
      phase: CAC-P5
      title: Implement TargetProfile schema
      description: |
        Define TargetProfile schema with:
        - Rendering policies (format, structure)
        - Budget constraints
        - Retrieval policies
        - Delivery constraints
      estimated_complexity: MEDIUM
      dependencies: [CAC-TCK-0002]
      discovery_needed: true
      open_questions:
        - "Q-0006: Minimal stage taxonomy?"

    - ticket_id: CAC-TCK-0015
      phase: CAC-P5
      title: Implement deterministic export pipeline
      description: |
        Implement export with:
        - Profile-constrained rendering
        - Provenance embedding in outputs
        - ExportManifest generation
        - Byte-identical determinism
      estimated_complexity: HIGH
      dependencies: [CAC-TCK-0011, CAC-TCK-0014]
      discovery_needed: true
      open_questions:
        - "Markdown provenance frontmatter format?"

    - ticket_id: CAC-TCK-0016
      phase: CAC-P5
      title: Implement export conformance tests
      description: |
        Implement conformance testing with:
        - Determinism verification (re-export comparison)
        - Schema validation of outputs
        - Provenance verification
        - ExportReceipt generation
      estimated_complexity: MEDIUM
      dependencies: [CAC-TCK-0015]
      discovery_needed: false

    - ticket_id: CAC-TCK-0017
      phase: CAC-P5
      title: "Add CLI command: apm2 export"
      description: |
        CLI command for target delivery with:
        - --profile flag for target profile
        - --output-dir for export location
        - --verify for conformance check
      estimated_complexity: LOW
      dependencies: [CAC-TCK-0015]
      discovery_needed: false

    # Phase 6: Capability Truthing
    - ticket_id: CAC-TCK-0018
      phase: CAC-P6
      title: Implement CapabilityManifest generator
      description: |
        Generate manifest from binary with:
        - Command enumeration
        - Input/output schema extraction
        - Binary hash binding
        - Selftest references
      estimated_complexity: HIGH
      dependencies: [CAC-TCK-0009]
      discovery_needed: true
      open_questions:
        - "How to enumerate commands from clap definitions?"

    - ticket_id: CAC-TCK-0019
      phase: CAC-P6
      title: Implement AAT/selftest harness
      description: |
        Implement selftest execution with:
        - Hermetic test environment
        - Budget constraints (time/tool/token)
        - AATReceipt generation
        - Binary hash verification
      estimated_complexity: HIGH
      dependencies: [CAC-TCK-0018]
      discovery_needed: true
      open_questions:
        - "Integration with existing xtask/src/aat module?"

    - ticket_id: CAC-TCK-0020
      phase: CAC-P6
      title: Implement capability gating
      description: |
        Implement planning gates with:
        - AATReceipt verification
        - Capability negotiation via stable IDs
        - Cutover gating enforcement
      estimated_complexity: MEDIUM
      dependencies: [CAC-TCK-0019]
      discovery_needed: true

    - ticket_id: CAC-TCK-0021
      phase: CAC-P6
      title: "Add CLI commands: apm2 capabilities, apm2 selftest"
      description: |
        CLI commands for capability management with:
        - apm2 capabilities --json for manifest generation
        - apm2 selftest for AAT execution
        - Receipt output format
      estimated_complexity: LOW
      dependencies: [CAC-TCK-0018, CAC-TCK-0019]
      discovery_needed: false

  dependency_graph: |
    CAC-TCK-0001 (canonicalizer)
        |
        +-> CAC-TCK-0002 (validator)
        |       |
        |       +-> CAC-TCK-0003 (bootstrap)
        |       |
        |       +-> CAC-TCK-0010 (pack spec schema)
        |       |
        |       +-> CAC-TCK-0014 (target profile schema)
        |
        +-> CAC-TCK-0004 (test vectors)
        |
        +-> CAC-TCK-0005 (patch engine)
                |
                +-> CAC-TCK-0006 (admission pipeline)
                        |
                        +-> CAC-TCK-0007 (cac apply-patch CLI)
                        |
                        +-> CAC-TCK-0008 (DCP index)
                                |
                                +-> CAC-TCK-0009 (ArtifactFetch)
                                |       |
                                |       +-> CAC-TCK-0018 (CapabilityManifest)
                                |               |
                                |               +-> CAC-TCK-0019 (AAT harness)
                                |                       |
                                |                       +-> CAC-TCK-0020 (gating)
                                |                       |
                                |                       +-> CAC-TCK-0021 (CLI)
                                |
                                +-> CAC-TCK-0011 (pack compiler)
                                        |
                                        +-> CAC-TCK-0012 (RunReceipt)
                                        |
                                        +-> CAC-TCK-0013 (pack compile CLI)
                                        |
                                        +-> CAC-TCK-0015 (export pipeline)
                                                |
                                                +-> CAC-TCK-0016 (conformance)
                                                |
                                                +-> CAC-TCK-0017 (export CLI)

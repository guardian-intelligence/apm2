rfc_design_decisions:
  schema_version: "2026-01-27"
  template_version: "2026-01-27"
  rfc_id: RFC-0011

  architectural_overview: |
    CAC v1 introduces a closed-loop context pipeline with these core components:

    1. CAC-JSON Canonicalizer: Parses and emits deterministic canonical bytes (JCS-like)
    2. CAC Validator: Validates against JSON Schemas with strict unknown field rejection
    3. Bootstrap Schema Bundle: Immutable trust root embedded in binary
    4. Patch Engine: Applies JSON Patch/Merge Patch with replay protection
    5. DCP Index/Resolver: Resolves stable_id to content_hash for deterministic reads
    6. Context Compiler: Compiles ContextPackSpec to deep-pinned manifests
    7. Target Delivery: Deterministic rendering to vendor layouts with provenance
    8. AAT Harness: Generates CapabilityManifest and verifies via selftests

    All state transitions are recorded as signed kernel messages referencing immutable hashes.

  design_decisions:
    - id: DD-0001
      title: CAC-JSON as sole normative format
      decision: |
        Use a strict JSON profile (CAC-JSON) as the sole normative representation for all
        control artifacts. No floats (integers only within signed 64-bit range), duplicate
        keys forbidden, maximum depth 128, UTF-8 NFC normalized strings.
      alternatives:
        - id: ALT-0001-A
          description: Use YAML as normative format
          rejected_reason: YAML parsing is complex with multiple implementations producing different results. No canonical form standard.
        - id: ALT-0001-B
          description: Use Protocol Buffers for normative storage
          rejected_reason: Binary format reduces human reviewability. Schema evolution more complex. Existing ecosystem expects JSON.
      rationale: |
        JSON with strict constraints (JCS-like canonicalization) provides deterministic
        parsing across all platforms, human reviewability, and compatibility with existing
        tooling. Integer-only numbers eliminate float ambiguity.
      evidence_ids:
        - EVID-0001
      requirement_ids:
        - CAC-REQ-0001
      status: GROUNDED
      codebase_evidence:
        investigation_session: COUNCIL-RFC-0011-20260127-EXPLORE
        source_agent: SA-1
        findings:
          - file: crates/apm2-core/src/determinism/canonicalize.rs
            line: 1-49
            observation: |
              Existing YAML canonicalizer operates on serde_yaml::Value with TypedKey ordering.
              CAC-JSON requires new module on serde_json::Value with stricter constraints.
          - file: crates/apm2-core/src/events/canonical.rs
            line: 38-86
            observation: |
              Canonicalize trait provides extension point: impl Canonicalize for Type.
              New CAC canonicalizer should implement this trait for integration.
        recommended_approach: |
          Create new crates/apm2-core/src/determinism/canonicalize_json.rs implementing:
          1. RFC 8785 JCS profile with stricter CAC variant
          2. Integer-only numbers (no floats)
          3. Depth limit 128, NFC normalization
          4. Unknown field rejection at schema validation layer
          5. Embed canonicalizer_id and canonicalizer_version in envelopes

    - id: DD-0002
      title: Patch-first authoring with replay protection
      decision: |
        Machines produce typed patch streams (JSON Patch RFC 6902 / Merge Patch RFC 7396)
        rather than whole-document rewrites. All patches require expected_base_hash matching
        current artifact state. Patches produce AdmissionReceipt and emit ledger provenance.
      alternatives:
        - id: ALT-0002-A
          description: Allow whole-document writes without replay protection
          rejected_reason: No provenance, no replay protection, no audit trail. Violates security properties.
        - id: ALT-0002-B
          description: Use git-like version control for artifacts
          rejected_reason: Git is too heavyweight for individual artifact versioning. Patches are more atomic.
      rationale: |
        Patch-first authoring enables fine-grained provenance, prevents stale overwrites,
        and supports compaction without losing history. Replay protection ensures concurrent
        modifications are detected.
      evidence_ids:
        - EVID-0003
      requirement_ids:
        - CAC-REQ-0002
      status: GROUNDED
      codebase_evidence:
        investigation_session: COUNCIL-RFC-0011-20260127-EXPLORE
        source_agent: SA-1
        findings:
          - file: crates/apm2-core/src/events/ci.rs
            line: 106-129
            observation: |
              CI event family uses separate JSON storage with EventStore trait pattern.
              Immutability documented in CTR-CI001 contracts.
          - file: crates/apm2-core/src/events/apm2.kernel.v1.rs
            line: 36-57
            observation: |
              Kernel events use Protobuf oneof with tags 10-17 allocated.
              Tags 18+ available for new CAC event types.
        recommended_approach: |
          Dual-tier event emission:
          - Kernel events (hash-chained, signed): AdmissionAccepted, CompilationCompleted, ExportGenerated
          - CI events (audit/observability): CACAdmissionReceipt, CACPackStatus
          CI events reference kernel hash as source of truth.

    - id: DD-0003
      title: Hermetic consumption via ContextPacks
      decision: |
        Consumption holons receive ContextPack manifests with deep-pinned dependencies.
        All fetches use stable-ID deterministic reads via ArtifactFetch tool. Discretionary
        context discovery is policy-denied and emits DefectRecord.
      alternatives:
        - id: ALT-0003-A
          description: Allow limited discovery with budget constraints
          rejected_reason: Introduces non-determinism and potential policy leaks. Harder to audit.
        - id: ALT-0003-B
          description: Pre-load all artifacts at session start
          rejected_reason: Memory-prohibitive for large packs. Lazy loading with stable IDs is more efficient.
      rationale: |
        Hermetic consumption ensures deterministic execution. Pack misses are treated as
        compiler defects, not execution necessities. This creates a feedback loop that
        improves pack completeness over time.
      evidence_ids:
        - EVID-0005
        - EVID-0010
      requirement_ids:
        - CAC-REQ-0003
        - CAC-REQ-0011
      status: GROUNDED
      codebase_evidence:
        investigation_session: COUNCIL-RFC-0011-20260127-EXPLORE
        source_agent: SA-2
        findings:
          - file: crates/apm2-core/src/policy/engine.rs
            line: 118-137
            observation: |
              RuleType enum is #[non_exhaustive] allowing ConsumptionMode extension.
              Pattern proven with Network/Filesystem rules.
          - file: crates/apm2-core/src/tool/apm2.tool.v1.rs
            line: 23-46
            observation: |
              Tool protocol oneof has ArtifactPublish (write direction).
              ArtifactFetch (read direction) can be added as tag 17.
        recommended_approach: |
          1. Add ConsumptionMode RuleType with Rule.stable_ids field
          2. Add ArtifactFetch tool with stable_id and content_hash fields
          3. Policy evaluates against allowlist in consumption mode
          4. Content-hash-only denied in consumption mode per CAC-REQ-0011

    - id: DD-0004
      title: Bootstrap trust root with binary embedding
      decision: |
        Embed a minimal schema bundle pinned by hash in the apm2 binary. Bootstrap verification
        at startup; refuse to operate if verification fails. Admission rejects patches
        targeting bootstrap stable IDs.
      alternatives:
        - id: ALT-0004-A
          description: Load bootstrap from filesystem at startup
          rejected_reason: Filesystem could be tampered with. No cryptographic binding to binary version.
        - id: ALT-0004-B
          description: Fetch bootstrap from trusted server
          rejected_reason: Introduces network dependency and additional attack surface. Offline operation compromised.
      rationale: |
        Binary embedding ensures the trust root cannot be modified without a new binary
        release. Provides strong cryptographic binding between binary version and schema
        expectations. Supports air-gapped deployments.
      evidence_ids:
        - EVID-0008
      requirement_ids:
        - CAC-REQ-0010
      status: GROUNDED
      codebase_evidence:
        investigation_session: COUNCIL-RFC-0011-20260127-EXPLORE
        source_agent: SA-3
        findings:
          - file: crates/apm2-core/build.rs
            line: 12-35
            observation: |
              prost_build::Config pattern with deterministic BTreeMap already in use.
              println!("cargo:rerun-if-changed=") tracks proto file changes.
          - file: crates/apm2-core/src/evidence/mod.rs
            line: 77-98
            observation: |
              Evidence module exports EvidencePublisher, GateReceipt patterns.
              Bootstrap can use EvidenceCategory::BootstrapSchema.
        recommended_approach: |
          1. Generate bootstrap bundle in build.rs after proto compilation
          2. Store schemas at crates/apm2-core/bootstrap/schemas/
          3. Embed via include_bytes! with hash verification
          4. Runtime verify_bootstrap_hash() fails startup on mismatch

    - id: DD-0005
      title: Target profiles for vendor compilation
      decision: |
        Target profiles define rendering, retrieval, and delivery constraints independent
        of model intelligence. CAC-JSON is always source of truth; vendor layouts (Markdown,
        directories) are derived outputs with embedded provenance.
      alternatives:
        - id: ALT-0005-A
          description: Treat vendor layouts as source of truth with CAC as derived
          rejected_reason: Loses canonical representation benefits. Drift between representations.
        - id: ALT-0005-B
          description: Maintain bidirectional sync between CAC and vendor formats
          rejected_reason: Complex, error-prone, and hard to audit. One direction (CAC -> vendor) is simpler.
      rationale: |
        Target profiles decouple internal IR from vendor ABIs. Model capability is a
        compile-time contract, not a runtime assumption. Export determinism is verifiable
        via conformance tests.
      evidence_ids:
        - EVID-0006
        - EVID-0009
      requirement_ids:
        - CAC-REQ-0005
        - CAC-REQ-0013
      status: GROUNDED
      codebase_evidence:
        investigation_session: COUNCIL-RFC-0011-20260127-EXPLORE
        source_agent: SA-2
        findings:
          - file: crates/apm2-core/src/policy/schema.rs
            line: 118-137
            observation: |
              Policy rules support budget, rendering, retrieval constraints.
              TargetProfile can leverage existing rule composition patterns.
          - file: crates/apm2-core/src/model_router/profile.rs
            line: 1-50
            observation: |
              Model routing profiles exist with capability constraints.
              TargetProfile follows same versioned profile pattern.
        recommended_approach: |
          TargetProfile schema requires:
          - budget_policy (mandatory): token/artifact/byte budgets
          - rendering_policy (mandatory): stage taxonomy (plan/implement/review/ops)
          - retrieval_policy (optional with defaults): max_fetch_bytes, inline_threshold

    - id: DD-0006
      title: CapabilityManifest generated from binary selftests
      decision: |
        Generate CapabilityManifest from the apm2 binary via hermetic selftests (AAT).
        AATReceipt is cryptographically bound to binary hash. Receipts gate critical
        cutovers and agent planning.
      alternatives:
        - id: ALT-0006-A
          description: Handwritten capability declarations
          rejected_reason: Can drift from actual behavior. No verification of claims.
        - id: ALT-0006-B
          description: Generate capabilities from code analysis only
          rejected_reason: Static analysis misses runtime behavior. Tests are more reliable truth.
      rationale: |
        Selftests prove capabilities exist, not just that code paths exist. Binary binding
        prevents receipt reuse across versions. Agents can trust capabilities are verified.
      evidence_ids:
        - EVID-0007
      requirement_ids:
        - CAC-REQ-0014
      status: GROUNDED
      codebase_evidence:
        investigation_session: COUNCIL-RFC-0011-20260127-EXPLORE
        source_agent: SA-3
        findings:
          - file: xtask/src/aat/executor.rs
            line: 95-207
            observation: |
              HypothesisExecutor is stateless and generic; reusable for CAC tests.
              execute() takes &mut Hypothesis, runs verification, captures results.
          - file: xtask/src/aat/types.rs
            line: 203-237
            observation: |
              Hypothesis struct is concrete, not trait-based.
              CacSchemaTest can wrap as adapter without parallel hierarchy.
          - file: crates/apm2-core/src/evidence/receipt.rs
            line: 344-429
            observation: |
              GateReceipt has Ed25519 signature verification.
              AATReceipt can follow same pattern with binary_hash binding.
        recommended_approach: |
          1. Extend HypothesisExecutor to handle CacSchemaTest via adapter
          2. Add cac_harness.rs module under xtask/src/aat/ (NOT parallel hierarchy)
          3. Binary hash included via CARGO_PKG_VERSION + target triple + profile
          4. AATReceipt signed with Ed25519 using GateReceipt pattern

    - id: DD-0007
      title: Typed quantities with explicit units
      decision: |
        All budgets, timeouts, costs, and probabilities are expressed as typed quantities
        with explicit units (ms, bytes, tokens, count, percent, usd). Unit mismatches
        are rejected at validation. Cross-unit arithmetic fails at compile time.
      alternatives:
        - id: ALT-0007-A
          description: Use implicit units with naming conventions (e.g., timeout_ms)
          rejected_reason: Error-prone. No compile-time enforcement. Easy to mix units.
        - id: ALT-0007-B
          description: Use floating-point numbers for quantities
          rejected_reason: Float representation issues. CAC-JSON prohibits floats for determinism.
      rationale: |
        Typed quantities prevent unit mismatch errors that could cause silent failures
        in budget enforcement. Scaled integers preserve precision. Schema validation
        enforces correctness.
      evidence_ids:
        - EVID-0012
      requirement_ids:
        - CAC-REQ-0008
      status: DECIDED

    - id: DD-0008
      title: DCP as projection over ledger events
      decision: |
        Deterministic Content Plane (DCP) is implemented as an index/projection over
        immutable artifacts and ledger events, not an independent mutable source of truth.
        Stable-ID resolution reconstructs from ledger events.
      alternatives:
        - id: ALT-0008-A
          description: DCP as independent database with sync to ledger
          rejected_reason: Creates dual source of truth. Sync failures cause inconsistency.
        - id: ALT-0008-B
          description: Store stable-ID mappings in separate file system
          rejected_reason: Not hash-chained. Loses provenance and audit properties.
      rationale: |
        Projection-based DCP ensures consistency with ledger as the authoritative log.
        Index can be rebuilt from ledger at any time. Supports compaction checkpoints.
      evidence_ids:
        - EVID-0004
      requirement_ids:
        - CAC-REQ-0001
      status: GROUNDED
      codebase_evidence:
        investigation_session: COUNCIL-RFC-0011-20260127-EXPLORE
        source_agent: SA-1
        findings:
          - file: crates/apm2-core/src/ledger/storage.rs
            line: 1-100
            observation: |
              Ledger storage uses append-only log with content-addressed entries.
              DCP index can be rebuilt by replaying ledger events.
          - file: crates/apm2-core/src/events/apm2.kernel.v1.rs
            line: 580-604
            observation: |
              EvidencePublished events already exist with metadata fields.
              Can include dcp_id, artifact_kind, schema_id for CAC integration.
        recommended_approach: |
          DCP projection over ledger:
          1. Ledger is authoritative append-only log
          2. DCP index rebuilt from ledger on startup/compaction
          3. Stable-ID resolution queries projection cache
          4. Namespace governance: hierarchical format "org:project:kind:id"
          5. Collision detection in admission gate via namespace registry

  component_mapping:
    # RFC v2 (Grounded): Component mappings validated by Council investigation
    # Session: COUNCIL-RFC-0011-20260127-EXPLORE
    grounded:
      - requirement_id: CAC-REQ-0001
        title: Canonical context substrate (CAC-JSON)
        verified_components:
          - path: crates/apm2-core/src/determinism/canonicalize.rs
            status: EXTEND
            reason: "Existing YAML canonicalizer provides pattern; new JSON canonicalizer needed"
          - path: crates/apm2-core/src/events/canonical.rs
            status: EXTEND
            reason: "Canonicalize trait provides integration point"
          - path: crates/apm2-core/src/evidence/cas.rs
            status: REUSE
            reason: "Content-addressed storage already exists"
        new_components:
          - path: crates/apm2-core/src/determinism/canonicalize_json.rs
            reason: "New CAC-JSON canonicalizer with strict profile"
        confidence: HIGH
        discovery_needed: false
        investigation_evidence: SA-1

      - requirement_id: CAC-REQ-0002
        title: Patch-first machine authoring
        verified_components:
          - path: crates/apm2-core/src/ledger/storage.rs
            status: REUSE
            reason: "Append-only log for provenance"
          - path: crates/apm2-core/src/events/apm2.kernel.v1.rs
            status: EXTEND
            reason: "Add ContextEvent to Payload oneof (tag 18)"
          - path: crates/apm2-core/src/events/ci.rs
            status: EXTEND
            reason: "Add CACAdmissionReceipt for audit trail"
        new_components:
          - path: crates/apm2-core/src/cac/patch_engine.rs
            reason: "JSON Patch/Merge Patch with replay protection"
        confidence: HIGH
        discovery_needed: false
        investigation_evidence: SA-1

      - requirement_id: CAC-REQ-0003
        title: Hermetic consumption with deterministic reads
        verified_components:
          - path: crates/apm2-core/src/policy/engine.rs
            status: EXTEND
            reason: "Add ConsumptionMode RuleType"
          - path: crates/apm2-core/src/policy/schema.rs
            status: EXTEND
            reason: "Add stable_ids field to Rule struct"
          - path: crates/apm2-holon/src/episode/controller.rs
            status: EXTEND
            reason: "Emit RunReceipt at episode completion"
        new_components:
          - path: crates/apm2-core/src/tool/artifact_fetch.rs
            reason: "ArtifactFetch tool implementation"
        confidence: HIGH
        discovery_needed: false
        investigation_evidence: SA-2, SA-3

      - requirement_id: CAC-REQ-0010
        title: Bootstrap trust root immutability
        verified_components:
          - path: crates/apm2-core/build.rs
            status: EXTEND
            reason: "Add bootstrap bundle generation after proto compilation"
          - path: crates/apm2-core/src/lib.rs
            status: EXTEND
            reason: "Add include_bytes! for bootstrap bundle"
          - path: crates/apm2-core/src/evidence/mod.rs
            status: EXTEND
            reason: "Add EvidenceCategory::BootstrapSchema"
        new_components:
          - path: crates/apm2-core/bootstrap/schemas/
            reason: "Bootstrap schema files (JSON)"
        confidence: HIGH
        discovery_needed: false
        investigation_evidence: SA-3

      - requirement_id: CAC-REQ-0011
        title: ArtifactFetch tool protocol
        verified_components:
          - path: crates/apm2-core/src/tool/apm2.tool.v1.rs
            status: EXTEND
            reason: "Add ArtifactFetch to tool oneof (tag 17)"
          - path: crates/apm2-core/src/tool/validation.rs
            status: EXTEND
            reason: "Add validate_artifact_fetch()"
          - path: crates/apm2-core/src/policy/engine.rs
            status: EXTEND
            reason: "Route ArtifactFetch to ConsumptionMode rules"
        confidence: HIGH
        discovery_needed: false
        investigation_evidence: SA-2

      - requirement_id: CAC-REQ-0014
        title: AAT/selftest gating
        verified_components:
          - path: xtask/src/aat/executor.rs
            status: EXTEND
            reason: "HypothesisExecutor handles CAC schema tests via adapter"
          - path: xtask/src/aat/types.rs
            status: EXTEND
            reason: "Add CacSchemaTest struct"
          - path: crates/apm2-core/src/evidence/receipt.rs
            status: EXTEND
            reason: "AATReceipt follows GateReceipt signature pattern"
        new_components:
          - path: xtask/src/aat/cac_harness.rs
            reason: "CAC schema test harness (NOT parallel to xtask/src/aat)"
        confidence: HIGH
        discovery_needed: false
        investigation_evidence: SA-3

      - requirement_id: CAC-REQ-0015
        title: RunReceipt emission
        verified_components:
          - path: crates/apm2-holon/src/episode/controller.rs
            status: EXTEND
            reason: "Emit receipt at line 647-655 (EpisodeLoopResult::new)"
          - path: crates/apm2-holon/src/result.rs
            status: REUSE
            reason: "EpisodeResult already has tokens_consumed, time_consumed_ms, artifact_count"
        new_components:
          - path: crates/apm2-holon/src/receipt.rs
            reason: "RunReceipt struct with episode metadata"
        confidence: HIGH
        discovery_needed: false
        investigation_evidence: SA-3

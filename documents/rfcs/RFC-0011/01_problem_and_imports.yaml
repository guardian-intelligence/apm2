rfc_problem_and_imports:
  schema_version: "2026-01-27"
  template_version: "2026-01-27"
  rfc_id: RFC-0011

  problem_statement:
    primary: |
      Make context the authoritative program: a content-addressed context graph compiled
      through target profiles into deterministic packs and delivery payloads, with full
      provenance recorded as kernel messages.
    current_state: |
      The APM2 system lacks a single, canonical, machine-validated source of truth for the
      context that governs planning, execution, review, and operation. Context is scattered
      across Markdown files, scripts, and implicit CLI assumptions. This creates:
      - Unplanned context discovery during agent execution
      - Brittle agent behavior from unverified CLI assumptions
      - Slow innermost loop (code+review) due to missing context
      - Reviewers catching context-rooted bugs rather than coding mistakes
    why_now: |
      The existing APM2 kernel primitives (ledger, CAS, holonic execution) provide the
      foundation to build a canonical context pipeline. By making context machine-native,
      canonical, and enforceable, we can dramatically improve the innermost loop throughput
      and enable safe cutover to the APM2 CLI as the holonic control surface.

  failure_modes:
    - id: FM-0001
      name: Contract drift encoded in prose
      mechanism: Normative requirements appear in Markdown/scripts without schema validation
      impact: Agents mis-plan; reviewers miss implicit assumptions; behavior diverges from declared
      cac_solution: Schema admission rejects non-CAC-JSON normative artifacts; single canonical format

    - id: FM-0002
      name: Capability ambiguity in the CLI
      mechanism: CLI claims features via docs or flags but behavior is untested or partial
      impact: Agents freeze mid-flight; manual debugging required; loss of trust in automation
      cac_solution: CapabilityManifest verified by selftests (AAT); agents query capabilities at planning

    - id: FM-0003
      name: Unplanned tool calls during consumption
      mechanism: Consumption holons perform discretionary reads because context was not pre-compiled
      impact: Non-determinism; leaky policies; repeat incidents
      cac_solution: ContextPacks with deep-pinned dependencies; discretionary reads policy-denied

    - id: FM-0004
      name: Non-replayable research behavior
      mechanism: Context production uses tools without explicit leases/budgets and evidence snapshots
      impact: Irreproducible outputs; cannot audit decisions; cannot improve pack compiler
      cac_solution: Production holons operate under explicit leases/budgets with evidence in CAS

    - id: FM-0005
      name: Vendor ABI requirements dominate internal design
      mechanism: External systems require Markdown + directory layouts; teams treat outputs as source
      impact: Drift between internal and external representations; unclear provenance
      cac_solution: Target Profiles for deterministic compilation; internal CAC-JSON always source of truth

  imported_requirements:
    - prd_requirement_id: REQ-0001
      rfc_local_id: CAC-REQ-0001
      title: Canonical context substrate (CAC-JSON)
      statement: |
        All normative control artifacts MUST be stored as CAC-JSON, validated against
        versioned schemas with fail-closed behavior (unknown fields rejected), canonicalized
        to stable bytes prior to admission, and addressable by stable IDs and immutable
        content hashes (CAS).
      acceptance_criteria:
        - Schema admission rejects non-CAC-JSON normative artifacts
        - Unknown fields are rejected; validation failures block admission
        - canonicalize(canonical_bytes) == canonical_bytes for all valid inputs
        - DCP resolution returns pinned content_hash for stable_id

    - prd_requirement_id: REQ-0002
      rfc_local_id: CAC-REQ-0002
      title: Patch-first machine authoring
      statement: |
        Machines MUST produce changes as patch streams (JSON Patch / Merge Patch) rather
        than whole-document rewrites. Admission MUST enforce replay protection via expected
        base hash. Every accepted patch MUST produce an admission receipt and emit ledger provenance.
      acceptance_criteria:
        - PatchRecords use JSON Patch (RFC 6902) or Merge Patch (RFC 7396) format
        - Patch with wrong expected_base_hash is rejected with replay violation event
        - AdmissionReceipt references patch_hash, base_hash, new_hash, schema_hash

    - prd_requirement_id: REQ-0003
      rfc_local_id: CAC-REQ-0003
      title: Hermetic consumption with deterministic reads
      statement: |
        Consumption holons MUST complete tasks using only preauthorized stable-ID fetches
        plus actuation tools. Discretionary context discovery MUST be denied and emit defects.
        Run receipts MUST capture context_pack_miss and sufficiency; misses MUST gate consumption.
      acceptance_criteria:
        - Discretionary read emits PolicyViolation and DefectRecord
        - Pack compilation resolves all dependencies and pins content hashes
        - RunReceipt schema includes miss count and sufficiency flag
        - Pack miss triggers DefectRecord and run failure unless escalated

    - prd_requirement_id: REQ-0004
      rfc_local_id: CAC-REQ-0004
      title: Bounded context production with replayable evidence
      statement: |
        Production holons MUST operate under explicit leases/budgets and publish replayable
        evidence. Tool calls MUST be classified as planned/unplanned and feed defect signals.
        Admissions MUST include a ChangeSet report to summarize semantic deltas.
      acceptance_criteria:
        - PatchRecord inputs include budget/lease refs; budget exceeded emits event
        - ToolEvent includes planned/unplanned classification
        - Admission requires ChangeSetReport for patch streams
        - EvidencePublished events reference CAS hashes for production evidence

    - prd_requirement_id: REQ-0005
      rfc_local_id: CAC-REQ-0005
      title: Target interoperability without drift
      statement: |
        Target profiles MUST define rendering, retrieval, and delivery constraints independent
        of model intelligence. Target payloads MUST be compiled deterministically from CAC
        sources and MUST NOT be treated as normative. Export manifests MUST provide provenance.
      acceptance_criteria:
        - TargetProfile schema includes budget, rendering, and retrieval policies
        - Exports from identical inputs produce byte-identical trees
        - ExportManifest includes source stable_ids and content hashes
        - Conformance test report passes for all target profiles

    - prd_requirement_id: REQ-0006
      rfc_local_id: CAC-REQ-0006
      title: Messaging-native control plane compatibility
      statement: |
        CAC actions (admission, compilation, export, selftest) MUST be reflected in kernel
        messages with hash references. Holons MUST be able to negotiate capabilities and
        retrieve required context via stable IDs referenced in messages.
      acceptance_criteria:
        - EvidencePublished events include dcp_id, artifact_kind, schema_id metadata
        - Agent obtains CapabilityManifest by stable_id and verifies AATReceipt
        - ArtifactFetch accepts stable_id from message metadata

    - prd_requirement_id: REQ-0007
      rfc_local_id: CAC-REQ-0007
      title: Measurable throughput and quality gains
      statement: |
        The system MUST provide measurable improvements: unplanned tool calls trending toward
        zero, PR cycle time improving after adoption, and AAT receipts gating critical operations.
      acceptance_criteria:
        - Metrics dashboard shows monotonic decrease in unplanned reads
        - WorkEvent timeline analysis shows reduced median cycle time
        - Cutover and agent planning require passing AATReceipt

    - prd_requirement_id: REQ-0008
      rfc_local_id: CAC-REQ-0008
      title: Typed quantities and context budgets
      statement: |
        Budgets, timeouts, costs, and probabilities MUST be expressed as typed quantities
        with explicit units. ContextPack compilation and validation MUST reject packs
        exceeding token/artifact/byte budgets.
      acceptance_criteria:
        - Budget fields validate against quantity schema with unit field
        - Schema validation rejects quantities with invalid unit values
        - Pack exceeding budget triggers compilation failure
        - Quantity serialization/deserialization preserves exact values

    - prd_requirement_id: REQ-0009
      rfc_local_id: CAC-REQ-0009
      title: Canonicalizer governance
      statement: |
        Canonicalizer id/version MUST be recorded in envelopes and receipts for all normative
        artifacts. Canonicalization test vectors MUST be governed artifacts pinned in the
        bootstrap bundle.
      acceptance_criteria:
        - Envelope schema requires canonicalizer_id and canonicalizer_version fields
        - AdmissionReceipt includes canonicalizer metadata
        - Bootstrap bundle includes canonicalizer.vectors artifact kind
        - Bootstrap manifest includes test vector content hash

    - prd_requirement_id: REQ-0010
      rfc_local_id: CAC-REQ-0010
      title: Bootstrap trust root immutability
      statement: |
        The bootstrap schema bundle MUST be embedded and pinned by hash in the apm2 binary.
        Admission MUST reject patches targeting bootstrap stable IDs. The validator MUST
        refuse to operate if bootstrap verification fails.
      acceptance_criteria:
        - Binary includes bootstrap manifest with content hashes
        - Startup fails if bootstrap verification fails
        - Patch targeting bootstrap ID returns rejection error
        - Validation fails if bootstrap is unverified

    - prd_requirement_id: REQ-0011
      rfc_local_id: CAC-REQ-0011
      title: ArtifactFetch tool protocol
      statement: |
        The system MUST provide an ArtifactFetch tool for deterministic retrieval by stable
        ID or content hash. Policy MUST enforce allowlisted reads in consumption mode.
        Content-hash-only fetches MUST be denied in consumption mode.
      acceptance_criteria:
        - Tool request schema includes stable_id and content_hash optional parameters
        - Tool response includes hash and optional inline content
        - Fetch of non-allowlisted stable_id returns PolicyViolation
        - Content-hash-only fetch in consumption mode returns PolicyViolation

    - prd_requirement_id: REQ-0012
      rfc_local_id: CAC-REQ-0012
      title: ContextPack compilation
      statement: |
        The system MUST compile ContextPackSpec into ContextPackManifest with derived artifacts.
        Compilation MUST deep-pin transitive dependencies. Compilation MUST be deterministic
        given resolved inputs and target profile. Budgets MUST be enforced.
      acceptance_criteria:
        - apm2 pack compile produces manifest from spec
        - Manifest includes all dependency stable_ids with content_hashes
        - Same inputs produce identical manifest and derived artifacts
        - Pack exceeding budget fails compilation

    - prd_requirement_id: REQ-0013
      rfc_local_id: CAC-REQ-0013
      title: Target delivery determinism
      statement: |
        Target delivery rendering MUST be deterministic and constrained by target profile.
        Exports MUST be byte-identical for identical inputs. Generated files MUST embed
        provenance. Conformance tests MUST be required.
      acceptance_criteria:
        - Same source artifacts produce byte-identical export tree
        - Export respects rendering policy from TargetProfile
        - Markdown files include provenance in YAML frontmatter
        - ExportReceipt includes conformance test report reference

    - prd_requirement_id: REQ-0014
      rfc_local_id: CAC-REQ-0014
      title: AAT/selftest gating
      statement: |
        The system MUST generate CapabilityManifest from the apm2 binary. Selftests MUST
        be hermetic and bounded. AATReceipt MUST be required for critical cutovers and
        agent planning gates.
      acceptance_criteria:
        - apm2 capabilities --json produces manifest matching actual behavior
        - AAT suites complete within max_duration_ms budget
        - Cutover fails without recent passing AATReceipt
        - Agent verifies receipt hash in CapabilityManifest before planning

    - prd_requirement_id: REQ-0015
      rfc_local_id: CAC-REQ-0015
      title: RunReceipt emission
      statement: |
        Consumption runs MUST emit RunReceipt capturing context_pack_miss, sufficiency,
        and budget usage. Pack misses MUST trigger DefectRecord emission and run failure
        by default unless explicitly in escalation-allowed mode.
      acceptance_criteria:
        - RunReceipt schema includes miss_count field
        - RunReceipt schema includes sufficiency boolean
        - RunReceipt includes budget delta quantities
        - context_pack_miss > 0 emits UNPLANNED_CONTEXT_READ defect and fails run

  non_goals:
    - id: NG-0001
      statement: Humans authoring normative context artifacts
      clarification: Context artifacts are machine-authored via patch streams. Human review focuses on semantic correctness and policy compliance.

    - id: NG-0002
      statement: Using token-optimized formats (e.g., TOON) as normative storage
      clarification: TOON and derived formats are prompt-pack encodings for LLM consumption. CAC-JSON is sole normative representation.

    - id: NG-0003
      statement: Replacing all existing kernel Protobuf schemas in this phase
      clarification: CAC operates alongside existing kernel event schemas. Proto changes are optional post-MVP enhancements.

    - id: NG-0004
      statement: Building a universal cross-vendor standard
      clarification: We compile to target profiles and delivery payloads specific to each vendor. Interoperability via deterministic compilation.

rfc_contracts_and_versioning:
  schema_version: "2026-01-27"
  template_version: "2026-01-27"
  rfc_id: RFC-0011

  contract_overview: |
    CAC v1 defines contracts at multiple levels:
    - Schema contracts: JSON Schemas for artifact kinds
    - Tool contracts: Request/response schemas for ArtifactFetch, DcpResolve
    - Receipt contracts: Structured evidence proving actions occurred
    - Event contracts: Kernel messages with hash references

    All contracts are versioned with semantic versioning. Breaking changes require
    schema_id updates and migration support.

  schema_contracts:
    - schema_id: cac.schema_definition.v1
      artifact_kind: schema.definition
      purpose: Defines schemas used to validate other artifacts
      normative: true
      version_strategy: |
        Schema definitions are immutable once published. New versions create new schema_ids.
        Bootstrap schemas are pinned by hash and require binary release to update.

    - schema_id: cac.policy_profile.v1
      artifact_kind: policy.profile
      purpose: Defines policy rules for tools, reads, budgets, and consumption hermeticity
      normative: true
      version_strategy: Additive changes allowed; removals require new version

    - schema_id: cac.budget_profile.v1
      artifact_kind: budget.profile
      purpose: Defines budgets/limits used in leases and tool calls
      normative: true
      version_strategy: Typed quantities ensure forward compatibility

    - schema_id: cac.holon_contract.v1
      artifact_kind: holon.contract
      purpose: Defines holon roles, modes, inputs/outputs, and allowed operations
      normative: true
      version_strategy: Additive operations; removal requires deprecation period

    - schema_id: cac.skill_spec.v1
      artifact_kind: skill.spec
      purpose: Defines agent skill/instruction bundles as machine-native context
      normative: true
      version_strategy: Skills versioned independently; pack refs use stable_id@version

    - schema_id: cac.target_profile.v1
      artifact_kind: target.profile
      purpose: Defines rendering, retrieval, and delivery constraints
      normative: true
      version_strategy: Profiles are versioned; packs pin specific profile versions

    - schema_id: cac.canonicalizer_vectors.v1
      artifact_kind: canonicalizer.vectors
      purpose: Governed canonicalization test vectors pinned in bootstrap
      normative: true
      version_strategy: Immutable after bootstrap; updates require binary release

    - schema_id: cac.context_pack_spec.v1
      artifact_kind: context_pack.spec
      purpose: Defines which stable IDs constitute a ContextPack
      normative: true
      version_strategy: |
        Pack specs capture dependency_review_hash at review time.
        Compilation fails if resolved hash differs from reviewed hash.

    - schema_id: cac.capabilities_manifest.v1
      artifact_kind: capabilities.manifest
      purpose: Declares what the CLI/kernel actually supports (truth surface)
      normative: true
      version_strategy: Generated from binary; tied to binary version

    - schema_id: cac.typed_quantity.v1
      artifact_kind: common.typed_quantity
      purpose: Standard for budgets, timeouts, costs with explicit units
      normative: true
      version_strategy: Units are extensible; new units additive only

  tool_contracts:
    - tool_id: ArtifactFetch
      description: Deterministic retrieval of context artifacts by stable ID or content hash
      request_schema:
        stable_id:
          type: string
          optional: true
          format: "namespace:kind:identifier[@version]"
        content_hash:
          type: string
          optional: true
          format: "b3-256 hex"
        expected_hash:
          type: string
          optional: true
          description: If provided, response must match or error
        max_bytes:
          type: integer
          required: true
          description: Maximum bytes to return
        format:
          type: enum
          required: true
          values: [raw_bytes, utf8_text, json_canonical]
      response_schema:
        result_hash:
          type: string
          format: "b3-256 hex"
        inline_result:
          type: bytes
          optional: true
          description: Content if under max_bytes
        size_bytes:
          type: integer
      error_cases:
        - NOT_FOUND: stable_id or content_hash not in DCP/CAS
        - HASH_MISMATCH: expected_hash does not match result
        - POLICY_VIOLATION: Fetch denied by consumption mode policy
        - CONTENT_HASH_ONLY_DENIED: Content-hash-only fetch in consumption mode

    - tool_id: DcpResolve
      description: Resolve stable_id to pinned content hash without fetching content
      request_schema:
        stable_id:
          type: string
          required: true
          format: "namespace:kind:identifier[@version]"
      response_schema:
        content_hash:
          type: string
          format: "b3-256 hex"
        schema_ref:
          type: string
        created_at:
          type: timestamp
      error_cases:
        - NOT_FOUND: stable_id not in DCP index
        - POLICY_VIOLATION: Resolution denied by policy

  receipt_contracts:
    - receipt_type: AdmissionReceipt
      schema_id: cac.admission_receipt.v1
      fields:
        patch_hash: "Hash of applied patch"
        base_hash: "Hash of artifact before patch"
        new_hash: "Hash of artifact after patch"
        schema_hash: "Hash of validating schema"
        canonicalizer_id: "Canonicalizer identifier"
        canonicalizer_version: "Canonicalizer version string"
        admission_timestamp: "ISO-8601 admission time"
        stable_id: "Stable ID of admitted artifact"

    - receipt_type: AATReceipt
      schema_id: cac.aat_receipt.v1
      fields:
        binary_hash: "BLAKE3-256 of apm2 binary"
        capability_manifest_hash: "Hash of generated manifest"
        test_suite_version: "Version of selftest suite"
        execution_timestamp: "ISO-8601 execution time"
        tests_passed: "Number of passing tests"
        tests_failed: "Number of failing tests"
        budget_used: "Typed quantity of resources consumed"

    - receipt_type: RunReceipt
      schema_id: cac.run_receipt.v1
      fields:
        context_pack_id: "stable_id of consumed pack"
        context_pack_miss: "Count of artifacts not in pack"
        context_pack_sufficiency: "Boolean: pack was complete"
        budget_delta: "Typed quantity of resources consumed"
        tool_call_summary: "Planned vs unplanned counts"
        run_timestamp: "ISO-8601 run time"
        holon_id: "Executing holon identifier"

    - receipt_type: ExportReceipt
      schema_id: cac.export_receipt.v1
      fields:
        source_stable_ids: "List of source artifact IDs"
        target_profile_id: "stable_id of target profile"
        export_tree_hash: "Merkle root of export tree"
        conformance_test_ref: "Hash of conformance test report"
        export_timestamp: "ISO-8601 export time"

  versioning_policy:
    schema_versioning: |
      - Schema IDs follow pattern: cac.<domain>.<kind>.v<major>
      - Major version increments for breaking changes
      - Breaking changes: removing fields, changing types, tightening constraints
      - Non-breaking changes: adding optional fields, loosening constraints (with care)

    stable_id_format: |
      Format: "namespace:kind:identifier[@version]"
      Examples:
        - "cac:schema:policy_profile.v1"
        - "cac:pack:agent_planner@1.2.0"
        - "org.example:skill:code_review@latest"

      Namespace governance: CNS-0009 requires registration with DOMAIN_KERNEL.
      Collision prevention: Admission validates format and namespace registration.

    migration_support: |
      When schema versions change:
      1. Old schema remains valid for existing artifacts
      2. New admissions use new schema
      3. Migration tool converts old artifacts to new schema
      4. Compaction can upgrade schema version with explicit migration patch

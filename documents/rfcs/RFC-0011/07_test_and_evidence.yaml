rfc_test_and_evidence:
  schema_version: "2026-01-27"
  template_version: "2026-01-27"
  rfc_id: RFC-0011

  test_strategy: |
    CAC v1 testing follows a layered approach:
    1. Unit tests: Per-function validation of canonicalizer, validator, patch engine
    2. Integration tests: End-to-end flows through admission, fetch, compilation
    3. Property tests: Invariants like canonicalization idempotence
    4. Conformance tests: Export determinism verification
    5. AAT (Agent Acceptance Tests): Capability truthing via selftests

  test_categories:
    - category: CANONICALIZATION
      description: Tests for CAC-JSON canonicalizer
      requirements_covered:
        - CAC-REQ-0001
        - CAC-REQ-0009
      test_cases:
        - test_id: TEST-CANON-001
          name: Idempotence property
          type: PROPERTY
          description: canonicalize(canonicalize(input)) == canonicalize(input)
          verification: Property-based test with arbitrary JSON inputs

        - test_id: TEST-CANON-002
          name: Integer-only numbers
          type: UNIT
          description: Reject floating-point numbers; accept integers within i64 range
          verification: Golden inputs with floats should fail

        - test_id: TEST-CANON-003
          name: Key ordering determinism
          type: UNIT
          description: Keys sorted lexicographically in output
          verification: Shuffled key orders produce identical output

        - test_id: TEST-CANON-004
          name: Duplicate key rejection
          type: UNIT
          description: Reject JSON with duplicate keys
          verification: Input with duplicate keys returns error

        - test_id: TEST-CANON-005
          name: UTF-8 NFC normalization
          type: UNIT
          description: Reject non-NFC strings; accept NFC normalized
          verification: NFD/NFKC/NFKD inputs rejected; NFC accepted

        - test_id: TEST-CANON-006
          name: Depth limit enforcement
          type: UNIT
          description: Reject JSON exceeding max depth 128
          verification: Deeply nested JSON (129 levels) rejected

        - test_id: TEST-CANON-007
          name: Cross-platform determinism
          type: GOLDEN
          description: Test vectors produce identical outputs across platforms
          verification: Golden test vectors with expected canonical bytes

    - category: VALIDATION
      description: Tests for JSON Schema validator
      requirements_covered:
        - CAC-REQ-0001
      test_cases:
        - test_id: TEST-VALID-001
          name: Unknown field rejection
          type: UNIT
          description: Reject artifacts with fields not in schema
          verification: Extra field triggers validation failure

        - test_id: TEST-VALID-002
          name: Required field enforcement
          type: UNIT
          description: Reject artifacts missing required fields
          verification: Missing required field triggers failure

        - test_id: TEST-VALID-003
          name: Type constraint enforcement
          type: UNIT
          description: Reject artifacts with wrong field types
          verification: String where integer expected triggers failure

        - test_id: TEST-VALID-004
          name: Size limit enforcement
          type: UNIT
          description: Reject arrays/objects exceeding 100000 members
          verification: Oversized array triggers failure

    - category: ADMISSION
      description: Tests for patch admission pipeline
      requirements_covered:
        - CAC-REQ-0002
        - CAC-REQ-0004
      test_cases:
        - test_id: TEST-ADMIT-001
          name: Replay protection
          type: UNIT
          description: Reject patches with wrong expected_base_hash
          verification: Hash mismatch triggers replay violation event

        - test_id: TEST-ADMIT-002
          name: JSON Patch application
          type: UNIT
          description: Apply RFC 6902 patches correctly
          verification: Golden patch produces expected result

        - test_id: TEST-ADMIT-003
          name: Merge Patch application
          type: UNIT
          description: Apply RFC 7396 patches correctly
          verification: Golden merge patch produces expected result

        - test_id: TEST-ADMIT-004
          name: AdmissionReceipt generation
          type: INTEGRATION
          description: Successful admission produces valid receipt
          verification: Receipt contains required fields and valid hashes

        - test_id: TEST-ADMIT-005
          name: Ledger event emission
          type: INTEGRATION
          description: Admission emits EvidencePublished event
          verification: Ledger contains event with correct metadata

    - category: FETCH
      description: Tests for ArtifactFetch tool protocol
      requirements_covered:
        - CAC-REQ-0011
      test_cases:
        - test_id: TEST-FETCH-001
          name: Stable-ID resolution
          type: UNIT
          description: Resolve stable_id to content_hash
          verification: Known stable_id returns expected hash

        - test_id: TEST-FETCH-002
          name: Content retrieval
          type: UNIT
          description: Fetch artifact content by stable_id
          verification: Retrieved content matches expected

        - test_id: TEST-FETCH-003
          name: Policy enforcement
          type: UNIT
          description: Deny non-allowlisted fetch in consumption mode
          verification: Fetch of non-allowlisted ID returns PolicyViolation

        - test_id: TEST-FETCH-004
          name: Content-hash-only denial
          type: UNIT
          description: Deny content-hash-only fetch in consumption mode
          verification: Fetch with hash only returns PolicyViolation

        - test_id: TEST-FETCH-005
          name: Hash mismatch detection
          type: UNIT
          description: Return error when expected_hash mismatches
          verification: Hash mismatch returns ToolError

    - category: PACK
      description: Tests for ContextPack compilation
      requirements_covered:
        - CAC-REQ-0003
        - CAC-REQ-0008
        - CAC-REQ-0012
        - CAC-REQ-0015
      test_cases:
        - test_id: TEST-PACK-001
          name: Transitive dependency resolution
          type: UNIT
          description: Include all transitive dependencies in manifest
          verification: Manifest contains all reachable stable_ids

        - test_id: TEST-PACK-002
          name: Deep-pinning
          type: UNIT
          description: Pin content hashes for all dependencies
          verification: All entries have content_hash field

        - test_id: TEST-PACK-003
          name: Compilation determinism
          type: PROPERTY
          description: Same inputs produce identical manifests
          verification: Re-compilation produces byte-identical output

        - test_id: TEST-PACK-004
          name: Budget enforcement
          type: UNIT
          description: Reject packs exceeding token/artifact/byte budgets
          verification: Over-budget pack fails compilation

        - test_id: TEST-PACK-005
          name: Dependency drift detection
          type: UNIT
          description: Fail compilation when resolved hash differs from reviewed
          verification: Drift triggers compilation failure

        - test_id: TEST-PACK-006
          name: RunReceipt generation
          type: INTEGRATION
          description: Consumption run produces valid receipt
          verification: Receipt contains miss count and sufficiency flag

    - category: EXPORT
      description: Tests for target delivery
      requirements_covered:
        - CAC-REQ-0005
        - CAC-REQ-0013
      test_cases:
        - test_id: TEST-EXPORT-001
          name: Determinism verification
          type: PROPERTY
          description: Re-export produces byte-identical tree
          verification: File tree hashes match across exports

        - test_id: TEST-EXPORT-002
          name: Provenance embedding
          type: UNIT
          description: Generated files include provenance metadata
          verification: Markdown frontmatter contains stable_ids and hashes

        - test_id: TEST-EXPORT-003
          name: Profile constraint adherence
          type: UNIT
          description: Export respects target profile policies
          verification: Output structure matches profile specification

        - test_id: TEST-EXPORT-004
          name: Conformance test execution
          type: INTEGRATION
          description: Conformance tests pass for export
          verification: ExportReceipt includes passing test report

    - category: AAT
      description: Tests for capability truthing
      requirements_covered:
        - CAC-REQ-0006
        - CAC-REQ-0007
        - CAC-REQ-0014
      test_cases:
        - test_id: TEST-AAT-001
          name: CapabilityManifest generation
          type: INTEGRATION
          description: Generate manifest matching actual behavior
          verification: All declared capabilities pass selftests

        - test_id: TEST-AAT-002
          name: Binary hash binding
          type: UNIT
          description: AATReceipt includes correct binary_hash
          verification: Receipt binary_hash matches computed hash

        - test_id: TEST-AAT-003
          name: Selftest hermeticity
          type: INTEGRATION
          description: Selftests complete without external dependencies
          verification: Tests pass in isolated environment

        - test_id: TEST-AAT-004
          name: Budget enforcement in selftests
          type: UNIT
          description: Selftests respect time/tool/token budgets
          verification: Over-budget test reports failure

        - test_id: TEST-AAT-005
          name: Gating enforcement
          type: INTEGRATION
          description: Agent planning requires valid AATReceipt
          verification: Planning fails without recent passing receipt

  evidence_requirements:
    - evidence_id: EVID-0001
      title: Canonicalization determinism test vectors
      description: Golden test vectors proving cross-platform canonicalization determinism
      evidence_type: TEST_RESULTS
      generation: "cargo test --features test_vectors canonicalization"
      required_for:
        - CAC-REQ-0001
        - CAC-REQ-0009

    - evidence_id: EVID-0002
      title: Schema validation strictness report
      description: Evidence that validator rejects unknown fields and enforces limits
      evidence_type: TEST_RESULTS
      generation: "cargo test validation_strictness"
      required_for:
        - CAC-REQ-0001

    - evidence_id: EVID-0003
      title: Admission provenance audit log
      description: Ledger events showing patch admission with replay protection
      evidence_type: AUDIT_LOG
      generation: "apm2 ledger query --filter admission"
      required_for:
        - CAC-REQ-0002
        - CAC-REQ-0004

    - evidence_id: EVID-0004
      title: DCP resolution accuracy test
      description: Evidence that stable_id resolution returns correct content_hash
      evidence_type: TEST_RESULTS
      generation: "cargo test dcp_resolution"
      required_for:
        - CAC-REQ-0001

    - evidence_id: EVID-0005
      title: Consumption hermeticity verification
      description: Evidence that discretionary reads are denied in consumption mode
      evidence_type: TEST_RESULTS
      generation: "cargo test consumption_hermeticity"
      required_for:
        - CAC-REQ-0003
        - CAC-REQ-0011

    - evidence_id: EVID-0006
      title: Export determinism verification
      description: Evidence that identical inputs produce byte-identical exports
      evidence_type: TEST_RESULTS
      generation: "cargo test export_determinism"
      required_for:
        - CAC-REQ-0005
        - CAC-REQ-0013

    - evidence_id: EVID-0007
      title: Capability manifest accuracy
      description: Evidence that manifest matches actual binary capabilities
      evidence_type: AAT_RECEIPT
      generation: "apm2 selftest --output receipt.json"
      required_for:
        - CAC-REQ-0006
        - CAC-REQ-0014

    - evidence_id: EVID-0008
      title: Bootstrap integrity verification
      description: Evidence that startup fails without valid bootstrap
      evidence_type: TEST_RESULTS
      generation: "cargo test bootstrap_integrity"
      required_for:
        - CAC-REQ-0010

    - evidence_id: EVID-0009
      title: Target profile conformance report
      description: Evidence that exports conform to target profile constraints
      evidence_type: CONFORMANCE_REPORT
      generation: "apm2 export --verify --profile <profile>"
      required_for:
        - CAC-REQ-0005

    - evidence_id: EVID-0010
      title: ContextPack compilation audit
      description: Evidence of deep-pinning and dependency resolution
      evidence_type: MANIFEST
      generation: "apm2 pack compile --spec <spec> --output manifest.json"
      required_for:
        - CAC-REQ-0003
        - CAC-REQ-0012

    - evidence_id: EVID-0011
      title: RunReceipt samples
      description: Sample run receipts showing sufficiency and miss tracking
      evidence_type: RECEIPT_SAMPLES
      generation: "Collected from consumption runs"
      required_for:
        - CAC-REQ-0003
        - CAC-REQ-0015

    - evidence_id: EVID-0012
      title: Typed quantity validation tests
      description: Evidence that typed quantities enforce units and reject mismatches
      evidence_type: TEST_RESULTS
      generation: "cargo test typed_quantity"
      required_for:
        - CAC-REQ-0008

    - evidence_id: EVID-0013
      title: PR cycle time analysis
      description: Analysis of work event timelines before/after CAC adoption
      evidence_type: METRICS_REPORT
      generation: "apm2 metrics analyze --metric pr_cycle_time"
      required_for:
        - CAC-REQ-0007

    - evidence_id: EVID-0014
      title: Defect recurrence analysis
      description: Clustering analysis of defect signatures over time
      evidence_type: METRICS_REPORT
      generation: "apm2 metrics analyze --metric defect_recurrence"
      required_for:
        - CAC-REQ-0007

    - evidence_id: EVID-0015
      title: Escalation policy enforcement test
      description: Evidence that escalation requires proper authorization
      evidence_type: TEST_RESULTS
      generation: "cargo test escalation_policy"
      required_for:
        - CAC-REQ-0003

rfc_design_decisions:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"

  decisions:
    - id: DD-008-001
      title: "Event-Driven vs Polling Architecture"
      statement: |
        Use GitHub webhooks to receive CI completion events rather than polling
        from agents or a background service.
      context: |
        Agents currently poll CI status, wasting context window and tokens. We need
        a mechanism to notify the system when CI completes without active polling.
      alternatives:
        - id: ALT-0001
          name: "Agent polling (status quo)"
          pros:
            - "No infrastructure changes"
            - "Simple to understand"
          cons:
            - "Wastes context window"
            - "Wastes tokens"
            - "Encourages gaming"
          security_tradeoffs:
            - "Agents may game CI status out of frustration"
          operability_tradeoffs:
            - "Poor token efficiency"
        - id: ALT-0002
          name: "Background polling service"
          pros:
            - "Removes polling from agent"
            - "Single service handles all PRs"
          cons:
            - "Still polling, just moved"
            - "Additional infrastructure"
            - "Latency between poll intervals"
          security_tradeoffs: []
          operability_tradeoffs:
            - "Must manage polling service uptime"
        - id: ALT-0003
          name: "GitHub webhooks (chosen)"
          pros:
            - "Truly event-driven"
            - "Zero polling overhead"
            - "Immediate notification"
            - "GitHub handles retry logic"
          cons:
            - "Requires webhook endpoint"
            - "Must handle webhook security"
            - "Requires internet-accessible endpoint"
          security_tradeoffs:
            - "Webhook endpoint must validate signatures"
          operability_tradeoffs:
            - "Must maintain webhook endpoint uptime"
      chosen_rationale: |
        GitHub webhooks provide true event-driven notification without any polling.
        The webhook endpoint can be secured with HMAC signature validation. GitHub
        handles retries for failed deliveries. This eliminates polling entirely.
      impacted_requirement_ids:
        - HANDOFF-001
      evidence_ids:
        - EVID-8001

    - id: DD-008-002
      title: "Webhook Signature Validation Method"
      statement: |
        Validate GitHub webhook signatures using HMAC-SHA256 with a shared secret
        configured in both GitHub and our webhook handler.
      context: |
        Webhook endpoints are publicly accessible. We must ensure only GitHub can
        trigger CI completion events, not malicious actors.
      alternatives:
        - id: ALT-0001
          name: "No validation"
          pros:
            - "Simple implementation"
          cons:
            - "Anyone can fake CI completion"
            - "Major security vulnerability"
          security_tradeoffs:
            - "Unacceptable security risk"
          operability_tradeoffs: []
        - id: ALT-0002
          name: "IP allowlist"
          pros:
            - "GitHub IPs are documented"
          cons:
            - "GitHub IPs change"
            - "Does not verify payload integrity"
            - "Bypassable with IP spoofing in some scenarios"
          security_tradeoffs:
            - "Incomplete protection"
          operability_tradeoffs:
            - "Must maintain IP allowlist"
        - id: ALT-0003
          name: "HMAC-SHA256 signature (chosen)"
          pros:
            - "GitHub native mechanism"
            - "Verifies payload integrity"
            - "Shared secret is secure"
            - "Well-documented standard"
          cons:
            - "Must manage secret securely"
          security_tradeoffs:
            - "Secret exposure would compromise security"
          operability_tradeoffs:
            - "Secret rotation requires coordination"
      chosen_rationale: |
        HMAC-SHA256 is GitHub's standard webhook security mechanism. It verifies
        both authenticity (only GitHub knows the secret) and integrity (payload
        cannot be tampered with). The secret can be stored in environment variables
        or a secrets manager.
      impacted_requirement_ids:
        - HANDOFF-001
        - HANDOFF-005
      evidence_ids:
        - EVID-8001

    - id: DD-008-003
      title: "Ledger Event Schema for CI Completion"
      statement: |
        Define a CIWorkflowCompleted ledger event that captures all relevant
        information from the GitHub webhook payload.
      context: |
        The webhook payload contains rich information about CI results. We need
        to capture this in our ledger format for audit trail and task queue
        integration.
      alternatives:
        - id: ALT-0001
          name: "Store raw webhook payload"
          pros:
            - "No information loss"
            - "Simple to implement"
          cons:
            - "Schema is GitHub's, not ours"
            - "Harder to query"
            - "May contain irrelevant data"
          security_tradeoffs: []
          operability_tradeoffs:
            - "Tight coupling to GitHub payload format"
        - id: ALT-0002
          name: "Normalized ledger event (chosen)"
          pros:
            - "Our schema, our control"
            - "Contains only relevant data"
            - "Easy to query and process"
            - "Decoupled from GitHub specifics"
          cons:
            - "Must maintain mapping"
            - "May lose some GitHub-specific data"
          security_tradeoffs: []
          operability_tradeoffs:
            - "Mapping code must be updated if GitHub changes payload"
      chosen_rationale: |
        A normalized ledger event gives us control over the schema and ensures
        we capture exactly what we need for task queue integration. The event
        includes: pr_number, commit_sha, conclusion, and array of check results.
      impacted_requirement_ids:
        - HANDOFF-002
      evidence_ids:
        - EVID-8002

    - id: DD-008-004
      title: "Task Queue Phase Transitions"
      statement: |
        Work items transition through phases including CI_PENDING, and the
        CIWorkflowCompleted event triggers the transition to the next phase.
      context: |
        Work items have a lifecycle. After an agent creates a PR, the work
        enters CI_PENDING phase. We need to define how CI completion affects
        this phase.
      alternatives:
        - id: ALT-0001
          name: "Single phase (no CI gating)"
          pros:
            - "Simple state machine"
          cons:
            - "No CI integration"
            - "Agents could work on failed PRs"
          security_tradeoffs:
            - "Quality gate bypassed"
          operability_tradeoffs: []
        - id: ALT-0002
          name: "CI_PENDING phase with event-driven transition (chosen)"
          pros:
            - "Clear phase for CI waiting"
            - "Event-driven transition"
            - "Prevents work on failed PRs"
            - "Integrates with PRD-0004 lease model"
          cons:
            - "More complex state machine"
          security_tradeoffs:
            - "CI gate enforced by design"
          operability_tradeoffs:
            - "Must handle edge cases (CI reruns, etc.)"
      chosen_rationale: |
        The CI_PENDING phase clearly indicates work is waiting for CI. The
        CIWorkflowCompleted event transitions work to READY_FOR_REVIEW (success)
        or BLOCKED (failure). This integrates cleanly with PRD-0004 task queue.
      impacted_requirement_ids:
        - HANDOFF-003
      evidence_ids:
        - EVID-8003

    - id: DD-008-005
      title: "Agent Exit Protocol Design"
      statement: |
        Agents must output a structured completion signal when done with a phase,
        enabling clean handoff without polling.
      context: |
        Agents currently have no standard way to signal "I'm done, CI will run,
        another agent should pick up". We need a protocol for this.
      alternatives:
        - id: ALT-0001
          name: "No exit protocol"
          pros:
            - "No changes to agents"
          cons:
            - "No clean handoff"
            - "State unclear after agent exits"
          security_tradeoffs: []
          operability_tradeoffs:
            - "Manual intervention often required"
        - id: ALT-0002
          name: "Structured exit signal (chosen)"
          pros:
            - "Clear completion indication"
            - "Enables automation"
            - "Can include handoff metadata"
          cons:
            - "Agents must implement protocol"
            - "Must be enforced/validated"
          security_tradeoffs: []
          operability_tradeoffs:
            - "Cleaner automation, less manual intervention"
      chosen_rationale: |
        A structured exit protocol enables automated handoff. The agent outputs
        a JSON completion signal including: phase completed, PR URL (if created),
        evidence bundle reference, and next expected phase. The system validates
        this and updates work item state.
      impacted_requirement_ids:
        - HANDOFF-004
      evidence_ids:
        - EVID-8004

    - id: DD-008-006
      title: "Anti-Gaming Control Implementation"
      statement: |
        CI status can only be updated via authenticated GitHub webhooks; no
        API endpoint allows agents to directly set CI status.
      context: |
        Agents have been observed trying to game CI status when frustrated by
        long CI runs or repeated failures. We must prevent this.
      alternatives:
        - id: ALT-0001
          name: "Trust agents"
          pros:
            - "Simple implementation"
          cons:
            - "Agents will game the system"
            - "CI quality gate meaningless"
          security_tradeoffs:
            - "Unacceptable - undermines CI"
          operability_tradeoffs: []
        - id: ALT-0002
          name: "Webhook-only CI status (chosen)"
          pros:
            - "CI status trusted source is GitHub"
            - "Cannot be bypassed by agents"
            - "Audit trail of all updates"
          cons:
            - "Requires webhook infrastructure"
          security_tradeoffs:
            - "Strong guarantee of CI authenticity"
          operability_tradeoffs:
            - "Webhook endpoint must be reliable"
      chosen_rationale: |
        By only accepting CI status from authenticated GitHub webhooks, we ensure
        agents cannot game the system. The audit trail records the webhook signature
        for each CI update. Attempts by agents to call CI status endpoints would
        be rejected and logged.
      impacted_requirement_ids:
        - HANDOFF-005
      evidence_ids:
        - EVID-8005

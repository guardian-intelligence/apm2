rfc_ticket_decomposition:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"
  principles:
  - "Tickets are atomic and independently verifiable"
  - "Each ticket references requirement_ids and evidence_ids"
  - "Cross-ticket dependencies are explicit and minimal"
  - "Tickets are ordered to enable incremental progress"
  - "Each phase can be feature-flagged independently"

  decomposition_strategy: "Sequential phases - infrastructure before integration"

  ticket_plan:
    ticket_storage_root: "documents/work/tickets/"
    tickets:
    # =================================================================
    # PHASE 0: Webhook Infrastructure
    # =================================================================
    - ticket_id: TCK-00085
      title: "Implement GitHub webhook handler for workflow_run.completed"
      ticket_files:
        meta_ref: "documents/work/tickets/TCK-00085.yaml#ticket_meta"
        body_path: "documents/work/tickets/TCK-00085.md"
      scope:
        in_scope:
        - "Create HTTP endpoint POST /webhooks/github"
        - "Implement HMAC-SHA256 signature validation"
        - "Parse workflow_run.completed payload"
        - "Add rate limiting"
        - "Add feature flag WEBHOOK_HANDLER_ENABLED"
        out_of_scope:
        - "Ledger event emission (Phase 1)"
        - "Task queue integration (Phase 2)"
        - "Other webhook event types"
      binds:
        requirement_ids:
        - HANDOFF-001
        - HANDOFF-005
        evidence_ids:
        - EVID-8001
      custody_agent_roles:
      - AGENT_IMPLEMENTER
      responsibility_domains:
      - DOMAIN_RUNTIME
      - DOMAIN_SECURITY
      dependencies: []
      definition_of_done:
        criteria:
        - "Webhook endpoint accepts POST requests"
        - "Valid signatures are accepted (200/202)"
        - "Invalid signatures are rejected (401)"
        - "Invalid payloads are rejected (400)"
        - "Rate limiting prevents abuse (429)"
        - "Feature flag controls endpoint availability"
        evidence_ids:
        - EVID-8001

    # =================================================================
    # PHASE 1: Ledger Event Emission
    # =================================================================
    - ticket_id: TCK-00086
      title: "Define CIWorkflowCompleted ledger event schema"
      ticket_files:
        meta_ref: "documents/work/tickets/TCK-00086.yaml#ticket_meta"
        body_path: "documents/work/tickets/TCK-00086.md"
      scope:
        in_scope:
        - "Define CIWorkflowCompleted event schema"
        - "Implement event emission from webhook handler"
        - "Add idempotency via delivery_id tracking"
        - "Persist events to ledger"
        - "Add feature flag CI_EVENTS_ENABLED"
        out_of_scope:
        - "Task queue integration (Phase 2)"
        - "Processing events for phase transitions"
      binds:
        requirement_ids:
        - HANDOFF-002
        evidence_ids:
        - EVID-8002
      custody_agent_roles:
      - AGENT_IMPLEMENTER
      responsibility_domains:
      - DOMAIN_RUNTIME
      dependencies:
      - TCK-00085
      definition_of_done:
        criteria:
        - "Event schema defined in code"
        - "Webhook handler emits events on valid webhooks"
        - "Duplicate delivery_ids are handled idempotently"
        - "Events are persisted to ledger"
        - "Events can be queried from ledger"
        evidence_ids:
        - EVID-8002

    # =================================================================
    # PHASE 2: Task Queue Integration
    # =================================================================
    - ticket_id: TCK-00087
      title: "Implement task queue for CI-gated work items"
      ticket_files:
        meta_ref: "documents/work/tickets/TCK-00087.yaml#ticket_meta"
        body_path: "documents/work/tickets/TCK-00087.md"
      scope:
        in_scope:
        - "Add CI_PENDING phase to work item lifecycle"
        - "Subscribe to CIWorkflowCompleted events"
        - "Implement phase transition logic"
        - "Add READY_FOR_REVIEW and BLOCKED phases"
        - "Integrate with PRD-0004 lease mechanism"
        - "Add feature flag CI_GATED_QUEUE_ENABLED"
        out_of_scope:
        - "Agent exit protocol (Phase 3)"
        - "Integration tests (Phase 4)"
      binds:
        requirement_ids:
        - HANDOFF-003
        evidence_ids:
        - EVID-8003
      custody_agent_roles:
      - AGENT_IMPLEMENTER
      responsibility_domains:
      - DOMAIN_RUNTIME
      dependencies:
      - TCK-00086
      definition_of_done:
        criteria:
        - "Work items can enter CI_PENDING phase"
        - "CIWorkflowCompleted success -> READY_FOR_REVIEW"
        - "CIWorkflowCompleted failure -> BLOCKED"
        - "Agents can claim READY_FOR_REVIEW work"
        - "Agents cannot claim CI_PENDING work"
        - "Feature flag controls queue behavior"
        evidence_ids:
        - EVID-8003

    # =================================================================
    # PHASE 3: Agent Exit Protocol
    # =================================================================
    - ticket_id: TCK-00088
      title: "Define agent exit protocol and session cleanup"
      ticket_files:
        meta_ref: "documents/work/tickets/TCK-00088.yaml#ticket_meta"
        body_path: "documents/work/tickets/TCK-00088.md"
      scope:
        in_scope:
        - "Define agent exit signal JSON schema"
        - "Implement exit signal parsing"
        - "Emit AgentSessionCompleted event"
        - "Update work item state on exit"
        - "Document exit protocol for agents"
        - "Add feature flag AGENT_EXIT_PROTOCOL_ENABLED"
        out_of_scope:
        - "Integration tests (Phase 4)"
        - "Modifying existing agent implementations"
      binds:
        requirement_ids:
        - HANDOFF-004
        evidence_ids:
        - EVID-8004
      custody_agent_roles:
      - AGENT_IMPLEMENTER
      responsibility_domains:
      - DOMAIN_RUNTIME
      dependencies:
      - TCK-00087
      definition_of_done:
        criteria:
        - "Exit signal schema defined"
        - "Exit signals are parsed and validated"
        - "AgentSessionCompleted events emitted"
        - "Work item state updated correctly"
        - "Protocol documentation complete"
        - "Feature flag controls validation"
        evidence_ids:
        - EVID-8004

    # =================================================================
    # PHASE 4: Integration Testing
    # =================================================================
    - ticket_id: TCK-00089
      title: "Add agent handoff integration tests"
      ticket_files:
        meta_ref: "documents/work/tickets/TCK-00089.yaml#ticket_meta"
        body_path: "documents/work/tickets/TCK-00089.md"
      scope:
        in_scope:
        - "End-to-end test: webhook -> event -> transition -> handoff"
        - "Test anti-gaming controls"
        - "Test idempotency of webhook handling"
        - "Test error cases (invalid signature, failed CI)"
        - "Test feature flag behavior"
        out_of_scope:
        - "Performance testing"
        - "Load testing"
      binds:
        requirement_ids:
        - HANDOFF-001
        - HANDOFF-002
        - HANDOFF-003
        - HANDOFF-004
        - HANDOFF-005
        evidence_ids:
        - EVID-8005
      custody_agent_roles:
      - AGENT_IMPLEMENTER
      responsibility_domains:
      - DOMAIN_RUNTIME
      - DOMAIN_SECURITY
      dependencies:
      - TCK-00088
      definition_of_done:
        criteria:
        - "E2E test passes: full handoff flow"
        - "Anti-gaming test: agents cannot set CI status"
        - "Idempotency test: duplicate webhooks handled"
        - "Error tests: invalid cases rejected appropriately"
        - "All tests pass in CI"
        evidence_ids:
        - EVID-8005

  dependency_graph: |
    Phase 0 (Infrastructure):
    +-------------+
    |  TCK-00085  |  GitHub webhook handler
    | webhook     |
    +------+------+
           |
           v (dependency)
    Phase 1 (Events):
    +-------------+
    |  TCK-00086  |  CIWorkflowCompleted event
    | ledger      |
    +------+------+
           |
           v (dependency)
    Phase 2 (Queue):
    +-------------+
    |  TCK-00087  |  CI-gated task queue
    | task queue  |
    +------+------+
           |
           v (dependency)
    Phase 3 (Protocol):
    +-------------+
    |  TCK-00088  |  Agent exit protocol
    | exit signal |
    +------+------+
           |
           v (dependency)
    Phase 4 (Testing):
    +-------------+
    |  TCK-00089  |  Integration tests
    | e2e tests   |
    +-------------+

    All phases are sequential. Each phase builds on the previous.
    Feature flags allow individual phases to be disabled.

  requirement_coverage:
    notes: |
      All RFC-0008 requirements are covered by tickets:
      - HANDOFF-001: TCK-00085 (webhook handler)
      - HANDOFF-002: TCK-00086 (ledger event)
      - HANDOFF-003: TCK-00087 (task queue)
      - HANDOFF-004: TCK-00088 (exit protocol)
      - HANDOFF-005: TCK-00085, TCK-00089 (anti-gaming)
    uncovered_requirements: []

  notes: |
    The implementation is structured in sequential phases to allow incremental
    validation. Each phase can be feature-flagged independently for rollback.

    Phase 0 (TCK-00085) establishes the webhook infrastructure with security
    controls. This is the foundation for all subsequent work.

    Phase 1 (TCK-00086) adds ledger event emission, creating an audit trail
    of CI completions without yet affecting workflow.

    Phase 2 (TCK-00087) integrates with the task queue, enabling CI-gated
    work items and automatic phase transitions.

    Phase 3 (TCK-00088) implements the agent exit protocol, enabling clean
    handoffs between agent sessions.

    Phase 4 (TCK-00089) provides comprehensive integration tests to verify
    the entire flow works correctly and securely.

rfc_test_and_evidence:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"

  test_strategy:
    approach: |
      Multi-layered testing strategy:
      - Unit tests for signature validation, event parsing, state transitions
      - Integration tests for webhook -> event -> queue flow
      - Security tests for anti-gaming controls
      - End-to-end tests simulating full agent handoff

    unit_tests:
      - id: UT-008-001
        description: "HMAC-SHA256 signature validation"
        file: "crates/apm2-core/src/webhook/signature.rs"
        test_function: "test_signature_validation"
        deterministic: true
        test_cases:
          - name: "valid_signature"
            input:
              payload: '{"action":"completed"}'
              secret: "test_secret"
              signature: "sha256=<computed>"
            expected: "Ok(true)"
          - name: "invalid_signature"
            input:
              payload: '{"action":"completed"}'
              secret: "test_secret"
              signature: "sha256=invalid"
            expected: "Ok(false)"
          - name: "missing_prefix"
            input:
              signature: "abc123"
            expected: "Err(InvalidFormat)"
          - name: "wrong_algorithm"
            input:
              signature: "sha1=abc123"
            expected: "Err(UnsupportedAlgorithm)"
        pass_criteria: |
          All signature validation cases handled correctly.
          Run: cargo test -p apm2-core test_signature_validation

      - id: UT-008-002
        description: "CIWorkflowCompleted event parsing"
        file: "crates/apm2-core/src/events/ci.rs"
        test_function: "test_ci_event_parsing"
        deterministic: true
        test_cases:
          - name: "success_workflow"
            input: |
              {"action":"completed","workflow_run":{"id":123,
              "head_sha":"abc123","conclusion":"success",
              "pull_requests":[{"number":42}]}}
            expected:
              pr_number: 42
              commit_sha: "abc123"
              conclusion: "success"
          - name: "failure_workflow"
            input: |
              {"action":"completed","workflow_run":{"conclusion":"failure",...}}
            expected:
              conclusion: "failure"
          - name: "no_pull_request"
            input: |
              {"action":"completed","workflow_run":{"pull_requests":[],...}}
            expected: "Err(NoPullRequest)"
          - name: "not_completed_action"
            input: |
              {"action":"requested",...}
            expected: "Err(NotCompletedAction)"
        pass_criteria: |
          All payload variations parsed correctly.
          Run: cargo test -p apm2-core test_ci_event_parsing

      - id: UT-008-003
        description: "Work item phase transitions"
        file: "crates/apm2-core/src/work/phase.rs"
        test_function: "test_phase_transitions"
        deterministic: true
        test_cases:
          - name: "ci_pending_to_ready_on_success"
            input:
              current_phase: "CI_PENDING"
              event: "CIWorkflowCompleted(success)"
            expected: "READY_FOR_REVIEW"
          - name: "ci_pending_to_blocked_on_failure"
            input:
              current_phase: "CI_PENDING"
              event: "CIWorkflowCompleted(failure)"
            expected: "BLOCKED"
          - name: "cannot_transition_non_ci_pending"
            input:
              current_phase: "IMPLEMENTATION"
              event: "CIWorkflowCompleted(success)"
            expected: "Err(InvalidTransition)"
          - name: "ci_cancelled_stays_pending"
            input:
              current_phase: "CI_PENDING"
              event: "CIWorkflowCompleted(cancelled)"
            expected: "CI_PENDING"
        pass_criteria: |
          Phase transitions follow state machine rules.
          Run: cargo test -p apm2-core test_phase_transitions

      - id: UT-008-004
        description: "Agent exit signal parsing"
        file: "crates/apm2-core/src/agent/exit.rs"
        test_function: "test_exit_signal_parsing"
        deterministic: true
        test_cases:
          - name: "valid_exit_signal"
            input: |
              {"protocol":"apm2_agent_exit","version":"1.0.0",
              "phase_completed":"IMPLEMENTATION","exit_reason":"completed"}
            expected: "Ok(ExitSignal)"
          - name: "wrong_protocol"
            input: |
              {"protocol":"other","version":"1.0.0",...}
            expected: "Err(UnknownProtocol)"
          - name: "missing_required_field"
            input: |
              {"protocol":"apm2_agent_exit"}
            expected: "Err(MissingField)"
        pass_criteria: |
          Exit signals validated according to schema.
          Run: cargo test -p apm2-core test_exit_signal_parsing

      - id: UT-008-005
        description: "Idempotency via delivery_id"
        file: "crates/apm2-core/src/webhook/handler.rs"
        test_function: "test_delivery_id_idempotency"
        deterministic: true
        test_cases:
          - name: "first_delivery_processed"
            input:
              delivery_id: "uuid-1"
              seen_ids: []
            expected: "Processed"
          - name: "duplicate_delivery_skipped"
            input:
              delivery_id: "uuid-1"
              seen_ids: ["uuid-1"]
            expected: "Skipped(AlreadySeen)"
        pass_criteria: |
          Duplicate deliveries are handled idempotently.
          Run: cargo test -p apm2-core test_delivery_id_idempotency

    integration_tests:
      - id: IT-008-001
        description: "Webhook to ledger event flow"
        deterministic: true
        setup: |
          1. Start webhook handler with test secret
          2. Prepare valid workflow_run.completed payload
          3. Compute HMAC-SHA256 signature
        execution: |
          POST /webhooks/github with signed payload
        validation:
          response_code: 202
          ledger_contains: "CIWorkflowCompleted event with matching data"
        pass_criteria: |
          Valid webhook results in ledger event.

      - id: IT-008-002
        description: "Ledger event to phase transition flow"
        deterministic: true
        setup: |
          1. Create work item in CI_PENDING phase
          2. Emit CIWorkflowCompleted event for work item's PR
        execution: |
          Process ledger event through task queue
        validation:
          work_item_phase: "READY_FOR_REVIEW"
          transition_logged: true
        pass_criteria: |
          CI completion transitions work to next phase.

      - id: IT-008-003
        description: "Anti-gaming: reject direct CI status update"
        deterministic: true
        setup: |
          1. Create work item in CI_PENDING phase
        execution: |
          Attempt to call any API endpoint to set CI status directly
          (simulate agent trying to game the system)
        validation:
          response_code: 403
          work_item_phase: "CI_PENDING (unchanged)"
          audit_log_contains: "Unauthorized CI status update attempt"
        pass_criteria: |
          Agents cannot bypass CI gate.

      - id: IT-008-004
        description: "End-to-end handoff flow"
        deterministic: true
        setup: |
          1. Create work item in IMPLEMENTATION phase
          2. Simulate agent completing work
        execution: |
          1. Agent emits exit signal (IMPLEMENTATION complete)
          2. Work transitions to CI_PENDING
          3. Receive CIWorkflowCompleted webhook (success)
          4. Work transitions to READY_FOR_REVIEW
          5. New agent claims work
        validation:
          final_phase: "READY_FOR_REVIEW or REVIEW (if claimed)"
          events_emitted:
            - "AgentSessionCompleted"
            - "CIWorkflowCompleted"
            - "WorkReadyForNextPhase"
          no_polling_in_transcript: true
        pass_criteria: |
          Full handoff flow works without polling.

    manual_verification:
      - id: MV-008-001
        description: "Verify GitHub can deliver webhooks"
        prerequisites:
          - "TCK-00085 completed"
          - "Webhook endpoint deployed"
          - "GitHub webhook configured"
        steps:
          - "Create a PR in the repository"
          - "Push a commit to trigger CI"
          - "Wait for CI to complete"
          - "Check webhook delivery in GitHub settings"
        pass_criteria:
          github_shows: "200 or 202 response for webhook delivery"

      - id: MV-008-002
        description: "Verify no polling in agent transcripts"
        prerequisites:
          - "TCK-00088 completed"
          - "Agent configured to use exit protocol"
        steps:
          - "Have agent work on a PR"
          - "Agent creates PR and exits"
          - "Review agent transcript"
        pass_criteria:
          transcript_must_not_contain:
            - "gh pr checks"
            - "Waiting for CI"
            - "Checking CI status"

  evidence_requirements:
    - id: EVID-8001
      description: "Webhook handler with signature validation"
      artifact_type: "test_output"
      verification:
        automated: "UT-008-001 and IT-008-001 pass"
      location: "evidence/RFC-0008/EVID-8001_webhook_handler.log"

    - id: EVID-8002
      description: "CIWorkflowCompleted event emission"
      artifact_type: "test_output"
      verification:
        automated: "UT-008-002 and IT-008-001 pass"
      location: "evidence/RFC-0008/EVID-8002_ci_events.log"

    - id: EVID-8003
      description: "Task queue CI-gated transitions"
      artifact_type: "test_output"
      verification:
        automated: "UT-008-003 and IT-008-002 pass"
      location: "evidence/RFC-0008/EVID-8003_task_queue.log"

    - id: EVID-8004
      description: "Agent exit protocol implementation"
      artifact_type: "test_output"
      verification:
        automated: "UT-008-004 passes"
        manual: "MV-008-002 passes"
      location: "evidence/RFC-0008/EVID-8004_exit_protocol.log"

    - id: EVID-8005
      description: "Anti-gaming controls verified"
      artifact_type: "test_output"
      verification:
        automated: "IT-008-003 and IT-008-004 pass"
      location: "evidence/RFC-0008/EVID-8005_anti_gaming.log"

rfc_rollout_and_ops:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"

  rollout_plan:
    strategy: "Phased implementation with feature flags"
    rationale: |
      Event-driven agent handoff is a significant infrastructure change. Phased
      rollout allows validation at each stage before proceeding.

    phases:
      - phase: 0
        name: "Webhook Infrastructure"
        description: |
          Implement GitHub webhook handler with signature validation. Does not
          yet emit ledger events or affect task queue.
        tickets:
          - "TCK-00085: Implement GitHub webhook handler"
        parallelism: "Single ticket"
        success_criteria:
          - "Webhook endpoint accepts POST requests"
          - "Signature validation works correctly"
          - "Invalid requests rejected with appropriate status"
          - "Endpoint is reachable from GitHub"
        feature_flag: "WEBHOOK_HANDLER_ENABLED"

      - phase: 1
        name: "Ledger Event Emission"
        description: |
          Define CIWorkflowCompleted event schema and emit events from webhook
          handler. Events are logged but do not yet affect task queue.
        tickets:
          - "TCK-00086: Define CIWorkflowCompleted ledger event schema"
        parallelism: "Single ticket"
        success_criteria:
          - "Event schema defined and validated"
          - "Webhook handler emits events"
          - "Events are persisted to ledger"
          - "Idempotency prevents duplicate events"
        feature_flag: "CI_EVENTS_ENABLED"

      - phase: 2
        name: "Task Queue Integration"
        description: |
          Integrate ledger events with task queue to transition work items
          through CI-gated phases.
        tickets:
          - "TCK-00087: Implement task queue for CI-gated work items"
        parallelism: "Single ticket"
        dependencies:
          - "Phase 1 must be complete"
        success_criteria:
          - "Work items can be in CI_PENDING phase"
          - "CIWorkflowCompleted transitions work appropriately"
          - "Agents can claim post-CI work"
          - "Failed CI blocks work correctly"
        feature_flag: "CI_GATED_QUEUE_ENABLED"

      - phase: 3
        name: "Agent Exit Protocol"
        description: |
          Implement and enforce agent exit protocol for clean handoffs.
        tickets:
          - "TCK-00088: Define agent exit protocol and session cleanup"
        parallelism: "Single ticket"
        dependencies:
          - "Phase 2 must be complete"
        success_criteria:
          - "Agent exit signal schema defined"
          - "Agents emit structured exit signals"
          - "Session cleanup occurs on exit"
          - "No polling observed after PR creation"
        feature_flag: "AGENT_EXIT_PROTOCOL_ENABLED"

      - phase: 4
        name: "Integration Testing"
        description: |
          End-to-end integration tests verifying full handoff flow.
        tickets:
          - "TCK-00089: Add agent handoff integration tests"
        parallelism: "Single ticket"
        dependencies:
          - "Phase 3 must be complete"
        success_criteria:
          - "E2E test: agent -> PR -> CI -> handoff -> new agent"
          - "Anti-gaming controls verified"
          - "Audit trail complete"

  operational_considerations:
    monitoring:
      - metric: "webhook_requests_total"
        type: "counter"
        labels: ["status", "event_type"]
        purpose: "Track webhook volume and success rate"
      - metric: "webhook_signature_failures_total"
        type: "counter"
        purpose: "Detect potential attacks or misconfig"
      - metric: "ci_events_emitted_total"
        type: "counter"
        labels: ["conclusion"]
        purpose: "Track CI completion events by result"
      - metric: "work_phase_transitions_total"
        type: "counter"
        labels: ["from_phase", "to_phase"]
        purpose: "Track work item lifecycle"
      - metric: "agent_handoff_latency_seconds"
        type: "histogram"
        purpose: "Time from CI completion to agent claiming work"

    alerts:
      - name: "webhook_signature_failures_high"
        condition: "rate(webhook_signature_failures_total[5m]) > 5"
        severity: "warning"
        action: "Check for secret mismatch or attack"
      - name: "webhook_endpoint_down"
        condition: "up{job='webhook_handler'} == 0"
        severity: "critical"
        action: "Investigate endpoint health, check logs"
      - name: "ci_events_not_emitting"
        condition: "increase(ci_events_emitted_total[1h]) == 0"
        severity: "warning"
        action: "Check webhook delivery in GitHub, verify handler"

    rollback:
      strategy: "Feature flags allow per-phase rollback"
      notes: |
        Each phase has a feature flag. Disabling the flag reverts to previous
        behavior without code deployment:
        - WEBHOOK_HANDLER_ENABLED: Reject all webhooks
        - CI_EVENTS_ENABLED: Accept webhooks but don't emit events
        - CI_GATED_QUEUE_ENABLED: Emit events but don't transition work
        - AGENT_EXIT_PROTOCOL_ENABLED: Don't validate agent exit signals

    dependencies:
      - name: "GitHub webhook secret"
        type: "secret"
        notes: "Must be configured in GitHub and webhook handler"
      - name: "HTTPS endpoint"
        type: "infrastructure"
        notes: "Webhook handler must be reachable over HTTPS"
      - name: "Ledger storage"
        type: "service"
        notes: "Events must be persisted"

    verification_after_rollout:
      commands:
        - description: "Verify webhook endpoint health"
          command: "curl -X POST https://webhook.example.com/webhooks/github -d '{}'"
          expected: "401 (no signature)"
        - description: "Verify GitHub can deliver webhooks"
          command: "gh api repos/{owner}/{repo}/hooks --jq '.[].last_response.code'"
          expected: "200 or 202"
        - description: "Verify events in ledger"
          command: "cargo xtask ledger query --type CIWorkflowCompleted --limit 5"
        - description: "Verify work phase transitions"
          command: "cargo xtask work list --phase CI_PENDING"

rfc_trust_boundaries:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"

  trust_model:
    description: |
      This RFC introduces trust boundaries around CI event handling and agent
      handoff. The key security property is that CI status can only be set by
      authenticated GitHub webhooks, not by agents directly.

    boundaries:
      - id: TB-008-001
        name: "GitHub Webhook Origin"
        description: "Incoming webhooks from GitHub's servers"
        trust_level: CONDITIONAL
        entities:
          - "GitHub webhook delivery service"
          - "X-Hub-Signature-256 header"
        security_properties:
          - "Trust only if HMAC-SHA256 signature validates"
          - "Shared secret known only to GitHub and our handler"
          - "Payload integrity verified by signature"
        notes: |
          GitHub webhooks are trusted only after signature validation. The
          shared secret must be stored securely (env var or secrets manager).

      - id: TB-008-002
        name: "Webhook Handler Endpoint"
        description: "Internet-accessible HTTP endpoint receiving webhooks"
        trust_level: EXPOSED
        entities:
          - "POST /webhooks/github endpoint"
          - "axum HTTP server"
        security_properties:
          - "HTTPS only (TLS termination)"
          - "Rate limiting to prevent abuse"
          - "Signature validation before processing"
          - "No sensitive data in error responses"
        notes: |
          This endpoint is exposed to the internet. All requests must be
          validated before any state changes occur.

      - id: TB-008-003
        name: "Internal Ledger Events"
        description: "CIWorkflowCompleted events emitted to ledger"
        trust_level: HIGH
        entities:
          - "CIWorkflowCompleted ledger event"
          - "Ledger storage"
        security_properties:
          - "Events only created by webhook handler"
          - "Immutable once written"
          - "Include signature validation proof"
        notes: |
          Ledger events are trusted because they can only be created by the
          webhook handler after signature validation.

      - id: TB-008-004
        name: "Task Queue State Machine"
        description: "Work item phase transitions"
        trust_level: HIGH
        entities:
          - "Task queue service"
          - "Work item state"
          - "Phase transition rules"
        security_properties:
          - "CI_PENDING to next phase requires CIWorkflowCompleted event"
          - "Agents cannot directly transition CI-gated phases"
          - "All transitions logged"

      - id: TB-008-005
        name: "Agent Sessions"
        description: "Coding agent session boundaries"
        trust_level: RESTRICTED
        entities:
          - "Claude Code sessions"
          - "Gemini CLI sessions"
          - "Agent output/exit signals"
        security_properties:
          - "Agents cannot set CI status directly"
          - "Agent exit signals are validated"
          - "Session isolation between agents"
        notes: |
          Agents are trusted to perform coding work but NOT to set CI status.
          This is the key anti-gaming control.

  data_flows:
    - flow_id: DF-008-001
      description: "GitHub webhook to handler"
      from: "GitHub (TB-008-001)"
      to: "Webhook Handler (TB-008-002)"
      data: "workflow_run.completed payload"
      sensitivity: MEDIUM
      security_controls:
        - "HMAC-SHA256 signature validation"
        - "HTTPS transport"
        - "Rate limiting"

    - flow_id: DF-008-002
      description: "Handler to ledger"
      from: "Webhook Handler (TB-008-002)"
      to: "Ledger (TB-008-003)"
      data: "CIWorkflowCompleted event"
      sensitivity: MEDIUM
      security_controls:
        - "Only handler can emit this event"
        - "Event includes validation proof"

    - flow_id: DF-008-003
      description: "Ledger event to task queue"
      from: "Ledger (TB-008-003)"
      to: "Task Queue (TB-008-004)"
      data: "CI completion notification"
      sensitivity: LOW
      security_controls:
        - "Event subscription is internal"
        - "Task queue validates event source"

    - flow_id: DF-008-004
      description: "Agent exit signal to task queue"
      from: "Agent Session (TB-008-005)"
      to: "Task Queue (TB-008-004)"
      data: "Phase completion signal"
      sensitivity: LOW
      security_controls:
        - "Signal validated for schema"
        - "Cannot transition CI-gated phases"

  security_considerations: |
    Primary security concern: Preventing agents from gaming CI status.

    The design ensures:
    1. CI status can ONLY be updated via authenticated GitHub webhooks
    2. Webhook signature validation uses HMAC-SHA256 with shared secret
    3. Agents have no API endpoint to set CI status
    4. All CI status changes are logged with signature proof
    5. Task queue phase transitions are controlled by event source

    The shared webhook secret MUST be:
    - Stored securely (environment variable or secrets manager)
    - Rotated periodically
    - Never exposed to agents or logs
    - Used only for webhook validation

    Failure modes:
    - Secret compromise: Attacker could fake CI completion events
      Mitigation: Secret rotation, audit logs, anomaly detection
    - Webhook endpoint downtime: CI events missed
      Mitigation: GitHub retries, dead letter queue
    - Replay attacks: Same webhook delivered twice
      Mitigation: Idempotency via delivery ID tracking

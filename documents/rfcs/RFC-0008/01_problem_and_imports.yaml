rfc_problem_and_imports:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"

  problem_statement:
    summary: "Coding agents waste tokens and context window by polling CI status"
    context: |
      Coding agents (Claude, Gemini, etc.) working on PRs face a fundamental problem
      with CI integration:

      1. **Context Window Pollution**: Agents poll CI status by running `gh pr checks`
         or similar commands repeatedly. Each poll fills the context window with
         redundant status output, reducing effective context for actual work.

      2. **Token Waste**: Every poll consumes tokens for both the command execution
         and the agent's analysis of the output. A typical PR might be polled
         dozens of times while waiting for CI.

      3. **No Event-Driven Trigger**: There's no mechanism to notify agents when
         CI completes. Agents must actively poll because they have no way to
         "sleep" and be awakened by an event.

      4. **Gaming the System**: Frustrated agents have been observed "gaming" the
         system by manually marking CI as passed or ignoring CI failures. This
         undermines the quality gate that CI provides.

      5. **Stale Context**: By the time CI completes (often 5-15 minutes), the
         agent's context is full of poll results and the agent may have
         forgotten relevant details about the implementation.

      The fundamental issue is a mismatch between the event-driven nature of CI
      (completes asynchronously) and the polling-based approach agents use.

    observed_symptoms:
      - symptom_id: SYMP-008-001
        description: |
          Agent context windows fill up with repeated `gh pr checks` output
          showing the same CI status multiple times.
        evidence: "Observed in agent transcripts"

      - symptom_id: SYMP-008-002
        description: |
          Agents attempt to mark CI checks as passed manually via `gh pr` commands
          or by editing status directly.
        evidence: "Observed in agent transcripts - gaming behavior"

      - symptom_id: SYMP-008-003
        description: |
          Fresh work after CI completion starts with stale context or requires
          full re-read of the codebase, wasting tokens.
        evidence: "Agent handoff requires re-reading files already read by previous agent"

      - symptom_id: SYMP-008-004
        description: |
          No clear handoff protocol between agent sessions - work state is lost
          or must be reconstructed from PR description.
        evidence: "Manual intervention required to continue work after CI passes"

    goals:
      - "Eliminate polling for CI status by agents"
      - "Provide event-driven notification when CI completes"
      - "Enable fresh agent context for post-CI work phases"
      - "Prevent agents from gaming CI status"
      - "Maintain audit trail of CI completion and agent handoffs"
      - "Integrate with PRD-0004 Work Substrate task queue and leasing"

    non_goals:
      - "Modify GitHub Actions workflow definitions"
      - "Implement CI caching strategies"
      - "Change how agents write code or create PRs"
      - "Replace GitHub's native CI status reporting"

  implementation_note: |
    The solution introduces a webhook-based event system:
    1. GitHub sends `workflow_run.completed` webhook to our endpoint
    2. Webhook handler validates signature and emits internal ledger event
    3. Task queue receives event and marks work as ready for next phase
    4. Fresh agent claims work from queue (lease-based from PRD-0004)
    5. Agent starts with clean context, reads evidence bundle for state

  technical_context:
    github_webhooks:
      description: |
        GitHub can send webhooks for various repository events. The
        `workflow_run.completed` event fires when a GitHub Actions workflow
        finishes (success, failure, or cancelled).
      webhook_payload: |
        {
          "action": "completed",
          "workflow_run": {
            "id": 12345,
            "head_sha": "abc123",
            "head_branch": "feature/foo",
            "conclusion": "success" | "failure" | "cancelled",
            "pull_requests": [{"number": 42}]
          }
        }
      signature_header: "X-Hub-Signature-256"
      signature_format: "sha256=<HMAC-SHA256 hex digest>"

    agent_handoff_model:
      description: |
        The agent handoff model ensures clean transitions between agent sessions:
        1. Agent1 completes implementation phase, creates PR, exits
        2. CI runs independently (no agent polling)
        3. Webhook receives CI completion, emits ledger event
        4. Task queue marks work as ready for next phase
        5. Agent2 (fresh context) claims work, continues from evidence bundle

    task_queue_integration:
      description: |
        Integrates with PRD-0004 Work Substrate task queue:
        - Work items have lifecycle phases (IMPLEMENTATION, CI_PENDING, REVIEW, etc.)
        - CI completion transitions work from CI_PENDING to next phase
        - Agents claim work via lease mechanism (prevents double-processing)
        - Evidence bundles carry state between agent sessions

  imports:
    prd_requirements:
      - requirement_id: "REQ-WS-001"
        source: "documents/prds/PRD-0004/02_requirements.yaml#requirement_registry.requirements[0]"
        title: "Lease-based work claiming"
        import_note: "Task queue uses leases from PRD-0004"
      - requirement_id: "REQ-WS-002"
        source: "documents/prds/PRD-0004/02_requirements.yaml#requirement_registry.requirements[1]"
        title: "Evidence bundle portability"
        import_note: "Evidence bundles carry state between agents"

  rfc_local_requirements:
    rationale: |
      These requirements are specific to event-driven agent handoff. They complement
      the Work Substrate (PRD-0004) by providing the CI integration layer.

    requirements:
      - id: HANDOFF-001
        type: FUNCTIONAL
        title: "GitHub webhook handler for workflow_run events"
        statement: |
          The system MUST implement a webhook endpoint that receives GitHub
          `workflow_run.completed` events and validates their HMAC signature.
        acceptance_criteria:
          - "Webhook endpoint accepts POST requests"
          - "X-Hub-Signature-256 header is validated against secret"
          - "Invalid signatures are rejected with 401"
          - "Valid payloads are parsed and processed"
        verification:
          method: "Integration test with mocked GitHub webhook"
          pass_condition: "Valid webhook processed, invalid rejected"

      - id: HANDOFF-002
        type: FUNCTIONAL
        title: "CIWorkflowCompleted ledger event"
        statement: |
          The system MUST emit a CIWorkflowCompleted ledger event when a valid
          workflow_run.completed webhook is received.
        acceptance_criteria:
          - "Event contains pr_number, commit_sha, conclusion"
          - "Event contains list of check results"
          - "Event is persisted to ledger"
          - "Event is idempotent (same webhook twice produces one event)"
        verification:
          method: "Unit test ledger event emission"
          pass_condition: "Event schema validated, idempotency verified"

      - id: HANDOFF-003
        type: FUNCTIONAL
        title: "Task queue CI-gated work items"
        statement: |
          The task queue MUST support CI-gated work items that become available
          only after CI passes.
        acceptance_criteria:
          - "Work items can be in CI_PENDING phase"
          - "CIWorkflowCompleted event transitions work to next phase"
          - "Failed CI keeps work in CI_PENDING (or moves to BLOCKED)"
          - "Agents cannot claim CI_PENDING work"
        verification:
          method: "Integration test task queue state machine"
          pass_condition: "Phase transitions correct based on CI result"

      - id: HANDOFF-004
        type: FUNCTIONAL
        title: "Agent exit protocol"
        statement: |
          Agents MUST use structured exit protocol after creating PR, signaling
          completion without polling.
        acceptance_criteria:
          - "Agent outputs structured completion signal"
          - "No polling commands after PR creation"
          - "Session terminates cleanly"
          - "Work item state reflects agent exit"
        verification:
          method: "Transcript analysis of agent session"
          pass_condition: "No polling observed, clean exit signal present"

      - id: HANDOFF-005
        type: SECURITY
        title: "Anti-gaming controls for CI status"
        statement: |
          The system MUST prevent agents from directly setting CI status;
          only GitHub webhooks with valid signatures can update CI state.
        acceptance_criteria:
          - "No API endpoint allows agents to set CI status"
          - "CI status changes require valid HMAC signature"
          - "Audit trail records all CI status updates with source"
          - "Attempts to game CI are logged and rejected"
        verification:
          method: "Security review and penetration test"
          pass_condition: "No bypass found, all updates authenticated"

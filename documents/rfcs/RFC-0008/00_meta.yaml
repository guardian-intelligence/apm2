rfc_meta:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"
  rfc:
    id: RFC-0008
    title: "Event-Driven Agent Handoff After CI Completion"
    status: DRAFT
    created_date: "2026-01-25"
    last_updated_date: "2026-01-25"
  binds_to_prd:
    prd_id: PRD-0004
    prd_base_path: "documents/prds/PRD-0004"
    requirement_registry_ref: "documents/prds/PRD-0004/02_requirements.yaml#requirement_registry"
    evidence_bundle_ref: "documents/prds/PRD-0004/04_evidence.yaml#evidence_bundle"
    prd_meta_ref: "documents/prds/PRD-0004/00_meta.yaml#prd_meta"
    rationale: |
      This RFC implements event-driven agent handoff as part of the Work Substrate
      (PRD-0004). It addresses the polling problem where agents waste context window
      by repeatedly checking CI status, and provides a mechanism for fresh agents
      to pick up work after CI completion.
  protocol_profile:
    id: NONE
    applies: false
    inherited_from_prd: true
    profile_ref: ""
  custody:
    producing_agent_roles:
    - AGENT_AUTHOR
    - AGENT_ARCHITECT
    responsible_domains:
    - DOMAIN_RUNTIME
    - DOMAIN_BUILD_RELEASE
    - DOMAIN_SECURITY
    authority_signoffs_required:
    - AUTH_ARCHITECTURE
    - AUTH_SECURITY
  refs:
    standards:
      requirement_schema: "documents/standards/schemas/02_requirement.schema.yaml#requirement_schema"
      evidence_artifact_schema: "documents/standards/schemas/01_evidence_artifact.schema.yaml#evidence_artifact_schema"
      quality_coverage_schema: "documents/standards/schemas/03_quality_coverage.schema.yaml#quality_coverage_schema"
      gate_review_schema: "documents/standards/schemas/06_gate_review.schema.yaml#gate_review_schema"
      waiver_schema: "documents/standards/schemas/05_waiver.schema.yaml#waiver_schema"
      ticket_meta_schema: "documents/standards/schemas/04_ticket_meta.schema.yaml#ticket_meta_schema"
      lint_spec: "documents/standards/lint/LINT_SPEC.yaml#lint_spec"
  implementation:
    language: Rust
    edition: "2021"
    crate_name: "apm2-core"
    implementation_approach: |
      This RFC introduces event-driven agent handoff to eliminate polling and enable
      fresh agent context after CI completion. Key components:

      1. GitHub Webhook Handler: Receives `workflow_run.completed` events, validates
         HMAC signature, extracts PR/commit info, and emits internal ledger events.

      2. Task Queue Interface: Work items enter queue when CI passes, agents claim
         work using lease-based model from PRD-0004.

      3. Agent Exit Protocol: Structured output signals completion, clean session
         termination without polling.

      4. Anti-Gaming Controls: CI status can only be set by GitHub webhook, not
         by agents directly. Evidence of CI completion required before handoff.

    key_dependencies:
    - name: hmac
      version: "0.12.x"
      purpose: "HMAC-SHA256 signature verification for GitHub webhooks"
      already_in_xtask: false
    - name: sha2
      version: "0.10.x"
      purpose: "SHA256 hashing for webhook signature verification"
      already_in_xtask: false
    - name: axum
      version: "0.7.x"
      purpose: "HTTP server for webhook endpoint"
      already_in_xtask: false
    - name: tokio
      version: "1.x"
      purpose: "Async runtime for webhook server"
      already_in_xtask: true

evidence_artifact:
  schema_version: "2026-02-07"
  id: "EVID-0017"
  title: "ReceiptPointerV1 and ReceiptMultiProofV1 conformance evidence"
  category: "UNIT_TEST_RESULT"
  status: "PARTIAL"
  description: |
    Evidence that REQ-0017 acceptance criteria are met by the
    ReceiptPointerV1 and ReceiptMultiProofV1 implementation in the daemon
    identity module. The implementation supports direct-signature and
    batch/Merkle authentication paths with equivalent acceptance semantics.

    Implementation status (scope-narrowed): partial. Independent per-receipt
    inclusion proofs are implemented for multiproof verification. The compact
    shared-sibling wire shape from RFC-0020 §9.5.5 (`proof_nodes[]` +
    `proof_structure`) is deferred to TCK-00370.

    ReceiptPointerV1 construction: direct pointers require non-zero
    receipt_hash and authority_seal_hash. Batch pointers additionally
    require a valid MerkleInclusionProof whose leaf_hash matches the
    domain-separated receipt hash. Excessive proof depth is rejected at
    construction time.

    PointerKind fail-closed parsing: unknown pointer kind tags are rejected
    via from_tag returning None. Only Direct (0x01), Batch (0x02), and
    FactRoot (0x03) are admitted. FactRoot is defined but deferred to
    TCK-00370.

    Direct verification: the ReceiptPointerVerifier validates that a
    direct pointer's receipt hash matches the seal's subject_hash and
    verifies the seal signature. Wrong keys and wrong receipt hashes are
    rejected.

    Batch verification: the ReceiptPointerVerifier validates that a
    batch pointer's inclusion proof verifies against the seal's
    subject_hash (batch root) and that the seal signature is valid.
    Non-member receipt hashes are rejected.

    Acceptance equivalence: tests demonstrate that direct and batch
    verification paths produce VerificationResult values with identical
    receipt_hash fields, confirming behavioral acceptance equivalence
    between the two authentication paths.

    ReceiptMultiProofV1 construction (partial wire shape): multiproofs require
    non-empty, canonically sorted, deduplicated receipt hashes with matching
    proof count. Each individual proof must verify against the batch root at
    construction time. Zero authority_seal_hash is rejected.

    Multiproof verification (independent proofs): the verifier validates the
    seal signature once (O(1) signature checks) and independently re-verifies
    every inclusion proof at verification time for all K receipts, achieving
    O(1) signature + O(K log B) hashing verification cost per RFC-0020 §9.5.3.

    Canonical bytes: both ReceiptPointerV1 and ReceiptMultiProofV1
    produce deterministic canonical byte representations suitable for
    content-addressing. Direct and batch canonical bytes are distinct.

    Focused receipt-pointer test inventory: at least 57 tests (currently
    60 after boundary-regression additions; updated from the earlier
    35-test baseline).
  requirement_ids:
    - "REQ-0017"
  source_refs:
    - "documents/rfcs/RFC-0020/requirements/REQ-0017.yaml"
    - "crates/apm2-daemon/src/identity/receipt_pointer.rs"
    - "crates/apm2-daemon/src/identity/mod.rs"
  artifacts:
    - type: "test_output"
      description: |
        PointerKind tag parsing and fail-closed unknown rejection:
        - pointer_kind_round_trip: all three tags round-trip correctly
        - pointer_kind_rejects_unknown: 0x00, 0x04, 0xFF all rejected
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::pointer_kind_round_trip"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::pointer_kind_rejects_unknown"
    - type: "test_output"
      description: |
        ReceiptPointerV1 construction validation — direct path:
        - direct_pointer_rejects_zero_receipt_hash: zero receipt hash rejected
        - direct_pointer_rejects_zero_seal_hash: zero seal hash rejected
        - direct_pointer_accepts_valid: valid direct pointer accepted
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::direct_pointer_rejects_zero_receipt_hash"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::direct_pointer_rejects_zero_seal_hash"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::direct_pointer_accepts_valid"
    - type: "test_output"
      description: |
        ReceiptPointerV1 construction validation — batch path:
        - batch_pointer_rejects_zero_receipt_hash: zero receipt hash rejected
        - batch_pointer_rejects_zero_seal_hash: zero seal hash rejected
        - batch_pointer_rejects_wrong_leaf_hash: wrong leaf hash rejected
        - batch_pointer_rejects_excessive_proof_depth: depth > MAX rejected
        - batch_pointer_accepts_valid: valid batch pointer accepted
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::batch_pointer_rejects_zero_receipt_hash"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::batch_pointer_rejects_zero_seal_hash"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::batch_pointer_rejects_wrong_leaf_hash"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::batch_pointer_rejects_excessive_proof_depth"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::batch_pointer_accepts_valid"
    - type: "test_output"
      description: |
        Canonical bytes determinism and pointer-kind distinctness:
        - direct_pointer_canonical_bytes_deterministic
        - batch_pointer_canonical_bytes_deterministic
        - direct_and_batch_canonical_bytes_differ
        - content_hash_deterministic
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::direct_pointer_canonical_bytes_deterministic"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::batch_pointer_canonical_bytes_deterministic"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::direct_and_batch_canonical_bytes_differ"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::content_hash_deterministic"
    - type: "test_output"
      description: |
        Direct verification (SINGLE_SIG seal):
        - verify_direct_pointer_valid: correct key accepts
        - verify_direct_pointer_wrong_key: wrong key rejects
        - verify_direct_pointer_wrong_receipt_hash: wrong receipt rejects
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::verify_direct_pointer_valid"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::verify_direct_pointer_wrong_key"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::verify_direct_pointer_wrong_receipt_hash"
    - type: "test_output"
      description: |
        Batch verification (MERKLE_BATCH seal):
        - verify_batch_pointer_valid: all 4 receipts in batch verify
        - verify_batch_pointer_wrong_receipt: non-member receipt rejected
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::verify_batch_pointer_valid"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::verify_batch_pointer_wrong_receipt"
    - type: "test_output"
      description: |
        Unified verify() dispatch:
        - unified_verify_dispatches_direct: dispatches to direct path
        - unified_verify_dispatches_batch: dispatches to batch path
        - unified_verify_with_verifier_dispatches_quorum_batch: unified API
          dispatches to quorum batch verification when explicitly provided
        - unified_verify_rejects_fact_root: FactRoot returns deferred error
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::unified_verify_dispatches_direct"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::unified_verify_dispatches_batch"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::unified_verify_with_verifier_dispatches_quorum_batch"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::unified_verify_rejects_fact_root"
    - type: "test_output"
      description: |
        Behavioral acceptance equivalence (REQ-0017 criterion):
        - direct_and_batch_produce_equivalent_verification_results:
          direct and batch paths produce identical receipt_hash in
          VerificationResult, confirming acceptance equivalence
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::direct_and_batch_produce_equivalent_verification_results"
    - type: "test_output"
      description: |
        ReceiptMultiProofV1 construction validation:
        - multiproof_rejects_empty: empty receipt list rejected
        - multiproof_rejects_unsorted_leaves: unsorted rejected
        - multiproof_rejects_duplicate_leaves: duplicates rejected
        - multiproof_rejects_mismatched_proof_count: wrong count rejected
        - multiproof_rejects_zero_seal_hash: zero seal hash rejected
        - multiproof_rejects_wrong_root: wrong root rejected at construction
        - multiproof_valid_construction_and_membership: valid multiproof
          passes construction and contains_receipt checks
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::multiproof_rejects_empty"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::multiproof_rejects_unsorted_leaves"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::multiproof_rejects_duplicate_leaves"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::multiproof_rejects_mismatched_proof_count"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::multiproof_rejects_zero_seal_hash"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::multiproof_rejects_wrong_root"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::multiproof_valid_construction_and_membership"
    - type: "test_output"
      description: |
        Proof-count mismatch handling:
        - multiproof_rejects_mismatched_proof_count: constructor reports
          ProofCountMismatch for receipt/proof count mismatch
        - verify_multiproof_rejects_proof_count_mismatch_at_verification_boundary:
          verifier reports ProofCountMismatch on malformed decoded multiproof
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::multiproof_rejects_mismatched_proof_count"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::verify_multiproof_rejects_proof_count_mismatch_at_verification_boundary"
    - type: "test_output"
      description: |
        Multiproof canonical bytes and content-addressing:
        - multiproof_canonical_bytes_deterministic
        - multiproof_content_hash_deterministic
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::multiproof_canonical_bytes_deterministic"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::multiproof_content_hash_deterministic"
    - type: "test_output"
      description: |
        Multiproof verification (MERKLE_BATCH seal + multiple receipts):
        - verify_multiproof_valid: 4 receipts verified via single seal
        - verify_multiproof_wrong_key: wrong key rejects multiproof
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::verify_multiproof_valid"
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::verify_multiproof_wrong_key"
    - type: "test_output"
      description: |
        FactRoot deferred (TCK-00370):
        - fact_root_pointer_kind_exists_but_deferred: FactRoot tag parses
          but verification returns FactRootNotImplemented
      ref:
        - "cargo test -p apm2-daemon identity::receipt_pointer::tests::fact_root_pointer_kind_exists_but_deferred"
    - type: "test_output"
      description: |
        Full daemon test suite regression check.
      ref:
        - "cargo test -p apm2-daemon"

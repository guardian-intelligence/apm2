evidence_artifact:
  schema_version: "2026-01-23"
  id: "EVID-0007"
  title: "Canonical key identifier conformance evidence"
  category: "UNIT_TEST_RESULT"
  status: "PASS"
  description: |
    Evidence that PublicKeyIdV1 and KeySetIdV1 canonical identifiers enforce
    strict grammar rules per RFC-0020 section 1.7.5b and produce lossless
    binary/text round-trips. The conformance vector suite covers 77 individual
    checks across 5 valid PublicKeyIdV1 vectors, 4 valid KeySetIdV1 vectors,
    and 32 invalid input vectors testing rejection of mixed case, whitespace,
    padding, wrong prefix, truncated payloads, invalid hex characters, too-long
    inputs, percent-encoded forms, and Unicode normalization variants.

    Text forms follow the RFC-0020 canonical grammar:
    - PublicKeyIdV1: pkid:v1:ed25519:blake3:<64-lowercase-hex>
    - KeySetIdV1:    kset:v1:blake3:<64-lowercase-hex>

    KeySetIdV1 derivation uses the full KeySetDescriptorV1 including
    key_algorithm, mode, threshold_k, sorted members, and optional weights.
    Tests prove that different threshold_k or weights produce different IDs
    for the same member set.
  requirement_ids:
    - "REQ-0007"
  source_refs:
    - "crates/apm2-daemon/src/identity/mod.rs"
    - "crates/apm2-daemon/src/identity/public_key_id.rs"
    - "crates/apm2-daemon/src/identity/keyset_id.rs"
    - "crates/apm2-daemon/src/identity/conformance.rs"
    - "fuzz/fuzz_targets/public_key_id_parse.rs"
    - "fuzz/fuzz_targets/keyset_id_parse.rs"
  artifacts:
    - type: "test_output"
      description: |
        Conformance test suite verifies:
        - all_conformance_vectors_pass: 77 vector checks all PASS
        - valid_pk_vectors_are_distinct: 5 unique PublicKeyIdV1 identifiers
        - valid_ks_vectors_are_distinct: 4 unique KeySetIdV1 identifiers
        - invalid_vector_count: exactly 32 invalid input vectors
        - pk_parser_differential_valid: text/binary parsers agree on all valid PK vectors
        - ks_parser_differential_valid: text/binary parsers agree on all valid KS vectors
        - invalid_vectors_rejected: all 32 invalid inputs rejected
        - pk_binary_text_binary_round_trip: lossless round-trip for all PK vectors
        - ks_binary_text_binary_round_trip: lossless round-trip for all KS vectors
        - different_threshold_k_produces_different_keyset_ids: threshold sensitivity
        - different_weights_produces_different_keyset_ids: weight sensitivity
      ref: "cargo test -p apm2-daemon identity::conformance"
    - type: "test_output"
      description: |
        Unit tests verify individual type behaviors:
        - PublicKeyIdV1: text/binary round-trip, RFC text format validation,
          reject mixed case, reject whitespace, reject padding, reject empty,
          reject truncated, reject unknown algorithm tag, reject wrong prefix,
          reject old pk1: prefix, reject invalid hex chars, reject percent-encoding,
          reject non-ASCII Unicode, bounded text length, deterministic derivation,
          distinct IDs for distinct keys
        - KeySetIdV1: text/binary round-trip, RFC text format validation,
          member-order independence, reject mixed case, reject whitespace,
          reject padding, reject empty, reject truncated, reject unknown set tag,
          reject wrong prefix, reject old ks1: prefix, reject percent-encoding,
          reject non-ASCII Unicode, bounded text length, deterministic derivation,
          distinct IDs for distinct member sets, distinct IDs for different
          threshold_k, distinct IDs for different weights
      ref: "cargo test -p apm2-daemon identity::"
    - type: "test_output"
      description: |
        Fuzz harnesses for parser surfaces:
        - fuzz_public_key_id_parse: exercises PublicKeyIdV1::parse_text and
          from_binary with arbitrary inputs including malformed Unicode,
          overlong payloads, non-canonical encodings, percent-encoded forms
        - fuzz_keyset_id_parse: exercises KeySetIdV1::parse_text and
          from_binary with arbitrary inputs
        Corpus includes entries for valid, empty, percent-encoded, fullwidth
        Unicode, combining accents, overlong, uppercase, and old-format inputs.
      ref: "fuzz/fuzz_targets/{public_key_id_parse,keyset_id_parse}.rs"

rfc_test_and_evidence:
  schema_version: "2026-01-26"
  template_version: "2026-01-26"

  test_strategy:
    overview: |
      Testing follows a layered approach: unit tests for individual modules,
      integration tests for stage interactions, and end-to-end tests using
      PRD-0005 as the canonical test input.

    unit_tests:
      - module: determinism
        tests:
          - name: "canonicalize_yaml_sorts_keys"
            description: "Verify YAML canonicalization produces sorted keys"
          - name: "canonicalize_yaml_stable_indentation"
            description: "Verify consistent 2-space indentation"
          - name: "atomic_write_no_partial_on_interrupt"
            description: "Simulate interruption and verify no partial files"
          - name: "diff_classify_structural_vs_freetext"
            description: "Test classification of diff types"

      - module: ccp
        tests:
          - name: "component_atlas_stable_ids"
            description: "Verify component IDs are stable across runs"
          - name: "agents_md_invariant_extraction"
            description: "Test parsing of AGENTS.md invariants"
          - name: "crate_graph_deterministic"
            description: "Verify crate graph output is deterministic"
          - name: "ccp_index_hash_verification"
            description: "Verify content hashes match artifacts"

      - module: impact_map
        tests:
          - name: "requirement_mapping_complete"
            description: "All requirements mapped or classified"
          - name: "duplication_risk_detection"
            description: "Multiple extension points flagged"
          - name: "output_determinism"
            description: "Identical inputs produce identical output"

      - module: rfc_framer
        tests:
          - name: "ccp_grounding_section_present"
            description: "RFC includes grounding with CCP hash"
          - name: "path_validation_rejects_invalid"
            description: "Invalid paths fail compilation"
          - name: "template_structure_valid"
            description: "RFC sections follow schema"

      - module: ticket_emitter
        tests:
          - name: "stable_ticket_ids"
            description: "Ticket IDs are stable across runs"
          - name: "path_validation_against_ccp"
            description: "File paths validated against CCP"
          - name: "verification_commands_present"
            description: "All tickets have verification commands"

      - module: model_router
        tests:
          - name: "routing_profile_parsing"
            description: "Routing profiles parsed correctly"
          - name: "canary_comparison"
            description: "Canary mode produces diff"
          - name: "unavailable_provider_fails_closed"
            description: "Missing provider fails compilation"

      - module: run_manifest
        tests:
          - name: "manifest_fields_complete"
            description: "All required fields present"
          - name: "signature_verification"
            description: "Ed25519 signatures verify correctly"
          - name: "hash_mismatch_detection"
            description: "Verification fails on tampered artifacts"

    integration_tests:
      - name: "ccp_to_impact_map_flow"
        description: "CCP artifacts feed into impact map generation"
        verification: "Impact map references valid CCP component IDs"

      - name: "impact_map_to_rfc_flow"
        description: "Impact map feeds into RFC framing"
        verification: "RFC grounding section cites impact map"

      - name: "rfc_to_tickets_flow"
        description: "RFC decomposition produces valid tickets"
        verification: "Tickets reference RFC requirement IDs"

    end_to_end_tests:
      - name: "full_compile_prd_0005"
        description: "End-to-end compilation of PRD-0005"
        commands:
          - "cargo run --bin apm2 -- factory compile --prd PRD-0005 --dry-run"
        verification:
          - "All stages complete without error"
          - "Dry-run reports expected output paths"
          - "NDJSON events emitted for all stages"

  evidence_requirements:
    prd_evidence_refs:
      - evidence_id: EVID-0001
        title: "CLI transcript of successful compile"
        prd_ref: "documents/prds/PRD-0005/evidence_artifacts/EVID-0001.yaml"
      - evidence_id: EVID-0002
        title: "CCP index artifact with hashes"
        prd_ref: "documents/prds/PRD-0005/evidence_artifacts/EVID-0002.yaml"
      - evidence_id: EVID-0005
        title: "Lint-clean RFC output"
        prd_ref: "documents/prds/PRD-0005/evidence_artifacts/EVID-0005.yaml"
      - evidence_id: EVID-0006
        title: "Deterministic run comparison"
        prd_ref: "documents/prds/PRD-0005/evidence_artifacts/EVID-0006.yaml"
      - evidence_id: EVID-0007
        title: "Routing profile and manifest"
        prd_ref: "documents/prds/PRD-0005/evidence_artifacts/EVID-0007.yaml"
      - evidence_id: EVID-0008
        title: "Signed run manifest"
        prd_ref: "documents/prds/PRD-0005/evidence_artifacts/EVID-0008.yaml"

    acceptance_evidence:
      - test_id: AE-001
        title: "CCP build for PRD-0005"
        verification_steps:
          - "Run: apm2 factory ccp build --prd PRD-0005"
          - "Verify: CCP artifacts created in evidence/prd/PRD-0005/ccp/"
          - "Verify: ccp_index.json contains valid hashes"

      - test_id: AE-002
        title: "Impact map for PRD-0005"
        verification_steps:
          - "Run: apm2 factory impact-map build --prd PRD-0005"
          - "Verify: impact_map.yaml references CCP component IDs"
          - "Verify: All 12 requirements mapped"

      - test_id: AE-003
        title: "Full compilation dry-run"
        verification_steps:
          - "Run: apm2 factory compile --prd PRD-0005 --dry-run"
          - "Verify: All stages report intended writes"
          - "Verify: No files modified in dry-run mode"

      - test_id: AE-004
        title: "Full compilation execution"
        verification_steps:
          - "Run: apm2 factory compile --prd PRD-0005"
          - "Verify: RFC-0011 created with all 9 sections"
          - "Verify: Tickets TCK-001XX created"
          - "Verify: Run manifest signed and verifiable"

  quality_gates:
    - gate_id: QG-001
      name: "Unit test coverage"
      threshold: ">= 80% line coverage for new modules"
      verification: "cargo llvm-cov --package apm2-core"

    - gate_id: QG-002
      name: "Clippy clean"
      threshold: "Zero warnings"
      verification: "cargo clippy --all-targets -- -D warnings"

    - gate_id: QG-003
      name: "Integration test pass"
      threshold: "100% pass rate"
      verification: "cargo test --test integration"

    - gate_id: QG-004
      name: "Lint clean"
      threshold: "Zero failures"
      verification: "cargo xtask lint"

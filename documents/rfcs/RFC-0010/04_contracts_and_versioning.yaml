rfc_contracts_and_versioning:
  schema_version: "2026-01-26"
  template_version: "2026-01-26"

  api_contracts:
    - contract_id: CTR-COMPILE-001
      name: "Factory Compile CLI Contract"
      description: "End-to-end compilation from PRD to tickets"
      interface: |
        apm2 factory compile --prd PRD-XXXX [--profile <routing_profile>] [--dry-run] [--allow-dirty]
        apm2 factory compile --rfc RFC-XXXX [--profile <routing_profile>] [--dry-run] [--allow-dirty]
      inputs:
        - name: "--prd PRD-XXXX"
          type: "Path to PRD directory"
          required: "One of --prd or --rfc required"
        - name: "--rfc RFC-XXXX"
          type: "Path to RFC directory"
          required: "One of --prd or --rfc required"
        - name: "--profile"
          type: "Routing profile name"
          required: false
          default: "local"
        - name: "--dry-run"
          type: "boolean"
          required: false
          default: "false"
        - name: "--allow-dirty"
          type: "boolean"
          required: false
          default: "false"
      outputs:
        - name: "CCP artifacts"
          path: "evidence/prd/<PRD-ID>/ccp/"
        - name: "Impact Map"
          path: "evidence/prd/<PRD-ID>/impact_map/"
        - name: "Run Manifest"
          path: "evidence/prd/<PRD-ID>/runs/<RUN_ID>/"
      exit_codes:
        - code: 0
          meaning: "Success"
        - code: 1
          meaning: "Schema validation error"
        - code: 2
          meaning: "Lint failure"
        - code: 3
          meaning: "Route unavailable"
        - code: 4
          meaning: "Parse failure"
        - code: 5
          meaning: "IO error"
        - code: 10
          meaning: "Internal error"

    - contract_id: CTR-CCP-001
      name: "CCP Build CLI Contract"
      description: "Generate Codebase Context Pack"
      interface: |
        apm2 factory ccp build --prd PRD-XXXX [--cache-dir <path>]
      inputs:
        - name: "--prd PRD-XXXX"
          type: "PRD identifier"
          required: true
        - name: "--cache-dir"
          type: "Cache directory path"
          required: false
      outputs:
        - name: "component_atlas.yaml"
          description: "Component inventory with stable IDs"
        - name: "crate_graph.json"
          description: "Workspace crate dependencies"
        - name: "public_api_inventory.yaml"
          description: "Public API entrypoints"
        - name: "prior_decisions_index.yaml"
          description: "Existing RFC/PRD references"
        - name: "ccp_index.json"
          description: "Index with content hashes"

    - contract_id: CTR-IMPACT-001
      name: "Impact Map Build CLI Contract"
      description: "Map requirements to codebase components"
      interface: |
        apm2 factory impact-map build --prd PRD-XXXX
      inputs:
        - name: "--prd PRD-XXXX"
          type: "PRD identifier"
          required: true
      outputs:
        - name: "impact_map.yaml"
          path: "evidence/prd/<PRD-ID>/impact_map/impact_map.yaml"

    - contract_id: CTR-RFC-001
      name: "RFC Frame CLI Contract"
      description: "Generate RFC skeleton from Impact Map"
      interface: |
        apm2 factory rfc frame --prd PRD-XXXX --rfc RFC-XXXX
      inputs:
        - name: "--prd PRD-XXXX"
          type: "Source PRD identifier"
          required: true
        - name: "--rfc RFC-XXXX"
          type: "Target RFC identifier"
          required: true
      outputs:
        - name: "RFC documents"
          path: "documents/rfcs/<RFC-ID>/"
          files:
            - "00_meta.yaml"
            - "01_problem_and_imports.yaml"
            - "02_design_decisions.yaml"
            - "03_trust_boundaries.yaml"
            - "04_contracts_and_versioning.yaml"
            - "05_rollout_and_ops.yaml"
            - "06_ticket_decomposition.yaml"
            - "07_test_and_evidence.yaml"
            - "08_risks_and_open_questions.yaml"
            - "09_governance_and_gates.yaml"

    - contract_id: CTR-TICKETS-001
      name: "Ticket Emit CLI Contract"
      description: "Generate tickets from RFC decomposition"
      interface: |
        apm2 factory tickets emit --rfc RFC-XXXX
      inputs:
        - name: "--rfc RFC-XXXX"
          type: "Source RFC identifier"
          required: true
      outputs:
        - name: "Ticket files"
          path: "documents/work/tickets/TCK-XXXXX.yaml"

  versioning_strategy:
    schema_versioning: |
      All YAML artifacts include schema_version and template_version fields.
      Schema versions follow YYYY-MM-DD format for governance documents.
      Breaking changes require new schema version and migration tooling.

    artifact_versioning: |
      CCP artifacts are content-addressed via BLAKE3 hashes in ccp_index.json.
      Run manifests include artifact hashes for reproducibility verification.

    backwards_compatibility: |
      The compiler supports reading older schema versions but always writes current version.
      Migration is handled by promote command when moving from evidence/ to documents/.

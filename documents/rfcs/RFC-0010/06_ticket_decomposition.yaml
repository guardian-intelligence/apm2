rfc_ticket_decomposition:
  schema_version: "2026-01-26"
  template_version: "2026-01-26"

  decomposition_strategy: |
    Tickets are organized by rollout phase. Each phase builds on previous phases.
    Tickets within a phase have explicit dependencies to enable parallel execution
    where possible. All tickets reference CCP component IDs and file paths.

  tickets:
    # Phase 1: Core Infrastructure
    - ticket_id: TCK-00110
      title: "Implement determinism module with YAML canonicalization"
      phase: PHASE-1
      requirement_ids:
        - REQ-0008
      description: |
        Create crates/apm2-core/src/determinism/ with:
        - canonicalize.rs: YAML canonicalization (sorted keys, 2-space indent)
        - atomic_write.rs: Atomic file writes (temp -> fsync -> rename)
        - diff_classify.rs: Classify diffs as structural vs free-text
      ccp_component: COMP-CORE
      files_to_create:
        - crates/apm2-core/src/determinism/mod.rs
        - crates/apm2-core/src/determinism/canonicalize.rs
        - crates/apm2-core/src/determinism/atomic_write.rs
        - crates/apm2-core/src/determinism/diff_classify.rs
      files_to_modify:
        - crates/apm2-core/src/lib.rs
      verification_commands:
        - "cargo test -p apm2-core determinism"
        - "cargo clippy -p apm2-core -- -D warnings"
      acceptance_criteria:
        - "canonicalize_yaml produces identical output for semantically identical input"
        - "write_atomic never produces partial files on interruption"
        - "diff_classify correctly categorizes structural vs free-text changes"
      blocked_by: []

    - ticket_id: TCK-00111
      title: "Implement CCP component atlas generation"
      phase: PHASE-1
      requirement_ids:
        - REQ-0002
      description: |
        Create crates/apm2-core/src/ccp/component_atlas.rs to:
        - Parse AGENTS.md files from crate directories
        - Extract invariants, contracts, and extension points
        - Generate stable component IDs based on crate name
      ccp_component: COMP-CORE
      files_to_create:
        - crates/apm2-core/src/ccp/mod.rs
        - crates/apm2-core/src/ccp/component_atlas.rs
      verification_commands:
        - "cargo test -p apm2-core ccp::component_atlas"
      acceptance_criteria:
        - "Component IDs are stable across runs"
        - "AGENTS.md invariants are correctly extracted"
        - "Components without AGENTS.md get placeholder entries"
      blocked_by:
        - TCK-00110

    - ticket_id: TCK-00112
      title: "Implement CCP crate graph generation"
      phase: PHASE-1
      requirement_ids:
        - REQ-0002
      description: |
        Create crates/apm2-core/src/ccp/crate_graph.rs to:
        - Invoke cargo metadata --format-version 1
        - Parse output into deterministic crate graph
        - Include dependency edges with version constraints
      ccp_component: COMP-CORE
      files_to_create:
        - crates/apm2-core/src/ccp/crate_graph.rs
      verification_commands:
        - "cargo test -p apm2-core ccp::crate_graph"
      acceptance_criteria:
        - "Crate graph matches cargo metadata output structure"
        - "Output is deterministic (stable key ordering)"
      blocked_by:
        - TCK-00110

    - ticket_id: TCK-00113
      title: "Implement CCP index and CLI command"
      phase: PHASE-1
      requirement_ids:
        - REQ-0001
        - REQ-0002
      description: |
        Create crates/apm2-core/src/ccp/index.rs and CLI command:
        - Generate CCP index with content hashes (BLAKE3)
        - CLI: apm2 factory ccp build --prd PRD-XXXX
      ccp_component: COMP-CLI
      extension_point: EXT-CLI-001
      files_to_create:
        - crates/apm2-core/src/ccp/index.rs
        - crates/apm2-cli/src/commands/factory/ccp.rs
      files_to_modify:
        - crates/apm2-cli/src/main.rs
        - crates/apm2-cli/src/commands/factory.rs
      verification_commands:
        - "cargo run --bin apm2 -- factory ccp build --help"
        - "cargo test -p apm2-core ccp::index"
      acceptance_criteria:
        - "CLI command produces CCP index at evidence/prd/<PRD-ID>/ccp/"
        - "Content hashes validate correctly"
        - "Incremental rebuild skips unchanged artifacts"
      blocked_by:
        - TCK-00111
        - TCK-00112

    # Phase 2: Impact Mapping and RFC Framing
    - ticket_id: TCK-00114
      title: "Implement Impact Map generation"
      phase: PHASE-2
      requirement_ids:
        - REQ-0003
      description: |
        Create crates/apm2-core/src/impact_map/ to:
        - Parse PRD requirements from requirements/*.yaml
        - Map requirements to CCP components
        - Identify duplication risks when multiple extension points viable
        - Classify net-new substrate
      ccp_component: COMP-CORE
      files_to_create:
        - crates/apm2-core/src/impact_map/mod.rs
        - crates/apm2-core/src/impact_map/mapper.rs
        - crates/apm2-core/src/impact_map/adjudication.rs
        - crates/apm2-core/src/impact_map/output.rs
        - crates/apm2-cli/src/commands/factory/impact_map.rs
      files_to_modify:
        - crates/apm2-core/src/lib.rs
        - crates/apm2-cli/src/main.rs
      verification_commands:
        - "cargo run --bin apm2 -- factory impact-map build --prd PRD-0005"
        - "cargo test -p apm2-core impact_map"
      acceptance_criteria:
        - "All requirements mapped or classified as net-new"
        - "Duplication risks identified and flagged"
        - "Output is deterministic YAML"
      blocked_by:
        - TCK-00113

    - ticket_id: TCK-00115
      title: "Implement RFC framer with CCP grounding"
      phase: PHASE-2
      requirement_ids:
        - REQ-0004
      description: |
        Create crates/apm2-core/src/rfc_framer/ to:
        - Generate RFC skeleton from Impact Map + CCP
        - Include CCP grounding section with component references
        - Validate all path references against CCP (fail on invalid)
      ccp_component: COMP-CORE
      files_to_create:
        - crates/apm2-core/src/rfc_framer/mod.rs
        - crates/apm2-core/src/rfc_framer/framer.rs
        - crates/apm2-core/src/rfc_framer/grounding.rs
        - crates/apm2-cli/src/commands/factory/rfc.rs
      files_to_modify:
        - crates/apm2-core/src/lib.rs
        - crates/apm2-cli/src/main.rs
      verification_commands:
        - "cargo run --bin apm2 -- factory rfc frame --prd PRD-0005 --rfc RFC-0011"
        - "cargo test -p apm2-core rfc_framer"
      acceptance_criteria:
        - "RFC includes CCP grounding section with index hash"
        - "Invalid path references fail compilation"
        - "RFC sections follow template structure"
      blocked_by:
        - TCK-00114

    # Phase 3: Ticket Emission and Lint
    - ticket_id: TCK-00116
      title: "Implement ticket emitter"
      phase: PHASE-3
      requirement_ids:
        - REQ-0006
      description: |
        Create crates/apm2-core/src/ticket_emitter/ to:
        - Decompose RFC into atomic tickets based on 06_ticket_decomposition.yaml
        - Validate file paths against CCP
        - Generate verification commands from acceptance criteria
      ccp_component: COMP-CORE
      files_to_create:
        - crates/apm2-core/src/ticket_emitter/mod.rs
        - crates/apm2-core/src/ticket_emitter/emitter.rs
        - crates/apm2-core/src/ticket_emitter/validation.rs
        - crates/apm2-cli/src/commands/factory/tickets.rs
      files_to_modify:
        - crates/apm2-core/src/lib.rs
        - crates/apm2-cli/src/main.rs
      verification_commands:
        - "cargo run --bin apm2 -- factory tickets emit --rfc RFC-0010"
        - "cargo test -p apm2-core ticket_emitter"
      acceptance_criteria:
        - "Each ticket has stable ID (TCK-XXXXX format)"
        - "File paths validated against CCP"
        - "Verification commands present in all tickets"
      blocked_by:
        - TCK-00115

    - ticket_id: TCK-00117
      title: "Add lint rules for clutter prevention"
      phase: PHASE-3
      requirement_ids:
        - REQ-0005
      description: |
        Add new lint rules to LINT_SPEC.yaml:
        - LINT-0013: no-new-module-without-justification
        - LINT-0014: cousin-abstraction-detector
        - LINT-0015: deletion-migration-plan-required
        Implement corresponding checks in xtask/src/tasks/lint.rs
      ccp_component: COMP-XTASK
      extension_point: EXT-XTASK-LINT
      files_to_modify:
        - documents/standards/lint/LINT_SPEC.yaml
        - xtask/src/tasks/lint.rs
      verification_commands:
        - "cargo xtask lint"
      acceptance_criteria:
        - "LINT-0013 fails if new module lacks justification in RFC"
        - "LINT-0014 warns on cousin abstractions (heuristic match)"
        - "LINT-0015 fails if new surface lacks deletion plan"
      blocked_by:
        - TCK-00116

    # Phase 4: Model Routing and Manifests
    - ticket_id: TCK-00118
      title: "Implement model router with routing profiles"
      phase: PHASE-4
      requirement_ids:
        - REQ-0007
      description: |
        Create crates/apm2-core/src/model_router/ to:
        - Parse routing profile YAML (documents/standards/routing_profiles/*.yaml)
        - Route stages to providers based on profile
        - Support canary comparison between two routes
      ccp_component: COMP-CORE
      files_to_create:
        - crates/apm2-core/src/model_router/mod.rs
        - crates/apm2-core/src/model_router/router.rs
        - crates/apm2-core/src/model_router/profile.rs
        - crates/apm2-core/src/model_router/canary.rs
        - documents/standards/schemas/routing_profile.schema.yaml
        - documents/standards/routing_profiles/local.yaml
      files_to_modify:
        - crates/apm2-core/src/lib.rs
      verification_commands:
        - "cargo test -p apm2-core model_router"
      acceptance_criteria:
        - "Routing profiles parsed correctly"
        - "Canary mode compares two routes and emits diff"
        - "Unavailable provider fails closed"
      blocked_by:
        - TCK-00117

    - ticket_id: TCK-00119
      title: "Implement run manifest with signing"
      phase: PHASE-4
      requirement_ids:
        - REQ-0009
        - REQ-0012
      description: |
        Create crates/apm2-core/src/run_manifest/ to:
        - Create run manifests with input/output hashes
        - Sign manifests with Ed25519 (reuse crypto module)
        - Include stage timings and routing decisions
      ccp_component: COMP-CORE
      files_to_create:
        - crates/apm2-core/src/run_manifest/mod.rs
        - crates/apm2-core/src/run_manifest/manifest.rs
        - crates/apm2-core/src/run_manifest/signer.rs
      files_to_modify:
        - crates/apm2-core/src/lib.rs
      verification_commands:
        - "cargo test -p apm2-core run_manifest"
      acceptance_criteria:
        - "Manifests include all required fields (lease_id, hashes, routing)"
        - "Signatures verify correctly using existing crypto module"
        - "Manifest verification fails on hash mismatch"
      blocked_by:
        - TCK-00118

    - ticket_id: TCK-00120
      title: "Implement end-to-end compile command"
      phase: PHASE-4
      requirement_ids:
        - REQ-0001
      description: |
        Implement apm2 factory compile --prd <PRD-ID>:
        - Orchestrate all stages in order (CCP -> Impact Map -> RFC -> Tickets)
        - Support --dry-run and --profile flags
        - Emit NDJSON observability events
      ccp_component: COMP-CLI
      extension_point: EXT-CLI-001
      files_to_create:
        - crates/apm2-cli/src/commands/factory/compile.rs
      files_to_modify:
        - crates/apm2-cli/src/main.rs
        - crates/apm2-cli/src/commands/factory.rs
      verification_commands:
        - "cargo run --bin apm2 -- factory compile --prd PRD-0005 --dry-run"
      acceptance_criteria:
        - "End-to-end compilation works for PRD-0005"
        - "Dry-run reports intended writes without modifying files"
        - "NDJSON events emitted for each stage"
      blocked_by:
        - TCK-00119

    # Phase 5: Skills and Refactor Radar
    - ticket_id: TCK-00121
      title: "Update idea-compiler and rfc-council skills"
      phase: PHASE-5
      requirement_ids:
        - REQ-0010
      description: |
        Update skill files:
        - .claude/skills/idea-compiler/SKILL.md: Full invocation guide with CLI commands
        - .claude/skills/rfc-council/SKILL.md: Require CCP/Impact Map inputs
      ccp_component: COMP-SKILLS
      files_to_modify:
        - .claude/skills/idea-compiler/SKILL.md
        - .claude/skills/rfc-council/SKILL.md
      verification_commands:
        - "cargo xtask lint"
      acceptance_criteria:
        - "idea-compiler skill invokes apm2 factory compile correctly"
        - "rfc-council skill validates CCP/Impact Map exist before proceeding"
      blocked_by:
        - TCK-00120

    - ticket_id: TCK-00122
      title: "Implement Refactor Radar stage"
      phase: PHASE-5
      requirement_ids:
        - REQ-0011
      description: |
        Create crates/apm2-core/src/refactor_radar/ to:
        - Aggregate CCP signals (hotspots, duplication heuristics)
        - Emit bounded recommendations (max items with prioritization)
        - Generate maintenance tickets
        - Implement circuit breaker for backlog management
      ccp_component: COMP-CORE
      files_to_create:
        - crates/apm2-core/src/refactor_radar/mod.rs
        - crates/apm2-core/src/refactor_radar/radar.rs
        - crates/apm2-core/src/refactor_radar/signals.rs
        - crates/apm2-cli/src/commands/factory/refactor.rs
      files_to_modify:
        - crates/apm2-core/src/lib.rs
        - crates/apm2-cli/src/main.rs
      verification_commands:
        - "cargo run --bin apm2 -- factory refactor radar --window 7d"
        - "cargo test -p apm2-core refactor_radar"
      acceptance_criteria:
        - "Radar output is bounded (configurable max items)"
        - "Recommendations include prioritization rationale"
        - "Circuit breaker suspends output when backlog exceeds threshold"
      blocked_by:
        - TCK-00120

  dependency_graph: |
    Level 0 (no dependencies):
      TCK-00110 (determinism)

    Level 1 (depends on L0):
      TCK-00111 (component atlas) -> TCK-00110
      TCK-00112 (crate graph) -> TCK-00110

    Level 2 (depends on L1):
      TCK-00113 (CCP index + CLI) -> TCK-00111, TCK-00112

    Level 3 (depends on L2):
      TCK-00114 (impact map) -> TCK-00113

    Level 4 (depends on L3):
      TCK-00115 (RFC framer) -> TCK-00114

    Level 5 (depends on L4):
      TCK-00116 (ticket emitter) -> TCK-00115

    Level 6 (depends on L5):
      TCK-00117 (lint rules) -> TCK-00116

    Level 7 (depends on L6):
      TCK-00118 (model router) -> TCK-00117

    Level 8 (depends on L7):
      TCK-00119 (run manifest) -> TCK-00118

    Level 9 (depends on L8):
      TCK-00120 (compile command) -> TCK-00119

    Level 10 (depends on L9):
      TCK-00121 (skills update) -> TCK-00120
      TCK-00122 (refactor radar) -> TCK-00120

  summary:
    total_tickets: 13
    by_phase:
      PHASE-1: 4
      PHASE-2: 2
      PHASE-3: 2
      PHASE-4: 3
      PHASE-5: 2

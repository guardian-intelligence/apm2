rfc_trust_boundaries:
  schema_version: "2026-01-26"
  template_version: "2026-01-26"

  trust_model:
    overview: |
      The Idea Compiler operates within the local repository trust boundary.
      Model routing may invoke external LLM providers, which are treated as
      untrusted for structured output validation but trusted for content generation
      within the routing profile's constraints.

    boundaries:
      - boundary_id: TB-001
        name: "Local Repository"
        type: TRUSTED
        description: |
          The local repository checkout is the primary trust anchor.
          CCP artifacts are derived from the repository state and are trusted
          as the authoritative source of codebase truth.
        assets_protected:
          - "Source code (crates/, xtask/)"
          - "Governed documents (documents/rfcs/, documents/prds/)"
          - "Evidence artifacts (evidence/)"
        invariants:
          - "CCP is computed from clean working tree (or --allow-dirty with warning)"
          - "All writes use atomic replacement (temp -> fsync -> rename)"
          - "Run manifests capture repo state hash"

      - boundary_id: TB-002
        name: "Compiler CLI Process"
        type: TRUSTED
        description: |
          The apm2 factory compile process runs with user privileges.
          It has read access to the repository and write access to evidence/ and documents/.
        invariants:
          - "No ambient credentials passed to subprocesses"
          - "External tool invocations are explicit and recorded"
          - "Crash-only design: any failure leaves atomic state"

      - boundary_id: TB-003
        name: "Model Provider"
        type: UNTRUSTED_INPUT
        description: |
          External LLM providers are used for Impact Map generation, RFC framing,
          and ticket decomposition. Their outputs are structured and validated.
        validation_requirements:
          - "All LLM outputs must conform to expected JSON/YAML schemas"
          - "Free-text fields are bounded and classified for diff purposes"
          - "Provider unavailability fails closed (no silent fallback)"
          - "Routing decisions are recorded in run manifest"

      - boundary_id: TB-004
        name: "Run Manifest"
        type: AUDIT_TRAIL
        description: |
          Run manifests provide tamper-evident records of compilation runs.
          They are signed with Ed25519 keys and store input/output hashes.
        invariants:
          - "Manifest verification fails if any hash mismatches"
          - "Signatures use keys from local keystore (dev) or daemon-issued (prod)"
          - "Manifests are stored in evidence/prd/<PRD-ID>/runs/<RUN_ID>/"

  threat_model:
    - threat_id: TH-001
      description: "Malicious LLM output injects code or modifies critical files"
      mitigation: |
        Compiler writes only to evidence/ during compile; documents/ writes require
        explicit promote step with manifest verification. All outputs are schema-validated.
      residual_risk: LOW

    - threat_id: TH-002
      description: "Cousin abstraction introduced without detection"
      mitigation: |
        LINT-0014 (cousin abstraction detector) runs during ticket emit.
        Impact map requires explicit justification for net-new modules.
        GATE-FACTORY-NEW-SURFACE fails closed without justification.
      residual_risk: LOW

    - threat_id: TH-003
      description: "Non-deterministic outputs cause merge conflicts or silent drift"
      mitigation: |
        Determinism module enforces canonical YAML output and atomic writes.
        Re-runs produce byte-identical artifacts or require explicit diff acceptance.
      residual_risk: MEDIUM (free-text fields may vary)

    - threat_id: TH-004
      description: "Provider unavailability causes incomplete compilation"
      mitigation: |
        Routing profile requires explicit fallback configuration.
        Default behavior is fail-closed. Partial runs leave evidence but don't promote.
      residual_risk: LOW

  security_contacts:
    - role: AUTH_SECURITY
      responsibilities:
        - "Review trust boundary definitions"
        - "Approve routing profile schemas"
        - "Audit run manifest signing implementation"

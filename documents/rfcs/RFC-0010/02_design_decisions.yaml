rfc_design_decisions:
  schema_version: "2026-01-26"
  template_version: "2026-01-26"

  design_space_exploration:
    prd_ref: "documents/prds/PRD-0005/04_solution_overview.yaml#prd_solution_overview.design_space_exploration"
    options:
      - option_id: OPT-A
        name: "Monolithic CLI-only compiler"
        description: |
          Implement the entire pipeline inside the apm2 CLI as pure local transforms.
          LLM calls are invoked by ProcessRunner where needed; no daemon integration required.
        evaluation:
          strengths:
            - "Lowest coupling and easiest local iteration"
            - "Naturally idempotent with filesystem-based caching; minimal moving parts"
          weaknesses:
            - "Weaker central enforcement: harder to share caches and attest execution across machines"
            - "Harder to gate/lease across multiple concurrent compiler runs without shared state"

      - option_id: OPT-B
        name: "Daemon-resident compiler service"
        description: |
          Implement pipeline stages as daemon services, with CLI as a thin client.
          The daemon provides leases, auth, caching, and consistent run manifests.
        evaluation:
          strengths:
            - "Strongest enforcement of auth/leases and consistent provenance"
            - "Naturally supports shared caches and future multi-node federation"
          weaknesses:
            - "Higher operational overhead; slows iteration if daemon lifecycle is heavy"
            - "Tighter coupling between spec compilation and runtime availability"

      - option_id: OPT-C
        name: "Declarative pipeline spec + pluggable stage runtime"
        description: |
          Define a PipelineSpec IR (YAML) describing stages, inputs, outputs, routing, and completion predicates.
          Implement a stage runtime in the CLI that can execute stages locally or via daemon in the future.
        evaluation:
          strengths:
            - "Maximal flexibility: stages are explicit, versioned, and composable"
            - "Enables controlled evolution and partial runs; supports multi-model routing per stage"
          weaknesses:
            - "Requires careful IR design to preserve determinism and simplicity"

    selected_approach:
      choice: OPT-C
      rationale: |
        PRD-0005 specifies that compiler stages should execute as bounded holonic episodes.
        OPT-C best supports this by making stages explicit, versioned, and independently executable.
        It captures the strengths of CLI-first iteration while avoiding a monolithic, implicit workflow.
        It also creates a clean seam for later daemon-backed execution and federation.

  architecture_decisions:
    - decision_id: AD-001
      title: "New modules in apm2-core for compiler stages"
      description: |
        Create dedicated modules in apm2-core for each compiler stage:
        ccp/, impact_map/, rfc_framer/, ticket_emitter/, model_router/, determinism/, refactor_radar/, run_manifest/
      rationale: |
        Placing compiler infrastructure in apm2-core allows reuse by both CLI and daemon.
        Module boundaries match CCP grounding from impact map.
      impact_map_ref: "evidence/prd/PRD-0005/impact_map/impact_map.yaml#impact_map.summary.net_new_modules"

    - decision_id: AD-002
      title: "CLI extension via FactoryCommands enum"
      description: |
        Extend the existing FactoryCommands enum (EXT-CLI-001) with new subcommands rather than
        creating a separate binary or entry point.
      rationale: |
        Impact map identifies EXT-CLI-001 as the natural extension point with high fit score.
        This avoids introducing new user-facing surfaces while keeping compile, ccp, impact-map,
        rfc, tickets commands discoverable under apm2 factory.
      ccp_ref: "evidence/prd/PRD-0005/ccp/component_atlas.yaml#component_atlas.components[0].extension_points[0]"

    - decision_id: AD-003
      title: "Lint rules in LINT_SPEC.yaml with xtask implementation"
      description: |
        Add new lint rules (LINT-0013, LINT-0014, LINT-0015) to documents/standards/lint/LINT_SPEC.yaml
        and implement corresponding checks in xtask/src/tasks/lint.rs.
      rationale: |
        Impact map identifies EXT-XTASK-LINT as the extension point for lint rules.
        This follows the existing pattern rather than introducing a new lint framework.
      ccp_ref: "evidence/prd/PRD-0005/ccp/component_atlas.yaml#component_atlas.components[4].modules[0].extension_points[0]"

    - decision_id: AD-004
      title: "Reuse existing lease, crypto, ledger infrastructure"
      description: |
        CompilationLease will be a variant in the existing lease module.
        Run manifest signing will use existing crypto module.
        Run history will be stored in existing ledger.
      rationale: |
        Impact map identifies existing modules for REQ-0009 implementation.
        This prevents cousin abstractions and leverages proven infrastructure.
      impact_map_ref: "evidence/prd/PRD-0005/impact_map/impact_map.yaml#impact_map.requirement_mappings[8]"

    - decision_id: AD-005
      title: "Determinism module for cross-cutting canonicalization"
      description: |
        Create a dedicated determinism module for YAML canonicalization, atomic writes,
        and diff classification. All compiler stages will depend on this module.
      rationale: |
        Determinism is a cross-cutting concern that affects all stages.
        Centralizing it prevents inconsistent implementations and enables uniform testing.
      net_new_justification: |
        No existing determinism infrastructure exists. This is net-new but essential for
        REQ-0008 compliance. The module is well-scoped with clear boundaries.

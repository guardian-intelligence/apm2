# Security Policy

## Security Modes

APM2 operates in two security modes depending on context:

### MODE_HIGH_ASSURANCE (Default for Releases)

All security gates MUST pass. No exceptions.

- All CI security gates must pass before merge
- All releases must be signed with Sigstore
- All releases must include SLSA L3 provenance
- All dependencies must pass audit checks

### MODE_DEVELOPER (Local Development)

Warnings are logged but don't block work.

- Clippy warnings displayed but don't fail build
- Dependency advisories shown as warnings
- Pre-commit hooks provide feedback without blocking

To enable developer mode locally:

```bash
export APM2_SECURITY_MODE=developer
```

## Security Invariants

These MUST hold at all times. Violations are considered security incidents.

### Release Integrity

1. **All releases MUST be signed with Sigstore**
   - Keyless signing via GitHub Actions OIDC
   - Signatures stored alongside artifacts (`.sig` files)
   - Certificates stored alongside artifacts (`.pem` files)

2. **All releases MUST include SLSA L3 provenance**
   - Generated by slsa-github-generator
   - Attached to GitHub releases
   - Proves artifacts came from this repository

3. **All releases MUST include SBOMs**
   - Generated by syft
   - CycloneDX and SPDX formats
   - Lists all dependencies and versions

### Code Quality

4. **All PRs MUST pass security gates**
   - Clippy with `-D warnings`
   - cargo-deny (licenses, advisories, bans)
   - gitleaks (secret scanning)
   - cargo-audit (vulnerability database)

5. **All dependencies MUST be audited**
   - No known vulnerabilities (RustSec)
   - Approved licenses only
   - No banned crates (openssl, etc.)

### Secret Protection

6. **Secrets MUST NOT appear in logs**
   - All log output must pass through redaction filter
   - API keys, tokens, and credentials are masked
   - Environment variables with sensitive names are never logged

7. **Secrets MUST NOT appear in artifacts**
   - Release artifacts scanned before publishing
   - SBOM does not contain credential values
   - Error messages sanitized

8. **Credentials MUST use secure storage**
   - OS keyring for user credentials
   - GitHub Actions secrets for CI
   - No plaintext credential files

## Vulnerability Handling

### Severity Levels

| Level | Response Time | Action |
|-------|---------------|--------|
| Critical | 24 hours | Immediate patch release |
| High | 7 days | Next patch release |
| Medium | 30 days | Next minor release |
| Low | 90 days | Next minor release |

### Disclosure Policy

1. Security issues should be reported via GitHub Security Advisories
2. We aim to acknowledge reports within 48 hours
3. We coordinate disclosure timeline with reporters
4. Public disclosure after patch is available

## Compliance Verification

Run these commands to verify security compliance:

```bash
# Check all security gates
cargo clippy --all-targets -- -D warnings
cargo deny check
cargo audit
gitleaks detect

# Verify a release
cosign verify-blob \
  --certificate <artifact>.pem \
  --signature <artifact>.sig \
  --certificate-identity-regexp "https://github.com/.*/apm2/.*" \
  --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
  <artifact>
```

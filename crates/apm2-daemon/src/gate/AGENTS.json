{
  "schema": "apm2.agents_context.v1",
  "module": "crates/apm2-daemon/src/gate",
  "behaviors": [
    {
      "id": "BEH-DAEMON-GATE-001",
      "kind": "invariant",
      "title": "PolicyResolvedForChangeSet emitted before any GateLeaseIssued for same work_id",
      "rfc": ["RFC-0015", "RFC-0019"]
    },
    {
      "id": "BEH-DAEMON-GATE-002",
      "kind": "invariant",
      "title": "Maximum concurrent orchestrations bounded to MAX_CONCURRENT_ORCHESTRATIONS",
      "rfc": ["RFC-0015"]
    },
    {
      "id": "BEH-DAEMON-GATE-003",
      "kind": "invariant",
      "title": "Maximum gate types per orchestration bounded to MAX_GATE_TYPES (8)",
      "rfc": ["RFC-0015"]
    },
    {
      "id": "BEH-DAEMON-GATE-004",
      "kind": "safety",
      "title": "Expired gate leases produce FAIL verdict (fail-closed timeouts)",
      "rfc": ["RFC-0015", "RFC-0019"]
    },
    {
      "id": "BEH-DAEMON-GATE-005",
      "kind": "invariant",
      "title": "Changeset digest in each lease matches authoritative ChangeSetPublished digest",
      "rfc": ["RFC-0015"]
    },
    {
      "id": "BEH-DAEMON-GATE-006",
      "kind": "invariant",
      "title": "Gate start entrypoint is start_for_changeset, not session-termination",
      "rfc": ["RFC-0015", "RFC-0019"]
    },
    {
      "id": "BEH-DAEMON-GATE-007",
      "kind": "invariant",
      "title": "Idempotency key is (work_id, changeset_digest) -- pure function of inputs",
      "rfc": ["RFC-0015"]
    },
    {
      "id": "BEH-DAEMON-GATE-008",
      "kind": "invariant",
      "title": "One-active-per-work_id: latest changeset supersedes old orchestration",
      "rfc": ["RFC-0015"]
    },
    {
      "id": "BEH-DAEMON-GATE-009",
      "kind": "safety",
      "title": "Event payloads enforce MAX_PAYLOAD_BYTES (1 MiB) before deserialization",
      "rfc": ["RFC-0015"]
    },
    {
      "id": "BEH-DAEMON-GATE-010",
      "kind": "safety",
      "title": "publisher_actor_id derived from verified actor_id column, not payload content",
      "rfc": ["RFC-0019"]
    },
    {
      "id": "BEH-DAEMON-GATE-011",
      "kind": "invariant",
      "title": "Policy hash from gate receipts verified against PolicyResolvedForChangeSet anchor",
      "rfc": ["RFC-0015"]
    },
    {
      "id": "BEH-DAEMON-GATE-012",
      "kind": "invariant",
      "title": "MergeReceipt atomically binds inputs to observed result (new commit SHA)",
      "rfc": ["RFC-0015"]
    },
    {
      "id": "BEH-DAEMON-GATE-013",
      "kind": "invariant",
      "title": "Gate receipt IDs sorted before inclusion in MergeReceipt for determinism",
      "rfc": ["RFC-0015"]
    },
    {
      "id": "BEH-DAEMON-GATE-014",
      "kind": "safety",
      "title": "Merge conflicts produce ReviewBlockedRecorded events, not silent failure",
      "rfc": ["RFC-0015"]
    },
    {
      "id": "BEH-DAEMON-GATE-015",
      "kind": "invariant",
      "title": "Pending merges bounded to MAX_PENDING_MERGES (1,000)",
      "rfc": ["RFC-0015"]
    },
    {
      "id": "BEH-DAEMON-GATE-016",
      "kind": "safety",
      "title": "Malformed-row resilience: parse errors advance cursor, not deadlock",
      "rfc": ["RFC-0019"]
    },
    {
      "id": "BEH-DAEMON-GATE-017",
      "kind": "invariant",
      "title": "SqliteTimeoutLedgerReader.poll_async delegates to poll_events_async via spawn_blocking (INV-CQ-OK-003)",
      "rfc": ["RFC-0020"]
    },
    {
      "id": "BEH-DAEMON-GATE-018",
      "kind": "safety",
      "title": "GateTimeoutIntent uses #[serde(deny_unknown_fields)] to reject unexpected fields",
      "rfc": ["RFC-0020"]
    },
    {
      "id": "BEH-DAEMON-GATE-019",
      "kind": "safety",
      "title": "parse_gate_lease_payload validates payload size and calls GateLease::validate() after deserialization",
      "rfc": ["RFC-0020"]
    },
    {
      "id": "BEH-DAEMON-GATE-020",
      "kind": "invariant",
      "title": "GateStart ledger tailing delegates to shared ledger_poll (no bespoke canonical+legacy merge)",
      "description": "SqliteGateStartLedgerReader MUST call crates/apm2-daemon/src/ledger_poll.rs (`poll_events_async`/`poll_events_blocking`) for cursor-safe canonical+legacy reads. Hand-rolled merge SQL in gate-start is forbidden.",
      "rfc": ["RFC-0020", "RFC-0032"]
    },
    {
      "id": "BEH-DAEMON-GATE-021",
      "kind": "invariant",
      "title": "GateStart durable cursor/intent/effect state uses orchestrator_runtime shared tables",
      "description": "GateStartKernel stores cursor, intent buffer, and effect journal via orchestrator_runtime adapters keyed by orchestrator_id `gate_start_kernel` (tables: orchestrator_kernel_cursors, orchestrator_kernel_intents, orchestrator_kernel_effect_journal).",
      "rfc": ["RFC-0020", "RFC-0032"]
    },
    {
      "id": "BEH-DAEMON-GATE-022",
      "kind": "safety",
      "title": "GateStart legacy storage migration is one-time, idempotent, and fail-closed",
      "description": "Legacy gate-start artifacts (`gate_start_kernel_cursor`, `gate_start_intents`, `gate_start_effect_journal.sqlite`) are migrated into shared orchestrator_runtime tables only when the target namespace is empty. Legacy effect states `started/unknown` map to `unknown` to preserve fail-closed semantics.",
      "rfc": ["RFC-0020", "RFC-0032"]
    }
  ]
}

schema_version: "1.0.0"
rfc_id: RFC-0019
review_timestamp: "2026-02-04T12:00:00Z"
review_type: "v2_GROUNDING"
review_depth: COUNCIL
previous_review: "rfc_review_v0_remediated_20260204T035500Z.yaml"

exploration_summary:
  mode_61_hermeneutic: "Intent reconstruction from existing code patterns"
  mode_40_mechanistic: "Causal trace of existing component mechanisms"
  mode_14_anti_cousin: "Verified no >70% structural duplication"

codebase_evidence:
  - evidence_id: "EVID-GROUND-001"
    decision_id: "DEC-0001"
    title: "SessionDispatcher builder pattern exists"
    source_refs:
      - "crates/apm2-daemon/src/protocol/session_dispatch.rs:419"
      - "crates/apm2-daemon/src/protocol/session_dispatch.rs:514-541"
    finding: |
      SessionDispatcher already has builder methods: with_decode_config (line 419),
      with_manifest_store (line 440), with_ledger (line 514), with_cas (line 521),
      with_broker (line 531), with_clock (line 541). The proposed with_full_context
      is a convenience wrapper that combines these, not a new pattern.
    anti_cousin_status: "EXTENDS_EXISTING"

  - evidence_id: "EVID-GROUND-002"
    decision_id: "DEC-0002"
    title: "Tool result CAS storage exists but hash not propagated"
    source_refs:
      - "crates/apm2-daemon/src/episode/executor.rs:482-483"
      - "crates/apm2-daemon/src/episode/executor.rs:562-567"
    finding: |
      Executor stores ToolResultData to CAS via store_result_data() at line 562-567.
      Hash is computed at line 482 but NOT propagated to ToolResult.
      ToolResult struct has no field for result_data_hash.
      ToolLogIndex is a NET-NEW artifact type with no existing equivalent.
    anti_cousin_status: "NET_NEW"

  - evidence_id: "EVID-GROUND-003"
    decision_id: "DEC-0003"
    title: "WorkspaceManager exists with stubbed apply"
    source_refs:
      - "crates/apm2-daemon/src/episode/workspace.rs:740-755"
      - "crates/apm2-daemon/src/episode/workspace.rs:337-381"
    finding: |
      WorkspaceManager::apply() at line 740-755 is stubbed: "In production, this
      would actually apply the diff". Validation exists via validate_path() at
      lines 337-381 (6 layers: empty check, traversal, absolute, depth, containment).
      RFC-0019 completes the stubbed implementation, not a cousin.
    anti_cousin_status: "COMPLETES_STUB"

  - evidence_id: "EVID-GROUND-004"
    decision_id: "DEC-0004"
    title: "Projection idempotency cache exists in SQLite"
    source_refs:
      - "crates/apm2-daemon/src/projection/github_sync.rs:484-618"
      - "crates/apm2-daemon/src/projection/projection_receipt.rs:214-238"
    finding: |
      IdempotencyCache is SQLite-backed (lines 484-518) with unique constraint on
      (work_id, changeset_digest, ledger_head). ProjectionReceipt exists with
      cryptographic signing (lines 214-238). RFC-0019 integrates this with ledger
      via ProjectionReceiptRecorded event.
    anti_cousin_status: "INTEGRATES_EXISTING"

  - evidence_id: "EVID-GROUND-005"
    decision_id: "DEC-0005"
    title: "ManifestStore and capability validation exist"
    source_refs:
      - "crates/apm2-daemon/src/episode/capability.rs:1173-1179"
      - "crates/apm2-daemon/src/protocol/session_dispatch.rs:967-1006"
    finding: |
      ManifestStore trait exists; is_tool_allowed() at lines 1173-1179 enforces
      fail-closed semantics per TCK-00254. Legacy allow path at session_dispatch.rs
      lines 967-1006 uses manifest store. RFC-0019 extends to CAS-backed loading.
    anti_cousin_status: "EXTENDS_EXISTING"

  - evidence_id: "EVID-GROUND-006"
    decision_id: "DEC-0006"
    title: "LedgerEventEmitter trait and SqliteLedgerEventEmitter exist"
    source_refs:
      - "crates/apm2-daemon/src/protocol/dispatch.rs:177-223"
      - "crates/apm2-daemon/src/ledger.rs:32-70"
    finding: |
      LedgerEventEmitter trait defined at dispatch.rs:177 with emit_work_claimed,
      emit_session_started methods. SqliteLedgerEventEmitter implements this at
      ledger.rs:32-70 with SQLite persistence and Ed25519 signing. RFC-0019 uses
      this existing infrastructure for episode event streaming.
    anti_cousin_status: "USES_EXISTING"

  - evidence_id: "EVID-GROUND-007"
    decision_id: "DEC-0007"
    title: "xtask authority reduction is policy, not code structure"
    source_refs: []
    finding: |
      DEC-0007 is a staged rollout policy using CLI flags. No existing code
      duplication concern. This is an operational change, not architectural.
    anti_cousin_status: "POLICY_NOT_CODE"

open_questions_resolution:
  - question_id: "Q-0001"
    question: "ToolLogIndex metadata scope"
    resolution: |
      Codebase investigation shows ToolResultData already captures: success, output,
      error_output, exit_code, budget_consumed (tokens, tool_calls, wall_ms, cpu_ms,
      bytes_io), duration, and optional ResultMetadata (file_size, http_status,
      tokens_consumed, content_type). ToolLogIndex should reference the full
      ToolResultData hash, which includes all this metadata. Decision: result
      hashes only for v0; index references full ToolResultData.
    status: "RESOLVED"

  - question_id: "Q-0002"
    question: "Workspace cleanup strategy"
    resolution: |
      Codebase shows WorkspaceManager::restore() is stubbed (line 762-765).
      No cleanup mechanism exists. Per RFC exploration, start with eager cleanup
      on episode completion. Lazy GC adds complexity without clear benefit for v0.
      Decision: eager cleanup in TCK-00318.
    status: "RESOLVED"

  - question_id: "Q-0003"
    question: "ProjectionReceiptRecorded content"
    resolution: |
      ReviewReceiptRecorded (apm2.kernel.v1.rs tag 33) includes: receipt_id,
      changeset_digest, artifact_bundle_hash, time_envelope_ref, reviewer_actor_id,
      reviewer_signature. ProjectionReceiptRecorded should follow same pattern:
      include minimal GitHub response (PR number, comment ID) for audit binding.
      Decision: include projection_receipt_hash (CAS), projected_status, and
      optional github_response_metadata (PR number, comment ID).
    status: "RESOLVED"

  - question_id: "Q-0004"
    question: "Projection receipt retention"
    resolution: |
      IdempotencyCache has TTL (7 days default) and max entries (100k) with LRU
      pruning. Ledger events are append-only and permanent. Decision: ledger
      events retained indefinitely; cache uses TTL. Compaction policy deferred
      to future RFC.
    status: "DEFERRED_POST_V0"

anti_cousin_verdict:
  status: "PASSED"
  summary: |
    All 7 design decisions verified against Codebase Common Patterns (CCP):
    - 2 EXTENDS_EXISTING (DEC-0001, DEC-0005)
    - 1 COMPLETES_STUB (DEC-0003)
    - 1 INTEGRATES_EXISTING (DEC-0004)
    - 1 USES_EXISTING (DEC-0006)
    - 1 NET_NEW (DEC-0002: ToolLogIndex)
    - 1 POLICY_NOT_CODE (DEC-0007)

    No >70% structural duplication detected. RFC-0019 design integrates with
    existing architecture rather than creating parallel systems.

verdict: "v2_GROUNDED"
verdict_reason: |
  RFC-0019 has completed v2 grounding phase:
  - Codebase investigation complete (5 code areas analyzed)
  - All design decisions have evidence-backed rationale
  - Anti-cousin verification passed (no structural duplication)
  - 3 of 4 open questions resolved; 1 deferred to post-v0

  RFC is ready to advance to v4 (Finalized) phase for ticket decomposition review.

# SA-3 (Security Guardian) - Security Assurance Case for RFC-0018 v4 Approval
# Holonic Event Fabric Phase 1 - FINALIZE Council Session
# Session Seed: 20260202
# Anchor Modes: [79] Adversarial Red-Team, [36] Assurance-Case
# Random Modes: [8] Counterexample-Guided, [65] Deontic, [55] Causal

schema_version: "1.0.0"
document_type: SECURITY_ASSURANCE_CASE
rfc_id: RFC-0018
review_timestamp: "2026-02-02T04:00:00Z"
assessor:
  agent_id: SA-3
  role: Security Guardian
  certification_level: v4_FINALIZE

# =============================================================================
# SECTION 1: GSN-STYLE ASSURANCE ARGUMENT TREE
# =============================================================================
assurance_argument_tree:
  notation: GSN  # Goal Structuring Notation

  top_claim:
    id: G-HEF-TOP
    type: GOAL
    statement: |
      RFC-0018 (Holonic Event Fabric Phase 1) satisfies all security requirements
      and preserves FAC trust invariants under adversarial conditions.
    context:
      - "C-HEF-001: Pulse Plane is non-authoritative (DD-HEF-0001)"
      - "C-HEF-002: Trust boundaries defined (operator.sock full access, session.sock deny-by-default)"
      - "C-HEF-003: Resource governance caps defined (DD-HEF-0005)"
      - "C-HEF-004: Anti-pattern AP-HEF-0008-001 prevents replay buffer drift"
    confidence: HIGH
    rationale: |
      All threat categories analyzed with defense-in-depth mitigations.
      CAE arguments constructed for each category with linked evidence.
      Watchlist items from v3 review addressed with explicit rebuttals.

  strategy:
    id: S-HEF-STRIDE
    type: STRATEGY
    statement: |
      Decompose security assurance by STRIDE threat category, addressing:
      (1) Spoofing - identity and authority claims
      (2) Tampering - data integrity attacks
      (3) Repudiation - audit trail gaps
      (4) Information Disclosure - unauthorized data exposure
      (5) Denial of Service - availability attacks
      (6) Elevation of Privilege - trust boundary violations
    decomposition_method: THREAT_CATEGORY
    coverage: COMPLETE

  # ---------------------------------------------------------------------------
  # THREAT CATEGORY 1: SPOOFING
  # ---------------------------------------------------------------------------
  spoofing_branch:
    goal:
      id: G-HEF-SPOOF
      type: GOAL
      statement: |
        RFC-0018 prevents spoofing of pulse authority, session identity,
        and ledger state references.
      confidence: HIGH
      parent: G-HEF-TOP

    sub_goals:
      - id: G-HEF-SPOOF-001
        type: GOAL
        statement: "Pulses cannot be forged to claim admission authority"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0001
            type: DESIGN_EVIDENCE
            description: |
              DD-HEF-0001 explicitly declares pulse plane non-authoritative.
              DD-HEF-0009 requires ledger verification before any admission.
            tests:
              - IT-HEF-0004 (pulse-only admission red-team)
            counterexamples_considered:
              - "Attacker injects pulse claiming gate passed"
              - "Consumer trusts pulse without ledger check"
            mitigation: |
              [DEONTIC] Consumers MUST verify via ledger+CAS (REQ-HEF-0001).
              [CAUSAL] Pulse->Consumer path has no admission effect without
              ledger verification in the causal chain.

      - id: G-HEF-SPOOF-002
        type: GOAL
        statement: "Sessions cannot publish pulses to impersonate daemon authority"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0002
            type: DESIGN_EVIDENCE
            description: |
              DD-HEF-0004 enforces daemon-only publish. TB-HEF-0002 defines
              publish boundary as ledger commit path only.
            tests:
              - IT-HEF-0005 (unauthorized publish attempts)
            counterexamples_considered:
              - "Session sends publish message on session.sock"
              - "Session exploits protocol framing to inject pulse"
            mitigation: |
              [DEONTIC] Sessions MUST NOT publish (DD-HEF-0004).
              Protocol dispatch rejects publish from session connections.

      - id: G-HEF-SPOOF-003
        type: GOAL
        statement: "Session tokens are validated before subscription"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0002
            type: DESIGN_EVIDENCE
            description: |
              TB-HEF-0001 requires session_token validation before any
              subscription. Dispatch path validates token first.
            tests:
              - IT-HEF-0001 (subscription ACL enforcement)
            counterexamples_considered:
              - "Attacker connects without token and subscribes"
              - "Attacker replays stale token"
            mitigation: |
              Token validation is mandatory entry gate. Stale tokens
              rejected by lease expiry checks.

  # ---------------------------------------------------------------------------
  # THREAT CATEGORY 2: TAMPERING
  # ---------------------------------------------------------------------------
  tampering_branch:
    goal:
      id: G-HEF-TAMPER
      type: GOAL
      statement: |
        RFC-0018 prevents tampering with ledger state, CAS artifacts,
        and pulse ordering semantics.
      confidence: HIGH
      parent: G-HEF-TOP

    sub_goals:
      - id: G-HEF-TAMPER-001
        type: GOAL
        statement: "Pulse payloads cannot alter ledger or CAS state"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0006
            type: DESIGN_EVIDENCE
            description: |
              DD-HEF-0007 outbox invariant: CAS persist -> ledger commit ->
              outbox enqueue -> pulse publish. Pulses are derived, not
              authoritative inputs.
            tests:
              - IT-HEF-0002 (outbox post-commit ordering)
            counterexamples_considered:
              - "Attacker modifies pulse to change ledger_cursor reference"
              - "Consumer uses pulse payload as ledger input"
            mitigation: |
              [CAUSAL] Pulses are terminal effects, not causal inputs to
              ledger. Consumers verify ledger directly.

      - id: G-HEF-TAMPER-002
        type: GOAL
        statement: "ChangeSetBundle integrity is cryptographically bound"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0009
            type: DESIGN_EVIDENCE
            description: |
              DD-HEF-0010 requires changeset_digest = BLAKE3-256 over
              canonical bundle bytes. Digest anchored by ledger event
              before any review.
            tests:
              - UT-HEF-FAC-0001 (canonicalization determinism)
              - IT-HEF-FAC-0001 (diff observability)
            counterexamples_considered:
              - "Attacker substitutes bundle after digest computation"
              - "Attacker provides non-canonical bundle with same digest"
            mitigation: |
              [CAUSAL] changeset_digest is immutable after ledger anchor.
              BLAKE3 collision resistance prevents substitution.

      - id: G-HEF-TAMPER-003
        type: GOAL
        statement: "Replay buffer remains ephemeral and non-authoritative"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0003
            type: DESIGN_EVIDENCE
            description: |
              AP-HEF-0008-001 explicitly documents anti-pattern preventing
              replay buffer evolution toward durable pubsub.
            tests:
              - Code review flag on disk I/O in pulse buffer
            counterexamples_considered:
              - "Implementer adds persistence to replay buffer"
              - "Replay buffer becomes source of ordering truth"
            mitigation: |
              [DEONTIC] Replay buffer MUST NOT be persisted or provide
              delivery guarantees (AP-HEF-0008-001 prevention clause).
              WATCH-RFC-0018-001 monitors for drift.

  # ---------------------------------------------------------------------------
  # THREAT CATEGORY 3: REPUDIATION
  # ---------------------------------------------------------------------------
  repudiation_branch:
    goal:
      id: G-HEF-REPUD
      type: GOAL
      statement: |
        RFC-0018 maintains auditability through ledger-anchored receipts
        and CAS-stored evidence bundles.
      confidence: HIGH
      parent: G-HEF-TOP

    sub_goals:
      - id: G-HEF-REPUD-001
        type: GOAL
        statement: "All FAC decisions are ledger-anchored with CAS references"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0010
            type: DESIGN_EVIDENCE
            description: |
              DD-HEF-0012 requires ReviewReceiptRecorded and
              ReviewBlockedRecorded as first-class ledger events with
              CAS hash references.
            tests:
              - IT-HEF-FAC-0002 (workspace snapshot/apply + ReviewBlocked)
              - IT-HEF-FAC-0003 (reviewer tools + CAS logs)
            counterexamples_considered:
              - "Review decision made without ledger event"
              - "Logs stored outside CAS without hash binding"
            mitigation: |
              [CAUSAL] Review output path: episode -> CAS artifact ->
              ledger event. No alternate path to admission exists.

      - id: G-HEF-REPUD-002
        type: GOAL
        statement: "Pulse delivery is auditable via ledger cursor correlation"
        confidence: MEDIUM
        rationale: |
          Pulses themselves are not audited individually, but ledger
          cursor references enable correlation with authoritative events.
        evidence:
          - id: EVID-HEF-0006
            type: DESIGN_EVIDENCE
            description: |
              PulseEnvelope includes ledger_cursor reference. Consumers
              can correlate pulses with ledger events for audit.

  # ---------------------------------------------------------------------------
  # THREAT CATEGORY 4: INFORMATION DISCLOSURE
  # ---------------------------------------------------------------------------
  disclosure_branch:
    goal:
      id: G-HEF-DISCL
      type: GOAL
      statement: |
        RFC-0018 minimizes information disclosure through payload bounds,
        CAS access gating, and deny-by-default subscription ACLs.
      confidence: HIGH
      parent: G-HEF-TOP

    sub_goals:
      - id: G-HEF-DISCL-001
        type: GOAL
        statement: "Pulse payloads contain only opaque IDs and hashes"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0001
            type: DESIGN_EVIDENCE
            description: |
              DD-HEF-0006 forbids file paths, tool arguments, diffs, or
              secrets in pulse payloads. REQ-HEF-0005 requires opaque
              IDs and hashes only.
            tests:
              - Schema review for PulseEnvelopeV1
            counterexamples_considered:
              - "Developer adds human-readable note field"
              - "Error message leaks file path in payload"
            mitigation: |
              [DEONTIC] No note field in Phase 1 (REQ-HEF-0005).
              Schema enforcement prevents unbounded fields.

      - id: G-HEF-DISCL-002
        type: GOAL
        statement: "CAS access requires explicit hash allowlists"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0002
            type: DESIGN_EVIDENCE
            description: |
              TB-HEF-0003 and TB-HEF-0005 define CAS access boundary.
              Pulses carry hashes but do not grant read access. Access
              requires capability manifest hash allowlist.
            tests:
              - IT-HEF-0005 (CAS hash allowlist denies unauthorized reads)
            counterexamples_considered:
              - "Session extracts CAS hash from pulse and reads directly"
              - "CAS facade bypassed via session_dispatch.rs"
            mitigation: |
              [DEONTIC] CAS reads MUST go through cas_access.rs facade.
              WATCH-RFC-0018-003 monitors for bypass routes.
              TCK-00314 adds CI lint for direct CAS API calls.

      - id: G-HEF-DISCL-003
        type: GOAL
        statement: "Session subscriptions are scoped to explicit topic allowlists"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0002
            type: DESIGN_EVIDENCE
            description: |
              DD-HEF-0004 and REQ-HEF-0003 enforce deny-by-default.
              Session.sock requires exact topic enumeration; wildcards
              forbidden in Phase 1.
            tests:
              - IT-HEF-0001 (subscription ACL enforcement)
              - IT-HEF-0005 (privileged topic access denied)
            counterexamples_considered:
              - "Session subscribes to work.*.events to enumerate work IDs"
              - "Session uses wildcard to subscribe to all gate topics"
            mitigation: |
              Phase 1 rejects all wildcard patterns from sessions.
              Exact topic enumeration required in capability manifest.

  # ---------------------------------------------------------------------------
  # THREAT CATEGORY 5: DENIAL OF SERVICE
  # ---------------------------------------------------------------------------
  dos_branch:
    goal:
      id: G-HEF-DOS
      type: GOAL
      statement: |
        RFC-0018 prevents denial of service through resource governance,
        bounded schema, and graceful degradation under backpressure.
      confidence: HIGH
      parent: G-HEF-TOP

    sub_goals:
      - id: G-HEF-DOS-001
        type: GOAL
        statement: "Subscription and pattern counts are bounded per connection"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0007
            type: DESIGN_EVIDENCE
            description: |
              DD-HEF-0005 resource_governance.limits:
              - max_subscriptions_per_connection: 16
              - max_patterns_per_subscription: 16
              - max_total_patterns_per_connection: 64
            tests:
              - IT-HEF-0003 (backpressure + drop policy)
            counterexamples_considered:
              - "Attacker creates 1000 subscriptions per connection"
              - "Attacker uses subscription explosion to exhaust memory"
            mitigation: |
              Limits enforced at subscribe time. Exceeding returns
              RESOURCE_LIMIT error without daemon crash.

      - id: G-HEF-DOS-002
        type: GOAL
        statement: "Pulse rates and queue depths are bounded per subscriber"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0007
            type: DESIGN_EVIDENCE
            description: |
              DD-HEF-0005 resource_governance.limits:
              - max_pulses_per_sec_per_subscriber: 100
              - max_burst_pulses_per_subscriber: 200
              - max_queue_depth_per_subscriber: 256
              - max_bytes_in_flight_per_subscriber: 1048576
            tests:
              - IT-HEF-0003 (rate-limit enforcement)
            counterexamples_considered:
              - "Slow consumer causes unbounded queue growth"
              - "Burst traffic exhausts daemon memory"
            mitigation: |
              Queue depth bounded at 256 per subscriber.
              Drop policy triggers before memory exhaustion.

      - id: G-HEF-DOS-003
        type: GOAL
        statement: "Topic grammar complexity is bounded to prevent regex DoS"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0007
            type: DESIGN_EVIDENCE
            description: |
              DD-HEF-0003 forbids regex. Wildcards limited to per-segment
              '*' and terminal '>'. Maximum 2 wildcards per pattern.
            tests:
              - UT-HEF-0001 (topic grammar parser)
            counterexamples_considered:
              - "Attacker submits regex-like pattern causing backtracking"
              - "Complex wildcard causes O(n^2) matching"
            mitigation: |
              [DEONTIC] Regex explicitly forbidden (DD-HEF-0003).
              WATCH-RFC-0018-002 monitors for grammar drift.

      - id: G-HEF-DOS-004
        type: GOAL
        statement: "Pulse payload size is strictly bounded"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0004
            type: DESIGN_EVIDENCE
            description: |
              max_pulse_payload_bytes: 2048 (DD-HEF-0005).
              PulseEnvelopeV1 decode rejects unknown fields (DD-HEF-0002).
            tests:
              - UT-HEF-0002 (bounded decode)
              - FZ-HEF-0001 (pulse frame fuzzing)
            counterexamples_considered:
              - "Attacker sends 1GB pulse payload"
              - "Allocation bomb via repeated nested fields"
            mitigation: |
              Size checked before allocation. Unknown fields rejected.
              Fuzz testing validates resilience.

  # ---------------------------------------------------------------------------
  # THREAT CATEGORY 6: ELEVATION OF PRIVILEGE
  # ---------------------------------------------------------------------------
  eop_branch:
    goal:
      id: G-HEF-EOP
      type: GOAL
      statement: |
        RFC-0018 preserves trust boundary separation between operator,
        session, and daemon principals with no privilege escalation paths.
      confidence: HIGH
      parent: G-HEF-TOP

    sub_goals:
      - id: G-HEF-EOP-001
        type: GOAL
        statement: "Session connections cannot escalate to operator privileges"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0002
            type: DESIGN_EVIDENCE
            description: |
              TB-HEF-0001 defines socket-based privilege separation.
              Session.sock has deny-by-default ACLs. Operator.sock
              requires separate socket access (filesystem permission).
            tests:
              - IT-HEF-0001 (subscription ACL enforcement)
            counterexamples_considered:
              - "Session sends operator-privileged command on session.sock"
              - "Session exploits protocol to switch socket context"
            mitigation: |
              Socket type determined at connection time. No in-band
              privilege upgrade mechanism exists.

      - id: G-HEF-EOP-002
        type: GOAL
        statement: "Capability manifests cannot grant beyond policy bounds"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0002
            type: DESIGN_EVIDENCE
            description: |
              DD-HEF-0004 states capability manifests may grant only
              within policy (never broaden beyond policy).
            tests:
              - IT-HEF-0005 (capability restriction enforcement)
            counterexamples_considered:
              - "Manifest claims access to topics outside lease scope"
              - "Episode requests capability not in allowlist"
            mitigation: |
              Daemon validates manifest claims against policy at
              session creation time.

      - id: G-HEF-EOP-003
        type: GOAL
        statement: "External projections remain write-only (no authority reads)"
        confidence: HIGH
        evidence:
          - id: EVID-HEF-0001
            type: DESIGN_EVIDENCE
            description: |
              TB-HEF-0004 defines projection-only boundary. GitHub is
              write-only projection target. Pulses must not depend on
              external projection state.
            tests:
              - IT-HEF-FAC-0004 (autonomous run without GitHub reads)
            counterexamples_considered:
              - "Daemon reads GitHub status to determine admission"
              - "Reviewer episode fetches diff from GitHub"
            mitigation: |
              [DEONTIC] FAC v0 autonomy requires no GitHub reads for truth.
              RSK-HEF-0004 tracks legacy bypass surfaces (xtask).
              TCK-00309 routes direct GitHub writes through daemon.

# =============================================================================
# SECTION 2: WATCHLIST ITEM REBUTTALS
# =============================================================================
watchlist_rebuttals:
  - watchlist_id: WATCH-RFC-0018-001
    category: ABSTRACTION_DRIFT_RISK
    original_finding: |
      AP-HEF-0008-001 documents replay buffer drift anti-pattern.
      Monitor for disk I/O or acknowledgment logic in pulse buffer.
    rebuttal:
      status: MITIGATED
      confidence: HIGH
      mitigations:
        - type: DESIGN_CONSTRAINT
          description: |
            AP-HEF-0008-001 explicitly prohibits:
            (1) Disk persistence of replay buffer
            (2) Delivery acknowledgment semantics
            (3) Subscription state beyond connection lifetime
            (4) Use as ordering/content source of truth
            (5) Evolution toward message broker patterns
        - type: DETECTION_MECHANISM
          description: |
            Code review flag on disk I/O or ack logic in pulse buffer.
            Any such addition requires separate RFC with GATE-TCK-ANTI-COUSIN.
        - type: PREVENTION
          description: |
            Ledger catch-up via since_ledger_cursor is ONLY recovery mechanism.
            Replay buffer exists solely to reduce ledger query load during
            brief reconnects (target: <5 seconds buffered history).
      residual_risk: LOW
      evidence_refs:
        - DD-HEF-0008
        - AP-HEF-0008-001

  - watchlist_id: WATCH-RFC-0018-002
    category: ABSTRACTION_DRIFT_RISK
    original_finding: |
      Topic grammar must maintain bounded complexity. Monitor for regex
      or complex wildcard evolution.
    rebuttal:
      status: MITIGATED
      confidence: HIGH
      mitigations:
        - type: DESIGN_CONSTRAINT
          description: |
            DD-HEF-0003 explicitly forbids regex and empty segments.
            Wildcards limited to per-segment '*' and terminal '>'.
            Maximum 2 wildcards per pattern.
        - type: DETECTION_MECHANISM
          description: |
            PR review flag on regex or unbounded wildcard matching.
        - type: TESTING
          description: |
            UT-HEF-0001 validates grammar bounds.
            UT-HEF-0003 audits for placeholder patterns.
      residual_risk: LOW
      evidence_refs:
        - DD-HEF-0003
        - REQ-HEF-0007

  - watchlist_id: WATCH-RFC-0018-003
    category: ABSTRACTION_DRIFT_RISK
    original_finding: |
      cas_access.rs must remain sole entry point for session CAS reads.
      Monitor for bypass routes in session_dispatch.rs or consume.rs.
    rebuttal:
      status: MITIGATED
      confidence: HIGH
      mitigations:
        - type: ARCHITECTURAL_CONSTRAINT
          description: |
            TCK-00314 explicitly specifies cas_access.rs as sole facade
            for session CAS reads. Module placement documented.
        - type: DETECTION_MECHANISM
          description: |
            CI lint for direct CAS API calls in session context.
            TCK-00314 acceptance criteria explicitly forbid bypass.
        - type: RECOMMENDATION_IMPLEMENTED
          description: |
            Add grep-based CI check: Flag any direct CAS API calls
            outside cas_access.rs module in session-related code paths.
      residual_risk: LOW
      evidence_refs:
        - TB-HEF-0005
        - TCK-00314

# =============================================================================
# SECTION 3: CONFIDENCE CERTIFICATION BY BRANCH
# =============================================================================
confidence_certification:
  overall_confidence: HIGH
  certification_statement: |
    All security branches achieve HIGH confidence with defense-in-depth
    mitigations. Residual risks are documented and monitored via watchlist.

  by_branch:
    - branch_id: G-HEF-SPOOF
      category: SPOOFING
      confidence: HIGH
      rationale: |
        Non-authoritative pulse design (DD-HEF-0001) fundamentally prevents
        spoofing attacks. Daemon-only publish and session token validation
        provide defense-in-depth. Red-team tests (IT-HEF-0004, IT-HEF-0005)
        validate fail-closed behavior.
      evidence_coverage: COMPLETE
      test_coverage: HIGH

    - branch_id: G-HEF-TAMPER
      category: TAMPERING
      confidence: HIGH
      rationale: |
        Outbox invariant (DD-HEF-0007) ensures pulses are derived effects,
        not causal inputs. BLAKE3 cryptographic binding for ChangeSetBundle
        prevents substitution attacks. Anti-pattern AP-HEF-0008-001 prevents
        replay buffer authority drift.
      evidence_coverage: COMPLETE
      test_coverage: HIGH

    - branch_id: G-HEF-REPUD
      category: REPUDIATION
      confidence: HIGH
      rationale: |
        All FAC decisions are ledger-anchored with CAS references.
        ReviewReceiptRecorded and ReviewBlockedRecorded provide durable
        audit trail. Pulse-level auditing is correlation-based (MEDIUM
        for individual pulses, HIGH for aggregate).
      evidence_coverage: COMPLETE
      test_coverage: HIGH

    - branch_id: G-HEF-DISCL
      category: INFORMATION_DISCLOSURE
      confidence: HIGH
      rationale: |
        Payload minimization (DD-HEF-0006), CAS access gating (TB-HEF-0003),
        and deny-by-default ACLs (DD-HEF-0004) provide layered protection.
        No human-readable fields in Phase 1. Watchlist monitors for bypass.
      evidence_coverage: COMPLETE
      test_coverage: HIGH

    - branch_id: G-HEF-DOS
      category: DENIAL_OF_SERVICE
      confidence: HIGH
      rationale: |
        Comprehensive resource governance (DD-HEF-0005) with explicit
        numeric bounds. Topic grammar complexity bounded (DD-HEF-0003).
        Fuzz testing validates decode path resilience. Graceful degradation
        via drop policy.
      evidence_coverage: COMPLETE
      test_coverage: HIGH

    - branch_id: G-HEF-EOP
      category: ELEVATION_OF_PRIVILEGE
      confidence: HIGH
      rationale: |
        Socket-based privilege separation (TB-HEF-0001) prevents in-band
        escalation. Capability manifest validation prevents policy bypass.
        Projection-only posture (TB-HEF-0004) prevents authority leakage.
      evidence_coverage: COMPLETE
      test_coverage: HIGH

# =============================================================================
# SECTION 4: OPEN QUESTION SECURITY IMPLICATIONS
# =============================================================================
open_question_security_assessment:
  - question_id: Q-HEF-0002
    question: |
      Should DefectRecord be embedded directly in ledger events or stored
      in CAS with hash reference?
    decision_needed_by: "2026-02-15"
    security_implications:
      option_a_embed:
        pros:
          - "Simpler implementation; single data path"
          - "Atomic with ledger commit"
        cons:
          - "Potential disclosure of sensitive diagnostic info"
          - "Unbounded size risk if defect payloads grow"
          - "Cannot redact after ledger commit"
        security_risk: MEDIUM
        deontic_assessment: |
          [DEONTIC] If embedding, DefectRecord MUST be bounded and
          MUST NOT contain file paths, secrets, or PII.
      option_b_cas_ref:
        pros:
          - "CAS access gating applies to defect content"
          - "Size bounded by CAS storage policy"
          - "Redaction possible via CAS access policy"
        cons:
          - "Two-phase write (CAS then ledger)"
          - "Correlation complexity"
        security_risk: LOW
        deontic_assessment: |
          [DEONTIC] CAS reference pattern aligns with existing FAC
          artifact model. SHOULD prefer this option.
    recommendation: |
      PREFER OPTION B (CAS reference) to minimize disclosure risk and
      align with DD-HEF-0006 information disclosure minimization.
      Resolve before TCK-00307 implementation (per OBS-RFC-0018-002).
    causal_analysis: |
      [CAUSAL] DefectRecord -> Ledger -> Consumer path must not expose
      sensitive diagnostics. CAS indirection adds access control in
      the causal chain.

  - question_id: Q-HEF-0003
    question: |
      Do we require a small in-memory pulse replay buffer for short
      reconnects, or force pure ledger catch-up?
    decision_needed_by: "2026-02-20"
    security_implications:
      option_a_replay_buffer:
        pros:
          - "Reduced ledger query load during brief reconnects"
          - "Better UX for transient disconnects"
        cons:
          - "Risk of authority drift (AP-HEF-0008-001)"
          - "Memory consumption during backpressure"
          - "Complexity in buffer management"
        security_risk: MEDIUM
        deontic_assessment: |
          [DEONTIC] If implemented, replay buffer MUST NOT be persisted,
          MUST NOT provide delivery guarantees, and MUST be bounded
          per AP-HEF-0008-001.
      option_b_pure_ledger:
        pros:
          - "Simpler implementation"
          - "No authority drift risk"
          - "Ledger is single source of truth"
        cons:
          - "Higher ledger query load on reconnect"
          - "Slightly worse UX for brief disconnects"
        security_risk: LOW
        deontic_assessment: |
          [DEONTIC] Pure ledger catch-up preserves authority invariants
          with no additional constraints.
    recommendation: |
      Either option is acceptable from security perspective.
      If Option A, enforce AP-HEF-0008-001 constraints strictly.
      WATCH-RFC-0018-001 monitors for drift.
    causal_analysis: |
      [CAUSAL] Both options terminate in ledger verification.
      Replay buffer is optimization in catch-up path, not
      alternative authority source.

  - question_id: Q-HEF-0004
    question: |
      Should ReviewReceiptRecorded be a new kernel event, or should
      review success be represented via GateReceipt evidence bundles only?
    decision_needed_by: "2026-02-20"
    security_implications:
      option_a_new_event:
        pros:
          - "Explicit audit trail for review decisions"
          - "Clear separation of review and gate semantics"
          - "Easier correlation in ledger queries"
        cons:
          - "Schema churn; new event type"
          - "Migration complexity"
        security_risk: LOW
        deontic_assessment: |
          [DEONTIC] New event MUST reference CAS artifact bundle hash.
          Audit trail requirements favor explicit event.
      option_b_gate_only:
        pros:
          - "Simpler schema; reuses existing GateReceipt"
          - "Less migration"
        cons:
          - "Audit trail less explicit"
          - "Review vs gate semantics conflated"
        security_risk: LOW
        deontic_assessment: |
          [DEONTIC] If GateReceipt-only, evidence_bundle MUST include
          review artifacts with verifiable hashes.
    recommendation: |
      PREFER OPTION A (new ReviewReceiptRecorded event) for audit
      clarity and requirement fidelity (REQ-HEF-0011). Security
      risk is LOW for both options.
    causal_analysis: |
      [CAUSAL] Both options result in ledger-anchored evidence.
      Explicit event improves auditability without security cost.

  - question_id: Q-HEF-0005
    question: |
      Should changeset_digest remain embedded in ChangeSetBundle (Option A)
      or move to ledger event only (Option B)?
    decision_needed_by: "2026-02-22"
    security_implications:
      option_a_embedded:
        pros:
          - "Single canonical bundle witness"
          - "Aligns with CAS/EventHasher BLAKE3 hashing"
          - "Self-contained verification"
        cons:
          - "Redundancy if ledger also stores digest"
          - "Bundle size slightly larger"
        security_risk: LOW
        deontic_assessment: |
          [DEONTIC] Embedded digest MUST be computed over canonical
          bytes with digest field omitted (DD-HEF-0010).
      option_b_ledger_only:
        pros:
          - "No redundancy"
          - "Simpler bundle schema"
        cons:
          - "Requires ledger lookup for verification"
          - "Bundle alone insufficient for integrity check"
        security_risk: LOW
        deontic_assessment: |
          [DEONTIC] Ledger event MUST anchor digest before any
          review or gate decision.
    recommendation: |
      PREFER OPTION A (embedded) for v0 to enable self-contained
      verification aligned with DD-HEF-0010. Reconsider Option B
      only if ledger-only binding demonstrably simplifies validation.
    causal_analysis: |
      [CAUSAL] Both options result in cryptographic binding before
      review. Embedded option reduces verification dependency chain.

# =============================================================================
# SECTION 5: COUNTEREXAMPLE-GUIDED THREAT SCENARIOS
# =============================================================================
counterexample_scenarios:
  methodology: |
    [MODE 8: Counterexample-Guided] For each threat category, specific
    attack scenarios were constructed and evaluated against RFC-0018
    design decisions and mitigations.

  scenarios:
    - id: CEX-001
      category: SPOOFING
      scenario: |
        Adversary connects to session.sock without valid token and
        attempts to subscribe to all gate.*.*.* topics to monitor
        admission decisions.
      expected_outcome: ATTACK_PREVENTED
      mitigation_chain:
        - TB-HEF-0001 requires session_token validation first
        - DD-HEF-0004 forbids wildcards on session.sock
        - Even with valid token, deny-by-default ACL rejects
      verification: IT-HEF-0001, IT-HEF-0005

    - id: CEX-002
      category: TAMPERING
      scenario: |
        Adversary intercepts pulse, modifies ledger_cursor to point
        to future sequence, hoping consumer will skip events.
      expected_outcome: ATTACK_INEFFECTIVE
      mitigation_chain:
        - DD-HEF-0001 pulses are non-authoritative
        - DD-HEF-0009 consumers MUST verify via ledger
        - Consumer reads ledger from own cursor, not pulse reference
      verification: IT-HEF-0004

    - id: CEX-003
      category: INFORMATION_DISCLOSURE
      scenario: |
        Adversary gains session token and attempts to subscribe to
        episode.<other_episode_id>.io to intercept another session's
        tool outputs.
      expected_outcome: ATTACK_PREVENTED
      mitigation_chain:
        - DD-HEF-0004 session subscriptions require explicit allowlist
        - Capability manifest scopes to own episode_id only
        - Cross-session topic access denied by ACL check
      verification: IT-HEF-0001

    - id: CEX-004
      category: DENIAL_OF_SERVICE
      scenario: |
        Adversary creates legitimate connection and submits 10,000
        subscription requests to exhaust daemon memory.
      expected_outcome: ATTACK_MITIGATED
      mitigation_chain:
        - DD-HEF-0005 max_subscriptions_per_connection: 16
        - Request 17+ returns RESOURCE_LIMIT error
        - Daemon continues serving other connections
      verification: IT-HEF-0003

    - id: CEX-005
      category: ELEVATION_OF_PRIVILEGE
      scenario: |
        Adversary with session access crafts capability manifest
        claiming operator-level pulse subscription rights.
      expected_outcome: ATTACK_PREVENTED
      mitigation_chain:
        - DD-HEF-0004 manifests cannot grant beyond policy
        - Daemon validates claims against policy at session creation
        - Excessive claims rejected; session denied or scoped down
      verification: IT-HEF-0005

    - id: CEX-006
      category: TAMPERING
      scenario: |
        Malicious reviewer episode modifies ChangeSetBundle before
        applying, then claims review passed on modified code.
      expected_outcome: ATTACK_DETECTED
      mitigation_chain:
        - DD-HEF-0010 changeset_digest is BLAKE3 over canonical bytes
        - Digest anchored by ledger event before review
        - Modified bundle produces different hash; mismatch detected
      verification: UT-HEF-FAC-0001, IT-HEF-FAC-0001

# =============================================================================
# SECTION 6: DEONTIC OBLIGATION SUMMARY
# =============================================================================
deontic_obligations:
  methodology: |
    [MODE 65: Deontic] Security obligations derived from design decisions
    and requirements, expressed as MUST/MUST NOT/SHOULD constraints.

  obligations:
    - id: DEON-001
      obligation: MUST
      subject: Consumers
      statement: |
        Consumers MUST verify via ledger+CAS before acting on pulse hints.
      source: REQ-HEF-0001, DD-HEF-0001, DD-HEF-0009
      violation_consequence: |
        Admission bypass or spoofed gate outcomes (RSK-HEF-0002).

    - id: DEON-002
      obligation: MUST_NOT
      subject: Sessions
      statement: |
        Sessions MUST NOT publish pulse topics.
      source: DD-HEF-0004, REQ-HEF-0003
      violation_consequence: |
        Authority confusion; spoofed pulses could mislead consumers.

    - id: DEON-003
      obligation: MUST_NOT
      subject: Replay Buffer
      statement: |
        Replay buffer MUST NOT be persisted to disk or provide
        delivery acknowledgment semantics.
      source: AP-HEF-0008-001
      violation_consequence: |
        Evolution toward durable pubsub; authority leakage.

    - id: DEON-004
      obligation: MUST
      subject: Daemon
      statement: |
        Daemon MUST emit pulses only after ledger commit
        (CAS persist -> ledger commit -> outbox -> pulse).
      source: DD-HEF-0007, REQ-HEF-0006
      violation_consequence: |
        Pulses could reference non-existent ledger state.

    - id: DEON-005
      obligation: MUST
      subject: CAS Access
      statement: |
        CAS reads for FAC artifacts MUST require explicit hash allowlists
        in capability manifests.
      source: REQ-HEF-0005, TB-HEF-0005
      violation_consequence: |
        Unauthorized access to diff artifacts or review outputs.

    - id: DEON-006
      obligation: MUST_NOT
      subject: FAC Reviewers
      statement: |
        FAC reviewers MUST NOT depend on GitHub reads for truth.
      source: DD-HEF-0011, DD-HEF-0013
      violation_consequence: |
        Projection-only posture violated; external TOCTOU risk.

# =============================================================================
# SECTION 7: CAUSAL CHAIN ANALYSIS
# =============================================================================
causal_analysis:
  methodology: |
    [MODE 55: Causal] Security-relevant causal chains analyzed to ensure
    no unintended authority flows or side-channel effects.

  chains:
    - id: CAUSAL-001
      name: "Pulse Emission Chain"
      sequence:
        - step: 1
          action: "CAS persist artifact"
          authority: DAEMON
          verification: CAS hash binding
        - step: 2
          action: "Ledger commit event"
          authority: DAEMON
          verification: Ledger sequence + event hash
        - step: 3
          action: "Outbox enqueue"
          authority: DAEMON
          verification: Post-commit only
        - step: 4
          action: "Pulse publish to subscribers"
          authority: DAEMON
          verification: ACL filter per connection
      security_invariant: |
        Pulse emission is terminal effect in chain. No reverse flow
        from pulse to ledger or CAS is possible.

    - id: CAUSAL-002
      name: "Consumer Verification Chain"
      sequence:
        - step: 1
          action: "Receive pulse hint"
          authority: NONE
          verification: None (hint only)
        - step: 2
          action: "Read ledger from cursor"
          authority: LEDGER
          verification: Cursor + sequence validation
        - step: 3
          action: "Fetch CAS artifact by hash"
          authority: CAS_POLICY
          verification: Hash match + access policy
        - step: 4
          action: "Make decision"
          authority: LEDGER+CAS
          verification: Based on verified state only
      security_invariant: |
        Authority is derived from ledger+CAS, never from pulse alone.
        Pulse is wakeup trigger only.

    - id: CAUSAL-003
      name: "FAC Review Chain"
      sequence:
        - step: 1
          action: "ChangeSetPublished event"
          authority: LEDGER
          verification: changeset_digest anchored
        - step: 2
          action: "Reviewer episode spawned"
          authority: DAEMON
          verification: Capability manifest scoped
        - step: 3
          action: "ChangeSetBundle fetched from CAS"
          authority: CAS_POLICY
          verification: Hash allowlist check
        - step: 4
          action: "Workspace snapshot/apply"
          authority: EPISODE
          verification: Deterministic apply
        - step: 5
          action: "Review tools executed"
          authority: EPISODE
          verification: Minimal tool set (DD-HEF-0011)
        - step: 6
          action: "Review artifacts stored in CAS"
          authority: DAEMON
          verification: Hash binding
        - step: 7
          action: "ReviewReceiptRecorded/ReviewBlockedRecorded"
          authority: LEDGER
          verification: CAS hash reference
        - step: 8
          action: "GateReceipt (if passed)"
          authority: LEDGER
          verification: Evidence bundle hash
      security_invariant: |
        No GitHub reads in chain. All artifacts are CAS/ledger anchored.
        ReviewBlocked captures liveness failures.

# =============================================================================
# SECTION 8: FINAL CERTIFICATION
# =============================================================================
final_certification:
  verdict: APPROVED_FOR_V4
  confidence: HIGH

  summary: |
    RFC-0018 (Holonic Event Fabric Phase 1) satisfies all security
    requirements and preserves FAC trust invariants. The GSN-style
    assurance argument tree demonstrates:

    1. SPOOFING: Prevented by non-authoritative pulse design, daemon-only
       publish, and session token validation (HIGH confidence).

    2. TAMPERING: Prevented by outbox invariant, BLAKE3 cryptographic
       binding, and anti-pattern AP-HEF-0008-001 (HIGH confidence).

    3. REPUDIATION: Addressed by ledger-anchored receipts and CAS-stored
       evidence bundles (HIGH confidence).

    4. INFORMATION DISCLOSURE: Minimized by payload bounds, CAS access
       gating, and deny-by-default ACLs (HIGH confidence).

    5. DENIAL OF SERVICE: Mitigated by comprehensive resource governance,
       bounded grammar, and fuzz-tested decode paths (HIGH confidence).

    6. ELEVATION OF PRIVILEGE: Prevented by socket-based privilege
       separation and capability manifest validation (HIGH confidence).

    All three watchlist items (WATCH-RFC-0018-001/002/003) have been
    addressed with explicit rebuttals and monitoring mechanisms.

    Open questions Q-HEF-0002 through Q-HEF-0005 have been assessed for
    security implications with recommendations provided.

  conditions:
    - "Resolve Q-HEF-0002 before TCK-00307 (prefer CAS reference pattern)"
    - "Maintain WATCH-RFC-0018-001/002/003 monitoring during implementation"
    - "Implement CI lint for CAS access bypass detection (TCK-00314)"

  evidence_refs:
    - EVID-HEF-0001
    - EVID-HEF-0002
    - EVID-HEF-0003
    - EVID-HEF-0004
    - EVID-HEF-0005
    - EVID-HEF-0006
    - EVID-HEF-0007
    - EVID-HEF-0009
    - EVID-HEF-0010
    - EVID-HEF-0011
    - EVID-HEF-0012

  assessor_signature:
    agent_id: SA-3
    role: Security Guardian
    timestamp: "2026-02-02T04:00:00Z"
    anchor_modes: "[79] Adversarial Red-Team, [36] Assurance-Case"
    random_modes: "[8] Counterexample-Guided, [65] Deontic, [55] Causal"
